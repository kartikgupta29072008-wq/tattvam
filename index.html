<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tattvam - AI Assessment Suite</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    colors: {
                        tattvam: { 50: '#fdfbf7', 100: '#f7f3e8', 500: '#d4af37', 600: '#b08d26', 900: '#4a3b0f' }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/mhchem.min.js"></script>


    <style>
       @media print {
    @page { margin: 1cm; size: A4; }
    
    /* RESET THE SCROLL LOCKS */
    html, body, #root, .h-screen, .overflow-hidden, .overflow-auto, .overflow-y-auto {
        height: auto !important;
        overflow: visible !important;
        position: static !important;
    }

    /* Hide UI elements */
    .print-hidden { display: none !important; }
    
    /* Standardize text and layout */
    body { 
        background: white; 
        -webkit-print-color-adjust: exact; 
        color: black !important;
    }
    
    /* Ensure full width and no internal scrolling */
    .print-w-full { width: 100% !important; max-width: none !important; }
    .print-overflow-visible { overflow: visible !important; }
    .print-p-0 { padding: 0 !important; }
    
    /* Prevent questions from being split across pages */
    .break-inside-avoid { break-inside: avoid; page-break-inside: avoid; }
    
    /* Handle columns */
    .print-col-2 { column-count: 2; column-gap: 2rem; }
}
    </style>
</head>
<body class="bg-tattvam-50 text-slate-900 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
// --- ICONS (Updated with Eye & BarChart) ---
        const Icon = ({ name, className = "w-5 h-5", ...props }) => {
            const icons = {
                Plus: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
                Trash2: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
                Save: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                ArrowLeft: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
                ArrowUp: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m18 15-6-6-6 6"/></svg>,
                ArrowDown: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m6 9 6 6 6-6"/></svg>,
                AlertTriangle: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
                Upload: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
                Loader2: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
                Play: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
                CheckCircle2: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
                XCircle: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
                Edit2: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                FileText: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
                Atom: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
                Settings: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
                Printer: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
                BookOpen: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
                Sparkles: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></svg>,
                Lightbulb: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.25-2.25-4-5-4S8 5.75 8 8c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
                RefreshCw: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
                Image: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
                X: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
                Wand2: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><circle cx="20" cy="4" r="2"/><circle cx="17.5" cy="17.5" r="2.5"/><circle cx="6.5" cy="6.5" r="2.5"/></svg>,
                Search: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
                BrainCircuit: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.284"/><path d="M17.97 14.716A4 4 0 0 1 16 18"/></svg>,
                ListChecks: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>,
                Grid: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>,
                Clock: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                Flag: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>,
                ChevronRight: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m9 18 6-6-6-6"/></svg>,
                ChevronLeft: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m15 18-6-6 6-6"/></svg>,
                Download: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
                Clipboard: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
                Target: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
                BookMarked: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>,
                Eye: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
                BarChart: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
            };
            return icons[name] || null;
        };
      const LatexRenderer = ({ content, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!containerRef.current || !window.katex) return;
                
                // 1. Clean the text: Fix missing spaces after commands and double-escaped breaks
                let text = content || '';
                
                // 2. Split by Math Delimiters ($$ for block, $ for inline)
                const parts = text.split(/(\$\$[\s\S]*?\$\$|\$[\s\S]*?\$)/g);
                
                containerRef.current.innerHTML = '';
                
                parts.forEach(part => {
                    const span = document.createElement('span');
                    
                    if (part.startsWith('$$') && part.endsWith('$$')) {
                        // Display Mode (Block Math)
                        try { 
                            window.katex.render(part.slice(2, -2), span, { displayMode: true, throwOnError: false, trust: true }); 
                        } catch (e) { span.innerText = part; }
                    } 
                    else if (part.startsWith('$') && part.endsWith('$')) {
                        // Inline Mode
                        try { 
                            window.katex.render(part.slice(1, -1), span, { displayMode: false, throwOnError: false, trust: true }); 
                        } catch (e) { span.innerText = part; }
                    } 
                    else {
                        // Regular Text - Handle newlines cleanly
                        // We strictly replace \n with <br> to keep formatting
                        span.innerHTML = part.replace(/\n/g, '<br/>');
                    }
                    containerRef.current.appendChild(span);
                });
            }, [content]);
            
            return <div ref={containerRef} className={`latex-content leading-relaxed whitespace-pre-wrap ${className}`} />;
        };

        // --- UTILS ---
        const safeParseJSON = (text) => {
            try {
                let clean = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const start = clean.search(/[{[]/);
                const end = clean.lastIndexOf(/[}\]]/);
                if (start !== -1 && end !== -1 && end > start) clean = clean.substring(start, end + 1);
                return JSON.parse(clean);
            } catch (e) { throw new Error("Invalid AI response."); }
        };

        const fetchWithRetry = async (url, options, retries = 1) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error("API Error: " + response.statusText);
                return await response.json();
            } catch (err) {
                if (retries > 0) return fetchWithRetry(url, options, retries - 1);
                throw err;
            }
        };
// --- OFFICIAL EXAM UTILS: SUBMIT TO GOOGLE ---
// --- OFFICIAL EXAM UTILS: SUBMIT TO GOOGLE ---
const submitResultToGoogle = async (formData) => {
    // ðŸ”´ YOUR EXACT FORM ID
    const FORM_ID = "1FAIpQLSd_Kmp_8KRFWdcy5ZlEHpwS4QQvGXVe59VvgOk5torxSNyC1A";
    
    // ðŸ”´ YOUR EXACT ENTRY IDs (Extracted from your link)
    const MAPPING = {
        name: "entry.62457682",      // NAME_123
        testId: "entry.1900409645",  // ID_123
        score: "entry.840307252",    // SCORE_123
        data: "entry.20137862"       // DATA_123
    };

    const formUrl = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
    
    const params = new URLSearchParams();
    params.append(MAPPING.name, formData.studentName);
    params.append(MAPPING.testId, formData.testTitle);
    params.append(MAPPING.score, `${formData.score} / ${formData.maxMarks}`);
    
    // Convert the detailed analysis to a string so it fits in the paragraph box
    params.append(MAPPING.data, JSON.stringify(formData.details)); 

    try {
        await fetch(formUrl, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params
        });
        console.log("âœ… Data sent to Google successfully");
        return true;
    } catch (e) {
        console.error("âŒ Submission Error:", e);
        return false;
    }
};
        const PART_A = "ghp_";
const PART_B = "IlLAIU7EJTjx1nkrthwRUWyCBSsBdK0a1bqu";
const HARDCODED_GITHUB_TOKEN = PART_A + PART_B;
// --- BOSS FEATURE: GITHUB CLOUD UPLOAD ---
const uploadToGitHub = async (testData, token, filename) => {
    // ðŸ”´ REPLACE THESE TWO WITH YOUR EXACT DETAILS!
    const USERNAME = "kartikgupta29072008-wq"; 
    const REPO_NAME = "tattvam"; 
    
    // We assume your tests are inside the 'database' folder
    const FILE_PATH = `database/${filename}`; 
    const API_URL = `https://api.github.com/repos/${USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;

    try {
        // 1. Get current file info (we need the 'SHA' ID to update it)
        const getRes = await fetch(API_URL, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        // If file doesn't exist, we can't update it (safety check)
        if (!getRes.ok) throw new Error("File not found on GitHub or Invalid Token");
        const fileInfo = await getRes.json();
        
        // 2. Prepare content (Base64 Encode for GitHub)
        // We remove the 'isBossDraft' and 'isOfficial' flags before uploading
        const cleanData = { ...testData };
        delete cleanData.isBossDraft;
        delete cleanData.isOfficial; // It becomes official again when fetched
        
        const jsonString = JSON.stringify(cleanData, null, 2);
        // This complex encoding handles Emojis/Hindi characters correctly
        const encodedContent = btoa(unescape(encodeURIComponent(jsonString)));

        // 3. Send the Update (PUT request)
        const putRes = await fetch(API_URL, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "Boss Edit Hotfix via Tattvam",
                content: encodedContent,
                sha: fileInfo.sha // This ID proves we are overwriting the correct file
            })
        });

        if (putRes.ok) return true;
        else throw new Error("Upload failed. Check console.");

    } catch (e) {
        alert("Cloud Error: " + e.message);
        console.error(e);
        return false;
    }
};
        const fileToBase64 = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.replace('data:', '').replace(/^.+,/, ''));
        });

        const cropDiagram = (base64Image, box) => new Promise((resolve) => {
            if (!box || box.length !== 4) return resolve(null);
            const img = new window.Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const [ymin, xmin, ymax, xmax] = box;
                const width = img.width;
                const height = img.height;
                const realX = (xmin / 1000) * width;
                const realY = (ymin / 1000) * height;
                const realW = ((xmax - xmin) / 1000) * width;
                const realH = ((ymax - ymin) / 1000) * height;
                const pad = 10;
                const sx = Math.max(0, realX - pad);
                const sy = Math.max(0, realY - pad);
                const sw = Math.min(width - sx, realW + (pad*2));
                const sh = Math.min(height - sy, realH + (pad*2));
                canvas.width = sw;
                canvas.height = sh;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, sw, sh);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = "data:image/png;base64," + base64Image;
        });

// --- API CALLS (HYBRID: MANUAL + AUTO-ROTATION + ULTIMATE SAFETY BYPASS) ---
        const apiCall = async (keyContext, prompt, imageData = null) => {
            let keys = [];
            let startIndex = 0;

            if (typeof keyContext === 'object' && !Array.isArray(keyContext) && keyContext.keys) {
                keys = keyContext.keys;
                startIndex = keyContext.currentIndex || 0;
            } else if (Array.isArray(keyContext)) {
                keys = keyContext;
            } else {
                keys = [keyContext];
            }

            const orderedKeys = [
                ...keys.slice(startIndex),
                ...keys.slice(0, startIndex)
            ];

            let lastError = null;

            for (let i = 0; i < orderedKeys.length; i++) {
                const currentKey = orderedKeys[i];
                if (!currentKey || !currentKey.trim()) continue;

                try {
                    const body = {
                        contents: [{ 
                            parts: [
                                { text: prompt }, 
                                ...(imageData ? [{ inlineData: { mimeType: "image/png", data: imageData } }] : [])
                            ] 
                        }],
                        // --- FIX: ADDED CIVIC INTEGRITY & EXPLICIT BYPASS ---
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_CIVIC_INTEGRITY", threshold: "BLOCK_NONE" } 
                        ],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (response.status === 429) {
                        console.warn(`[Tattvam] Key ...${currentKey.slice(-4)} exhausted. Auto-switching...`);
                        throw new Error("QUOTA_EXHAUSTED");
                    }
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error("API Error: " + (errData.error?.message || response.statusText));
                    }
                    
                    const data = await response.json();
                    
                    // --- ENHANCED DEBUGGING FOR SAFETY BLOCKS ---
                    const candidate = data.candidates?.[0];
                    
                    if (!candidate) {
                        // Check for prompt-level blocking
                        if (data.promptFeedback?.blockReason) {
                            throw new Error(`Blocked by Safety Filter (Prompt). Reason: ${data.promptFeedback.blockReason}`);
                        }
                        throw new Error("AI returned no candidates.");
                    }

                    if (candidate.finishReason !== "STOP") {
                        // If it stopped for Safety or Recitation, tell the user!
                        if (candidate.finishReason === "SAFETY" || candidate.finishReason === "RECITATION") {
                             throw new Error(`Blocked by Filter. Reason: ${candidate.finishReason} (Try cropping the image to remove sensitive text)`);
                        }
                    }

                    const rawText = candidate.content?.parts?.[0]?.text;
                    if (!rawText) throw new Error("AI response was empty (Content Filtered).");

                    return safeParseJSON(rawText);

                } catch (err) {
                    lastError = err;
                    if (err.message === "QUOTA_EXHAUSTED" && i < orderedKeys.length - 1) {
                        continue; 
                    }
                    if (err.message !== "QUOTA_EXHAUSTED") throw err;
                }
            }
            throw new Error("All API Keys failed.\nLast Error: " + lastError?.message);
        };
        const generateMarksMapping = async (questions, userRule, apiKey) => {
            // We only send metadata to save tokens, not the full text
            const meta = questions.map(q => ({ id: q.id, type: q.type, difficulty: q.difficulty || 'Medium' }));
            
            const prompt = `Act as an Exam Controller.
            User Instruction: "${userRule}"
            
            Task: specific positive (pos) and negative (neg) marks for the following questions based on the user's instruction.
            
            Question Metadata: ${JSON.stringify(meta)}
            
            Rules:
            1. If the user mentions "JEE Main", use +4/-1 for everything.
            2. If "JEE Advanced", usually Multi=+4/-2, Single=+3/-1, Numerical=+3/0 (unless specified otherwise).
            3. If "NEET", use +4/-1.
            4. Interpret natural language (e.g., "Make hard questions 5 marks").
            
            Output strictly valid JSON mapping Question IDs to marks:
            {
                "0.123123": { "pos": 4, "neg": 1 },
                "0.456456": { "pos": 3, "neg": 0 }
            }`;

            return await apiCall(apiKey, prompt);
        };

        const analyzeResultImage = async (base64, apiKey) => {
            const prompt = `Analyze this result/scorecard image. Extract data strictly into JSON: 
            {
              "testName": "Exam Name/Heading",
              "score": Number (obtained marks),
              "maxMarks": Number (total marks),
              "rank": Number (if available, else null),
              "percentile": Number (if available, else null),
              "subjects": { "Physics": 50, "Math": 40 ... } (Map subject name to marks obtained)
            }`;
            return await apiCall(apiKey, prompt, base64);
        };

        const generateAnalysisInsights = async (history, apiKey) => {
            const prompt = `Act as an academic mentor. Analyze this student's performance history JSON. 
            History: ${JSON.stringify(history)}.
            Provide a deep analysis.
            Output JSON: {
              "summary": "Brief summary of performance trend.",
              "strengths": ["Strength 1", "Strength 2"],
              "weaknesses": ["Weakness 1", "Weakness 2"],
              "advice": "Specific actionable advice for improvement."
            }`;
            return await apiCall(apiKey, prompt);
        };

        const transcribeImage = async (base64, apiKey) => {
            const prompt = `Analyze this page. Identify exam questions. 
            Rules for Transcription:
            1. **MATH:** Use LaTeX for all math. Example: $x^2 + y^2$.
            2. **CHEMISTRY:** Use \\ce{...} for chemical formulas. Example: $\\ce{H2SO4}$, $\\ce{2H2 + O2 -> 2H2O}$.
            3. **ESCAPING:** You must escape backslashes in JSON strings. Use \\\\frac instead of \\frac.
            4. **Diagrams:** Detect if a specific diagram/graph exists for the question.
5. **MATRIX MATCH:** If a question has "Column I" and "Column II" (or List-I/List-II):
               - Set "type" to "MATRIX".
               - Extract "Column I" items into "matrix": { "rows": ["A text", "B text"] }.
               - Extract "Column II" items into "matrix": { "cols": ["P text", "Q text"] }.
               - Do NOT use "options" list.
               - "matrixAns" should map Row Index (0-based) to Array of Col Indices (0-based). Example: { "0": [0, 2], "1": [1] } means A->P,R and B->Q.
            
            Structure:
            For every question, output a JSON object:
            { 
              "text": "The question text...", 
              "type": "SINGLE" (or MULTI, NUMERICAL, MATRIX), 
              "options": ["Option A", "Option B"...], 
"matrix": { "rows": ["Row A", "Row B"], "cols": ["Col P", "Col Q"] },
              "matrixAns": { "0": [1], "1": [0] },
              "marks": {"pos":3, "neg":1}, 
              "difficulty": "Medium", 
              "diagram_box": [ymin, xmin, ymax, xmax] (0-1000 scale, TIGHT CROP, or null if no diagram)
            }`;
            
            const results = await apiCall(apiKey, prompt, base64);
            if (Array.isArray(results)) {
                for (let q of results) {
                    if (q.diagram_box) { 
                        q.diagram = await cropDiagram(base64, q.diagram_box); 
                        delete q.diagram_box; 
                    }
                    if(!q.marks) q.marks = { pos: 4, neg: 1 };
                    if(!q.type) q.type = 'SINGLE';
                }
            }
            return results;
        };

        const generateExplanation = async (q, k) => {
            // Note: We use apiCall here to benefit from rotation, instead of direct fetch
            const prompt = `Explain strictly and briefly: "${q.text}". Type: ${q.type}. Output JSON: { "explanation": "string" }`;
            const res = await apiCall(k, prompt);
            return res?.explanation || "Explanation not generated.";
        };

        const generateDistractors = async (q, k) => apiCall(k, `Q: "${q.text}". Generate 3 wrong options. JSON: ["A", "B", "C"]`);
        
        const generateRemix = async (q, k) => apiCall(k, `Remix this question. Q: "${q.text}". Output JSON: { "text": "New Q", "options": ["A","B","C","D"] }`);
        
        const generateGuide = async (qs, k) => {
            // Note: We use apiCall here to benefit from rotation
            const prompt = `Create a Study Guide for these questions:\n${qs.map(q=>q.text).join('\n')}. Output JSON: { "guide": "# Study Guide\\n..." }`;
            const res = await apiCall(k, prompt);
            return res?.guide || "Guide generation failed.";
        };

        const generateTemplateConfig = async (userPrompt, title, k) => {
            const prompt = `Act as an expert exam designer. Request: "${userPrompt}". Title: "${title}". Generate JSON: { "header": "String", "watermark": "String", "font": "serif/sans/mono", "twoCol": Boolean, "showMarks": Boolean, "instructions": "String" }`;
            return await apiCall(k, prompt);
        };

        // --- MANVANCHIT AI QUESTION GENERATOR ---
        const generateAIQuestions = async (topic, count, difficulty, type, depth, apiKey) => {
            const prompt = `Act as an expert academic question setter.
            Topic/Context: "${topic}"
            Depth Level: ${depth} (Focus on ${depth} understanding).
            Task: Generate ${count} distinct questions.
            Difficulty: ${difficulty}.
            Question Type: ${type} (If 'MIXED', use a variety of SINGLE, MULTI, NUMERICAL).
            
            Output a strictly valid JSON array of objects matching this schema:
            [{
              "text": "Question text (use LaTeX $...$ for math)",
              "type": "SINGLE" (or MULTI, NUMERICAL, MATRIX),
              "options": ["Option A", "Option B", "Option C", "Option D"] (required for SCQ/MCQ),
              "correctIndex": 0 (integer index for SCQ),
              "correctIndices": [0, 2] (array for MULTI),
              "correctNum": "10.5" (string for NUMERICAL),
              "matrix": { "rows": ["A","B"], "cols": ["P","Q"] } (for MATRIX),
              "matrixAns": { "0": [1], "1": [0] } (row index -> col indices),
              "marks": {"pos": 4, "neg": 1},
              "explanation": "Brief solution."
            }]`;
            
            return await apiCall(apiKey, prompt);
        };

        // --- SMART IMPORT (PASTE PARSER) ---
        const parsePastedText = async (rawText, apiKey) => {
            const prompt = `Parse this raw text into structured quiz questions.
            Raw Text: "${rawText}"
            Identify questions. For each, determine type (SINGLE, MULTI, NUMERICAL).
            Output JSON: [{ "text": "...", "type": "SINGLE", "options": ["A", "B"...], "correctIndex": 0, "correctNum": "5", "marks": {"pos": 4, "neg": 1} }]`;
            return await apiCall(apiKey, prompt);
        };

        // --- COMPONENTS ---
// --- NEW: Automatically fetches structure images from PubChem ---
        const AutoChemicalRenderer = ({ text }) => {
            const [imgUrl, setImgUrl] = useState(null);
            const [error, setError] = useState(false);

            useEffect(() => {
                // If text starts with CHEM: prefix, it's a trigger
                if (text && typeof text === 'string' && text.startsWith('CHEM:')) {
                    const chemicalName = text.replace('CHEM:', '').trim();
                    let url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(chemicalName)}/PNG?record_type=2d&image_size=large`;
                    
                    // Simple heuristic: If it contains non-alphabetic chars likely a SMILES code
                    if (chemicalName.match(/[^a-zA-Z\s\-]/)) { 
                         url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(chemicalName)}/PNG?record_type=2d&image_size=large`;
                    }
                    setImgUrl(url);
                    setError(false);
                } else {
                    setImgUrl(null);
                }
            }, [text]);

            if (imgUrl && !error) {
                return (
                    <div className="inline-block align-middle my-1 p-1 bg-white border border-slate-100 rounded-lg shadow-sm">
                        <img 
                            src={imgUrl} 
                            alt={text} 
                            onError={() => setError(true)} 
                            className="max-h-32 max-w-[200px] object-contain" 
                            title={text.replace('CHEM:', '')}
                        />
                    </div>
                );
            }
            
            // Fallback: Just render the text (stripping the CHEM: tag if it failed loading)
            return <LatexRenderer content={text ? text.replace('CHEM:', '') : ''} />;
        };
const SettingsVault = ({ context, setContext, notes, setNotes, onClose }) => {
            const [tab, setTab] = useState('keys');
            const [newKey, setNewKey] = useState('');
            const [tempNote, setTempNote] = useState(notes || '');

            const addKey = () => {
                if (newKey.trim()) {
                    setContext({ ...context, keys: [...context.keys, newKey.trim()] });
                    setNewKey('');
                }
            };

            const removeKey = (idx, e) => {
                e.stopPropagation();
                const updated = context.keys.filter((_, i) => i !== idx);
                // If we removed the active key, reset index to 0
                let newIdx = context.currentIndex;
                if (idx < newIdx) newIdx--;
                if (idx === newIdx) newIdx = 0;
                
                setContext({ keys: updated, currentIndex: newIdx });
            };

            const setActive = (idx) => {
                setContext({ ...context, currentIndex: idx });
            };

            const handleSaveNotes = () => {
                setNotes(tempNote);
                alert("Notes Saved!");
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4 animate-in zoom-in-95">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col h-[500px]">
                        <div className="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="Settings" /> Settings Vault</h3>
                            <button onClick={onClose}><Icon name="X" /></button>
                        </div>

                        <div className="flex border-b shrink-0">
                            <button onClick={() => setTab('keys')} className={`flex-1 py-3 text-sm font-bold ${tab === 'keys' ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50' : 'text-slate-500'}`}>API Keys</button>
                            <button onClick={() => setTab('notes')} className={`flex-1 py-3 text-sm font-bold ${tab === 'notes' ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50' : 'text-slate-500'}`}>Mini Notepad</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 bg-slate-50">
                            {tab === 'keys' ? (
                                <div className="space-y-4">
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-800 leading-relaxed">
                                        <strong className="block mb-1">Hybrid Mode Active:</strong>
                                        <ul className="list-disc pl-4 space-y-1">
                                            <li>The <span className="text-green-600 font-bold">Green Dot</span> shows the manually selected key.</li>
                                            <li>Tattvam will try this key <strong>first</strong>.</li>
                                            <li>If it fails (Limit Reached), it automatically tries the others.</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <input value={newKey} onChange={e => setNewKey(e.target.value)} placeholder="Paste Gemini API Key..." className="flex-1 p-2 border rounded-lg text-sm focus:border-indigo-500 outline-none" />
                                        <button onClick={addKey} disabled={!newKey} className="bg-indigo-600 text-white px-4 rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-50"><Icon name="Plus" /></button>
                                    </div>

                                    <div className="space-y-2">
                                        {context.keys.map((k, i) => {
                                            const isActive = i === (context.currentIndex || 0);
                                            return (
                                                <div 
                                                    key={i} 
                                                    onClick={() => setActive(i)}
                                                    className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${isActive ? 'bg-green-50 border-green-500 ring-1 ring-green-500 shadow-sm' : 'bg-white border-slate-200 hover:border-indigo-300'}`}
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-3 h-3 rounded-full ${isActive ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-slate-200'}`}></div>
                                                        <div className="flex flex-col">
                                                            <span className={`text-xs font-bold uppercase ${isActive ? 'text-green-700' : 'text-slate-400'}`}>
                                                                {isActive ? 'Active (Primary)' : `Backup #${i + 1}`}
                                                            </span>
                                                            <span className="font-mono text-sm text-slate-700">...{k.slice(-8)}</span>
                                                        </div>
                                                    </div>
                                                    <button onClick={(e) => removeKey(i, e)} className="text-slate-300 hover:text-red-500 p-2"><Icon name="Trash2" className="w-4 h-4" /></button>
                                                </div>
                                            );
                                        })}
                                        {context.keys.length === 0 && <div className="text-center text-slate-400 py-4 text-sm">No keys added.</div>}
                                    </div>
                                </div>
                            ) : (
                                <div className="h-full flex flex-col">
                                    <textarea value={tempNote} onChange={e => setTempNote(e.target.value)} className="flex-1 w-full p-3 border rounded-lg text-sm font-mono leading-relaxed focus:border-indigo-500 outline-none resize-none mb-3" placeholder="Notes..." />
                                    <button onClick={handleSaveNotes} className="bg-emerald-600 text-white py-2 rounded-lg font-bold hover:bg-emerald-700 shadow-sm flex items-center justify-center gap-2"><Icon name="Save" className="w-4 h-4" /> Save Notes</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const QuizSetupModal = ({ onClose, onStart }) => {
            const [mins, setMins] = useState(180);
            const [shuffle, setShuffle] = useState(false);
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                    <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-in zoom-in-95">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold">Exam Setup</h3><button onClick={onClose}><Icon name="X" className="text-slate-400" /></button></div>
                        <div className="space-y-4 mb-6">
                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Duration (Minutes)</label><input type="number" value={mins} onChange={e=>setMins(e.target.value)} className="w-full p-2 border rounded-lg" /></div>
                            <div className="flex items-center gap-2"><input type="checkbox" checked={shuffle} onChange={e=>setShuffle(e.target.checked)} className="w-4 h-4" /><span className="text-sm">Shuffle Questions</span></div>
                        </div>
                        <button onClick={() => onStart(mins, shuffle)} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700">Start Exam</button>
                    </div>
                </div>
            );
        };

        const StudyGuideModal = ({ content, onClose }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                <div className="bg-white rounded-2xl w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl animate-in zoom-in-95">
                    <div className="flex justify-between items-center p-6 border-b border-slate-100"><h3 className="text-xl font-bold text-tattvam-900 flex items-center gap-2"><Icon name="Sparkles" className="w-5 h-5 text-tattvam-600" /> AI Study Guide</h3><button onClick={onClose}><Icon name="X" className="w-5 h-5 text-slate-400 hover:text-red-500" /></button></div>
                    <div className="flex-1 overflow-y-auto p-8 bg-tattvam-50"><div className="prose max-w-none">{content.split('\n').map((line, i) => { if (line.startsWith('# ')) return <h1 key={i} className="text-2xl font-bold mb-4 mt-6 text-slate-900">{line.replace('# ', '')}</h1>; if (line.startsWith('## ')) return <h2 key={i} className="text-xl font-bold mb-3 mt-5 text-slate-800">{line.replace('## ', '')}</h2>; if (line.startsWith('- ')) return <li key={i} className="ml-4 list-disc mb-1"><LatexRenderer content={line.replace('- ', '')} /></li>; return <p key={i} className="mb-2 text-slate-700"><LatexRenderer content={line} /></p> })}</div></div>
                    <div className="p-4 border-t border-slate-100 flex justify-end"><button onClick={() => window.print()} className="flex items-center gap-2 text-slate-600 hover:text-tattvam-600 font-medium px-4"><Icon name="Printer" className="w-4 h-4" /> Print</button></div>
                </div>
            </div>
        );

        const ManvanchitModal = ({ onClose, onImport, apiKey }) => {
            const [mode, setMode] = useState('generator'); // 'generator' or 'paste'
            const [topic, setTopic] = useState('');
            const [count, setCount] = useState(5);
            const [difficulty, setDifficulty] = useState('Medium');
            const [type, setType] = useState('MIXED');
            const [depth, setDepth] = useState('Conceptual');
            const [generating, setGenerating] = useState(false);
            const [reviewList, setReviewList] = useState([]);
            const [step, setStep] = useState('input');
            const [editingId, setEditingId] = useState(null);
            
            const [rawText, setRawText] = useState('');
            const [parsing, setParsing] = useState(false);

            const handleGenerate = async () => {
                if(!topic.trim()) return alert("Please enter a topic or paste context.");
                setGenerating(true);
                try {
                    const qs = await generateAIQuestions(topic, count, difficulty, type, depth, apiKey);
                    const safeQs = Array.isArray(qs) ? qs.map(q => ({...q, id: Math.random()})) : [];
                    setReviewList(safeQs);
                    setStep('review');
                } catch(e) { alert("Generation failed: " + e.message); }
                setGenerating(false);
            };

            const handleSmartPaste = async () => {
                if(!rawText) return;
                setParsing(true);
                try {
                    const questions = await parsePastedText(rawText, apiKey);
                    const safeQs = Array.isArray(questions) ? questions.map(q => ({...q, id: Math.random()})) : [];
                    setReviewList(safeQs);
                    setStep('review');
                } catch(e) { alert("Parsing error: " + e.message); }
                setParsing(false);
            };

            const toggleQuestion = (id) => { setReviewList(prev => prev.map(q => q.id === id ? { ...q, selected: q.selected === false ? true : false } : q)); };
            const handleConfirm = () => { const final = reviewList.filter(q => q.selected !== false); onImport(final); onClose(); };
            const updateQuestionText = (id, newText) => { setReviewList(prev => prev.map(q => q.id === id ? { ...q, text: newText } : q)); };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-6">
                    <div className="bg-white w-full max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95">
                        <div className="bg-slate-900 p-4 flex justify-between items-center text-white">
                            <div className="flex items-center gap-2"><Icon name="BrainCircuit" className="w-5 h-5 text-tattvam-500" /><span className="font-bold text-lg">MANVANCHIT</span></div>
                            <button onClick={onClose} className="bg-red-500 hover:bg-red-600 p-1.5 rounded text-white transition-colors"><Icon name="X" className="w-5 h-5" /></button>
                        </div>

                        {/* Tabs */}
                        {step === 'input' && (
                            <div className="bg-slate-100 flex p-1 border-b">
                                <button onClick={() => setMode('generator')} className={`flex-1 py-2 text-sm font-bold rounded-t ${mode==='generator' ? 'bg-white text-tattvam-900 shadow-sm' : 'text-slate-500'}`}>AI Generator</button>
                                <button onClick={() => setMode('paste')} className={`flex-1 py-2 text-sm font-bold rounded-t ${mode==='paste' ? 'bg-white text-tattvam-900 shadow-sm' : 'text-slate-500'}`}>Smart Paste</button>
                            </div>
                        )}

                        {step === 'input' ? (
                            <div className="p-8 flex-1 overflow-y-auto bg-slate-50 flex flex-col items-center justify-center">
                                {mode === 'generator' ? (
                                    <div className="w-full max-w-lg space-y-6">
                                        <textarea value={topic} onChange={e => setTopic(e.target.value)} className="w-full h-32 p-4 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 outline-none text-sm" placeholder="Enter topic, syllabus, or instructions..." />
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Difficulty</label><select value={difficulty} onChange={e => setDifficulty(e.target.value)} className="w-full p-2 border rounded-lg bg-white text-sm"><option>Easy</option><option>Medium</option><option>Hard</option><option>JEE Main</option><option>JEE Adv</option><option>NEET</option></select></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Count</label><select value={count} onChange={e => setCount(Number(e.target.value))} className="w-full p-2 border rounded-lg bg-white text-sm"><option>3</option><option>5</option><option>10</option><option>15</option><option>20</option></select></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Type</label><select value={type} onChange={e => setType(e.target.value)} className="w-full p-2 border rounded-lg bg-white text-sm"><option value="MIXED">Mixed</option><option value="SINGLE">Single Correct</option><option value="MULTI">Multi Correct</option><option value="NUMERICAL">Numerical</option></select></div>
                                            <div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Depth</label><select value={depth} onChange={e => setDepth(e.target.value)} className="w-full p-2 border rounded-lg bg-white text-sm"><option>Conceptual</option><option>Application</option><option>Analytical</option><option>Memory Based</option></select></div>
                                        </div>
                                        <div className="flex gap-3">
                                            <button onClick={onClose} className="flex-1 py-4 text-slate-500 hover:bg-slate-200 rounded-xl font-bold">Cancel</button>
                                            <button onClick={handleGenerate} disabled={generating} className="flex-[2] py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 shadow-lg disabled:opacity-50 flex justify-center gap-2 items-center">{generating ? <><Icon name="Loader2" className="animate-spin" /> Generating...</> : <><Icon name="Wand2" /> Generate</>}</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="w-full max-w-2xl space-y-6">
                                        <textarea value={rawText} onChange={e => setRawText(e.target.value)} className="w-full h-64 p-4 border-2 border-slate-300 rounded-xl focus:border-tattvam-500 outline-none font-mono text-sm" placeholder="Paste raw text here... Example: Q1. A particle moves... (A) 5 m/s..." />
                                        <div className="flex gap-3">
                                            <button onClick={onClose} className="flex-1 py-4 text-slate-500 hover:bg-slate-200 rounded-xl font-bold">Cancel</button>
                                            <button onClick={handleSmartPaste} disabled={parsing || !rawText} className="flex-[2] py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 shadow-lg disabled:opacity-50 flex justify-center gap-2 items-center">{parsing ? <><Icon name="Loader2" className="animate-spin" /> Parsing...</> : <><Icon name="Sparkles" /> Process</>}</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="flex flex-col flex-1 overflow-hidden bg-slate-50">
                                <div className="p-4 bg-white border-b flex justify-between items-center">
                                    <div><h3 className="font-bold text-slate-800">Review Questions</h3><p className="text-xs text-slate-500">Uncheck to discard. Click edit to modify text.</p></div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setStep('input')} className="text-slate-500 hover:text-slate-700 text-sm font-medium px-3">Back</button>
                                        <button onClick={handleConfirm} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-sm"><Icon name="ListChecks" className="w-4 h-4" /> Import {reviewList.filter(q=>q.selected!==false).length} Questions</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-4">
                                    {reviewList.map((q, i) => (
                                        <div key={q.id} className={`bg-white rounded-xl p-4 border-2 transition-all ${q.selected === false ? 'border-slate-200 opacity-50' : 'border-indigo-100 shadow-sm'}`}>
                                            <div className="flex items-start gap-3">
                                                <input type="checkbox" checked={q.selected !== false} onChange={() => toggleQuestion(q.id)} className="mt-1 w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex gap-2">
                                                            <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded">{q.type}</span>
                                                            <span className="text-[10px] font-bold bg-green-50 text-green-700 px-2 py-0.5 rounded">+{q.marks?.pos} / -{q.marks?.neg}</span>
                                                        </div>
                                                        <button onClick={() => setEditingId(editingId === q.id ? null : q.id)} className="text-slate-400 hover:text-indigo-600"><Icon name="Edit2" className="w-4 h-4" /></button>
                                                    </div>
                                                    
                                                    {editingId === q.id ? (
                                                        <textarea value={q.text} onChange={(e) => updateQuestionText(q.id, e.target.value)} className="w-full p-2 border rounded text-sm font-mono" rows={3} />
                                                    ) : (
                                                        <div className="text-sm font-medium text-slate-900 mb-2"><LatexRenderer content={q.text} /></div>
                                                    )}

                                                    {(q.type === 'SINGLE' || q.type === 'MULTI') && (
                                                        <div className="grid grid-cols-2 gap-2 text-xs text-slate-600">
                                                            {q.options?.map((opt, oIdx) => (
                                                                <div key={oIdx} className="flex gap-1 items-center">
                                                                    <span className={`w-4 h-4 flex items-center justify-center border rounded-full ${q.correctIndex === oIdx ? 'bg-green-500 text-white border-green-500' : 'border-slate-300'}`}>{String.fromCharCode(65+oIdx)}</span>
                                                                    <span><LatexRenderer content={opt} /></span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
const ImageCropper = ({ src, onConfirm, onCancel }) => {
            const imgRef = useRef(null);
            const [selection, setSelection] = useState(null); // {x,y,w,h} in %
            const [isDragging, setIsDragging] = useState(false);
            const [startPos, setStartPos] = useState(null);

            const getPos = (e) => {
                const rect = imgRef.current.getBoundingClientRect();
                const clientX = e.clientX || e.touches?.[0]?.clientX;
                const clientY = e.clientY || e.touches?.[0]?.clientY;
                return {
                    x: ((clientX - rect.left) / rect.width) * 100,
                    y: ((clientY - rect.top) / rect.height) * 100
                };
            };

            const handleMouseDown = (e) => {
                e.preventDefault();
                setIsDragging(true);
                const pos = getPos(e);
                setStartPos(pos);
                setSelection({ x: pos.x, y: pos.y, w: 0, h: 0 });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                const current = getPos(e);
                const x = Math.min(current.x, startPos.x);
                const y = Math.min(current.y, startPos.y);
                const w = Math.abs(current.x - startPos.x);
                const h = Math.abs(current.y - startPos.y);
                setSelection({ x, y, w, h });
            };

            const handleCrop = () => {
                if (!selection || selection.w < 1 || selection.h < 1) return alert("Select an area first.");
                const canvas = document.createElement('canvas');
                const img = imgRef.current;
                const naturalW = img.naturalWidth;
                const naturalH = img.naturalHeight;

                canvas.width = (selection.w / 100) * naturalW;
                canvas.height = (selection.h / 100) * naturalH;
                const ctx = canvas.getContext('2d');

                ctx.drawImage(
                    img,
                    (selection.x / 100) * naturalW,
                    (selection.y / 100) * naturalH,
                    canvas.width,
                    canvas.height,
                    0, 0, canvas.width, canvas.height
                );
                onConfirm(canvas.toDataURL('image/jpeg', 0.8));
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center p-4">
                    <div className="bg-slate-800 text-white w-full max-w-lg p-2 rounded-t-xl flex justify-between items-center">
                        <span className="font-bold text-sm flex items-center gap-2"><Icon name="Image" /> Crop Diagram</span>
                        <div className="flex gap-2">
                            <button onClick={onCancel} className="text-xs hover:text-slate-300">Cancel</button>
                            <button onClick={handleCrop} className="bg-indigo-600 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-500">Apply Crop</button>
                        </div>
                    </div>
                    <div 
                        className="relative bg-black border-2 border-slate-700 select-none max-h-[80vh] overflow-hidden"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={() => setIsDragging(false)}
                        onTouchStart={handleMouseDown}
                        onTouchMove={handleMouseMove}
                        onTouchEnd={() => setIsDragging(false)}
                    >
                        <img ref={imgRef} src={src} className="max-w-full max-h-[70vh] object-contain pointer-events-none" />
                        {selection && (
                            <div 
                                className="absolute border-2 border-white shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]"
                                style={{
                                    left: `${selection.x}%`,
                                    top: `${selection.y}%`,
                                    width: `${selection.w}%`,
                                    height: `${selection.h}%`
                                }}
                            >
                                <div className="absolute -top-6 left-0 bg-indigo-600 text-white text-[10px] px-1 rounded">Crop Area</div>
                            </div>
                        )}
                    </div>
                    <div className="text-slate-400 text-xs mt-2">Drag to select the diagram area.</div>
                </div>
            );
        };
const MoleculeStudio = ({ onConfirm, onCancel }) => {
            const [mode, setMode] = useState('search'); // search | draw
            const [query, setQuery] = useState('');
            const [loading, setLoading] = useState(false);
            const [preview, setPreview] = useState(null);
            
            // Drawing Refs
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            // Fetch from PubChem
            const fetchStructure = async () => {
                if(!query) return;
                setLoading(true);
                try {
                    // Try by Name first
                    let url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(query)}/PNG?record_type=2d&image_size=large`;
                    // Check if it's SMILES (heuristic: contains non-alpha)
                    if (query.match(/[^a-zA-Z]/)) {
                         url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(query)}/PNG?record_type=2d&image_size=large`;
                    }
                    
                    const res = await fetch(url);
                    if(!res.ok) throw new Error("Molecule not found");
                    const blob = await res.blob();
                    const reader = new FileReader();
                    reader.onload = (e) => setPreview(e.target.result);
                    reader.readAsDataURL(blob);
                } catch(e) { alert("Could not find molecule. Try SMILES code or Check Spelling."); }
                setLoading(false);
            };

            // Canvas Drawing Logic
            useEffect(() => {
                if(mode === 'draw' && canvasRef.current) {
                    const ctx = canvasRef.current.getContext('2d');
                    ctx.fillStyle = "white";
                    ctx.fillRect(0,0, 500, 400); // White bg
                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 2;
                    ctx.lineCap = "round";
                    ctx.lineJoin = "round";
                }
            }, [mode]);

            const startDraw = (e) => {
                const ctx = canvasRef.current.getContext('2d');
                const rect = canvasRef.current.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                setIsDrawing(true);
            };
            const draw = (e) => {
                if(!isDrawing) return;
                const ctx = canvasRef.current.getContext('2d');
                const rect = canvasRef.current.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            };
            const stopDraw = () => setIsDrawing(false);

            return (
                <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col">
                        <div className="bg-indigo-900 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="Atom" /> Molecule Studio</h3>
                            <button onClick={onCancel}><Icon name="X" /></button>
                        </div>
                        
                        {/* Tabs */}
                        <div className="flex border-b">
                            <button onClick={() => setMode('search')} className={`flex-1 py-3 text-sm font-bold ${mode==='search' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-400'}`}>Search / SMILES</button>
                            <button onClick={() => setMode('draw')} className={`flex-1 py-3 text-sm font-bold ${mode==='draw' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-400'}`}>Freehand Draw</button>
                        </div>

                        <div className="p-6 flex-1 bg-slate-50 flex flex-col items-center justify-center min-h-[300px]">
                            {mode === 'search' ? (
                                <div className="w-full space-y-4">
                                    <div className="flex gap-2">
                                        <input 
                                            value={query} 
                                            onChange={e => setQuery(e.target.value)} 
                                            onKeyDown={e => e.key === 'Enter' && fetchStructure()}
                                            className="flex-1 border p-2 rounded outline-none focus:border-indigo-500" 
                                            placeholder="e.g. Benzene, Aspirin, or C1=CC=C1..." 
                                        />
                                        <button onClick={fetchStructure} disabled={loading} className="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700 disabled:opacity-50">
                                            {loading ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="Search" />}
                                        </button>
                                    </div>
                                    <div className="border-2 border-dashed border-slate-200 h-64 rounded-lg flex items-center justify-center bg-white relative">
                                        {preview ? (
                                            <img src={preview} className="max-w-full max-h-full object-contain p-4" />
                                        ) : (
                                            <span className="text-slate-400 text-xs">Preview Area</span>
                                        )}
                                    </div>
                                    <button onClick={() => preview && onConfirm(preview)} disabled={!preview} className="w-full bg-green-600 text-white py-2 rounded font-bold disabled:opacity-50">Use Diagram</button>
                                </div>
                            ) : (
                                <div className="w-full">
                                    <canvas 
                                        ref={canvasRef} 
                                        width={500} 
                                        height={400} 
                                        className="bg-white border shadow-inner cursor-crosshair w-full h-64 touch-none"
                                        onMouseDown={startDraw} onMouseMove={draw} onMouseUp={stopDraw} onMouseLeave={stopDraw}
                                    />
                                    <div className="flex justify-between mt-4">
                                        <button onClick={() => {const ctx=canvasRef.current.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,500,400);}} className="text-red-500 text-xs font-bold hover:underline">Clear Canvas</button>
                                        <button onClick={() => onConfirm(canvasRef.current.toDataURL())} className="bg-indigo-600 text-white px-6 py-2 rounded font-bold">Use Drawing</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
const QuestionEditor = ({ question, onSave, onCancel, apiKey, onRequestKey }) => {
            const [form, setForm] = useState({ ...question });
            const [load, setLoad] = useState('');
            
            // --- FIXED: Removed Duplicate Declaration Here ---
            const [showCropper, setShowCropper] = useState(false);   
            const [moleculeMode, setMoleculeMode] = useState(false); 

            const run = async (msg, fn) => {
                if (!apiKey) return onRequestKey();
                if (!form.text) return alert("Text needed.");
                setLoad(msg);
                try { await fn(); } catch (e) { alert(e.message); }
                setLoad('');
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setForm({...form, diagram: ev.target.result});
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border-2 border-tattvam-100 p-6 relative">
                    {/* The Crop Modal */}
                    {showCropper && form.diagram && (
                        <ImageCropper 
                            src={form.diagram} 
                            onCancel={() => setShowCropper(false)}
                            onConfirm={(newImg) => {
                                setForm({ ...form, diagram: newImg });
                                setShowCropper(false);
                            }} 
                        />
                    )}

                    {load && <div className="absolute inset-0 bg-white/80 backdrop-blur-[1px] z-20 flex items-center justify-center rounded-xl"><div className="bg-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 border border-tattvam-500"><Icon name="Sparkles" className="w-4 h-4 text-tattvam-600 animate-spin" /><span className="text-xs font-bold text-tattvam-900">{load}</span></div></div>}
                    
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex gap-2 items-center">
                            <h4 className="text-sm font-bold text-tattvam-600 uppercase">Edit Question</h4>
                            {form.pyq_tag && <span className="text-[10px] bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full font-bold border border-amber-200">{form.pyq_tag}</span>}
                            <select 
    value={form.type || 'SINGLE'} 
    onChange={async (e) => {
        const newType = e.target.value;
        const currentText = form.text || "";

        // ---------------------------------------------------------
        // CASE 1: MATRIX -> TEXT (Restore to raw text)
        // ---------------------------------------------------------
        if (form.type === 'MATRIX' && newType !== 'MATRIX' && form.matrix) {
            if (confirm("Convert Matrix data back into Question Text?")) {
                let appendedText = "\n\n**Column I**\n";
                form.matrix.rows?.forEach((r, i) => { appendedText += `${String.fromCharCode(65+i)}. ${r}\n`; });
                
                appendedText += "\n**Column II**\n";
                form.matrix.cols?.forEach((c, i) => { appendedText += `${i+1}. ${c}\n`; });

                setForm({ ...form, type: newType, text: currentText + appendedText });
                return;
            }
        }

        // ---------------------------------------------------------
        // CASE 2: TEXT -> MATRIX (AI POWERED SMART CONVERT)
        // ---------------------------------------------------------
        if (newType === 'MATRIX' && form.type !== 'MATRIX') {
            if (confirm("âœ¨ Use AI to auto-detect Rows & Columns from text?")) {
                if (!apiKey) return onRequestKey();
                
                // Show a temporary loading state text
                const originalText = form.text;
                setForm({ ...form, text: "âœ¨ AI is analyzing structure... Please wait..." });

                try {
                    const prompt = `Act as a Data Parser.
                    Input Text: "${currentText}"
                    
                    Task: Identify the "Match the Following" or "Matrix" lists in this text.
                    1. Extract the main question text (remove the lists).
                    2. Extract 'Column I' (Rows) items.
                    3. Extract 'Column II' (Cols) items.
                    
                    Output strictly JSON:
                    {
                      "mainText": "Question text without the lists",
                      "rows": ["Row A", "Row B"...],
                      "cols": ["Col 1", "Col 2"...]
                    }`;

                    const data = await apiCall(apiKey, prompt);
                    
                    if (data.rows?.length > 0 && data.cols?.length > 0) {
                        setForm({
                            ...form,
                            type: 'MATRIX',
                            text: data.mainText || currentText,
                            matrix: { rows: data.rows, cols: data.cols },
                            matrixAns: {} 
                        });
                        alert(`âœ… AI Success: Extracted ${data.rows.length} Rows & ${data.cols.length} Columns!`);
                        return; // Stop here, don't do default setForm
                    } else {
                        alert("AI couldn't find a clear Matrix pattern. Switching manually.");
                        setForm({ ...form, type: 'MATRIX', text: originalText }); // Revert text
                    }
                } catch (err) {
                    console.error(err);
                    alert("AI Error: " + err.message);
                    setForm({ ...form, type: 'MATRIX', text: originalText }); // Revert text
                }
                return;
            }
        }

        // 3. Normal Switch (Manual)
        setForm({...form, type: newType});
    }} 
    className="text-xs border rounded p-1 font-bold text-slate-600 outline-none focus:border-indigo-500"
>
    <option value="SINGLE">Single Correct</option>
    <option value="MULTI">Multi Correct</option>
    <option value="NUMERICAL">Numerical</option>
    <option value="MATRIX">Matrix Match</option>
</select>
                            {/* Replace the existing marks input div with this: */}
<div className="flex items-center text-xs gap-1 border rounded px-2 bg-slate-50">
    {form.type === 'MATRIX' ? (
        <>
            <span className="font-bold text-indigo-700 px-1">Per Row:</span>
            <input 
                type="number" 
                className="w-8 bg-transparent font-bold text-indigo-700 outline-none" 
                value={form.marks?.perRow || 0} 
                onChange={e => setForm({...form, marks: {...form.marks, perRow: Number(e.target.value)}})} 
                title="Score for each correct row match"
            />
            <span className="text-slate-300">|</span>
            <span className="font-bold text-green-700 px-1">Bonus:</span>
            <input 
                type="number" 
                className="w-8 bg-transparent font-bold text-green-700 outline-none" 
                value={form.marks?.pos || 4} 
                onChange={e => setForm({...form, marks: {...form.marks, pos: Number(e.target.value)}})} 
                title="Bonus if ALL rows are correct"
            />
        </>
    ) : (
        <>
            <span className="text-green-600 font-bold">+</span>
            <input type="number" className="w-8 bg-transparent" value={form.marks?.pos || 4} onChange={e => setForm({...form, marks: {...form.marks, pos: Number(e.target.value)}})} />
        </>
    )}
    
    <span className="text-red-600 font-bold border-l pl-1">-</span>
    <input type="number" className="w-8 bg-transparent" value={form.marks?.neg || 1} onChange={e => setForm({...form, marks: {...form.marks, neg: Number(e.target.value)}})} />
</div>
                        </div>
                        <button onClick={() => run('Remixing...', async () => { const r = await generateRemix(form, apiKey); setForm(p => ({...p, text: r.text, options: r.options})); })} className="text-[10px] font-bold text-white bg-gradient-to-r from-purple-500 to-tattvam-500 hover:from-purple-600 hover:to-tattvam-600 px-3 py-1.5 rounded-full flex items-center gap-1 shadow-sm"><Icon name="RefreshCw" className="w-3 h-3" /> Remix</button>
                    </div>
                    
                    <div className="grid md:grid-cols-3 gap-6 mb-4">
                        <div className="md:col-span-2"><label className="block text-xs font-semibold text-slate-500 mb-1">Question Text</label><textarea value={form.text} onChange={e => setForm({...form, text: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-tattvam-500 outline-none font-mono text-sm h-32" /></div>
                        
                        {/* --- DIAGRAM SECTION --- */}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <label className="block text-xs font-semibold text-slate-500">Diagram</label>
                                <div className="flex gap-1">
                                    <button onClick={() => setMoleculeMode(true)} className="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded hover:bg-purple-100 font-bold flex items-center gap-1 border border-purple-100" title="Draw or Search Chemicals"><Icon name="Atom" className="w-3 h-3" /> Molecule</button>
                                    {form.diagram && (
                                        <button onClick={() => setShowCropper(true)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded hover:bg-indigo-100 font-bold flex items-center gap-1 border border-indigo-100" title="Crop visible area"><Icon name="Edit2" className="w-3 h-3" /> Crop</button>
                                    )}
                                </div>
                            </div>

                            {moleculeMode && <MoleculeStudio onCancel={() => setMoleculeMode(false)} onConfirm={(img) => { setForm({...form, diagram: img}); setMoleculeMode(false); }} />}
                            {showCropper && form.diagram && <ImageCropper src={form.diagram} onCancel={() => setShowCropper(false)} onConfirm={(newImg) => { setForm({ ...form, diagram: newImg }); setShowCropper(false); }} />}

                         {/* --- FIXED DIAGRAM BOX: SEPARATE FOCUS & UPLOAD --- */}
                            <div 
                                className="h-32 border-2 border-dashed border-slate-200 rounded-lg flex flex-col items-center justify-center relative overflow-hidden bg-slate-50 group hover:border-tattvam-400 hover:bg-slate-100 transition-all outline-none focus:ring-2 focus:ring-tattvam-500 focus:border-transparent cursor-default"
                                tabIndex={0} // Makes the div focusable
                                onClick={(e) => e.currentTarget.focus()} // Clicking empty area just focuses for Paste
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={(e) => {
                                    e.preventDefault();
                                    const file = e.dataTransfer.files[0];
                                    if(file && file.type.startsWith('image/')) {
                                        const reader = new FileReader();
                                        reader.onload = (ev) => setForm({...form, diagram: ev.target.result});
                                        reader.readAsDataURL(file);
                                    }
                                }}
                                onPaste={(e) => {
                                    const items = e.clipboardData?.items;
                                    if (!items) return;
                                    for (let i = 0; i < items.length; i++) {
                                        if (items[i].type.indexOf('image') !== -1) {
                                            e.preventDefault();
                                            const file = items[i].getAsFile();
                                            const reader = new FileReader();
                                            reader.onload = (ev) => setForm({...form, diagram: ev.target.result});
                                            reader.readAsDataURL(file);
                                            break;
                                        }
                                    }
                                }}
                            >
                                {form.diagram ? (
                                    <>
                                        <img src={form.diagram} className="w-full h-full object-contain" />
                                        <button onClick={(e) => { e.stopPropagation(); setForm({...form, diagram: null}); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm" title="Remove Diagram"><Icon name="X" className="w-3 h-3" /></button>
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center justify-center pointer-events-none"> 
                                        {/* pointer-events-none ensures clicks pass through text to the div */}
                                        <Icon name="Image" className="w-8 h-8 text-slate-300 mb-1" />
                                        <span className="text-[10px] text-slate-400 font-medium text-center px-4 leading-tight mb-2">
                                            <span className="font-bold text-slate-600">Drag & Drop</span> or <span className="font-bold text-slate-500">Ctrl+V</span> here
                                        </span>
                                        
                                        {/* SPECIFIC UPLOAD BUTTON - Only this triggers file manager */}
                                        <label className="pointer-events-auto cursor-pointer bg-white border border-slate-200 text-slate-600 text-[10px] px-3 py-1.5 rounded-md font-bold hover:border-tattvam-500 hover:text-tattvam-600 shadow-sm transition-all flex items-center gap-1">
                                            <Icon name="Upload" className="w-3 h-3" /> Browse File
                                            <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                        </label>
                                    </div>
                                )}
                            </div></div>
                    </div>

                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-1"><label className="block text-xs font-semibold text-slate-500">Answer Key</label>{(form.type === 'SINGLE' || form.type === 'MULTI') && <button onClick={() => run('Options...', async () => { const o = await generateDistractors(form, apiKey); setForm(p => ({...p, options: [...(p.options||[]), ...o]})); })} className="text-[10px] font-bold text-tattvam-600 bg-tattvam-50 hover:bg-tattvam-100 px-2 py-1 rounded-full flex items-center gap-1"><Icon name="Sparkles" className="w-3 h-3" /> Auto-Fill</button>}</div>
                        {(form.type === 'SINGLE' || form.type === 'MULTI' || !form.type) && <div className="space-y-2">{form.options?.map((opt, idx) => (
                            <div key={idx} className="flex items-center gap-2">
                                <input type={form.type === 'MULTI' ? 'checkbox' : 'radio'} name="correctAnswer" checked={form.type === 'MULTI' ? form.correctIndices?.includes(idx) : form.correctIndex === idx} onChange={() => { if(form.type === 'MULTI') { const cur = form.correctIndices || []; setForm({...form, correctIndices: cur.includes(idx) ? cur.filter(x=>x!==idx) : [...cur, idx]}); } else { setForm({...form, correctIndex: idx}); } }} className="w-4 h-4 text-tattvam-600" />
                                
                                {/* NEW: Chemical Toggle Button */}
                                <button 
                                    onClick={() => {
                                        const n = [...form.options];
                                        if (n[idx].startsWith('CHEM:')) n[idx] = n[idx].replace('CHEM:', '');
                                        else n[idx] = 'CHEM:' + n[idx];
                                        setForm({...form, options: n});
                                    }}
                                    className={`p-1.5 rounded-md text-[10px] font-bold border transition-colors ${opt.startsWith('CHEM:') ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:text-purple-500'}`}
                                    title="Convert to Chemical Structure"
                                >
                                    <Icon name="Atom" className="w-3.5 h-3.5" />
                                </button>

                                <input type="text" value={opt} onChange={e => {const n = [...form.options]; n[idx]=e.target.value; setForm({...form, options:n})}} className="flex-1 p-2 border border-slate-200 rounded-md text-sm outline-none focus:border-tattvam-500 font-mono" />
                                <button onClick={() => {const n=form.options.filter((_,i)=>i!==idx); setForm({...form, options:n})}} className="text-slate-300 hover:text-red-500"><Icon name="X" className="w-4 h-4" /></button>
                            </div>
                        ))}<button onClick={() => setForm({...form, options: [...(form.options||[]), "New Option"]})} className="text-xs text-tattvam-600 font-medium hover:underline flex items-center gap-1 mt-2"><Icon name="Plus" className="w-3 h-3" /> Add Option</button></div>}
                        {form.type === 'NUMERICAL' && <div className="flex items-center gap-2 bg-blue-50 p-3 rounded"><span className="text-sm font-bold text-blue-800">Correct Value:</span><input type="text" value={form.correctNum || ''} onChange={e => setForm({...form, correctNum: e.target.value})} className="border p-2 rounded w-32" placeholder="e.g. 5.5" /></div>}
                        
                        {/* MATRIX INPUT BLOCK */}
{/* --- MATRIX INPUT BLOCK (FIXED) --- */}
{form.type === 'MATRIX' && (
    <div className="col-span-3 bg-slate-50 p-4 rounded-lg border border-slate-200">
        <div className="flex gap-4 mb-4">
            {/* ROWS INPUT */}
            <div className="flex-1">
                <h5 className="text-xs font-bold text-indigo-800 uppercase mb-2 border-b border-indigo-100 pb-1">Column I (Rows)</h5>
                {form.matrix?.rows?.map((r, i) => (
                    <div key={i} className="flex gap-2 mb-2 items-center animate-in slide-in-from-left-2">
                        <span className="font-bold text-xs text-slate-400 w-6 flex-shrink-0">{String.fromCharCode(65+i)}</span>
                        <textarea 
                            rows={1}
                            value={r} 
                            onChange={e => {
                                const newRows = [...(form.matrix?.rows || [])];
                                newRows[i] = e.target.value;
                                setForm({...form, matrix:{...(form.matrix || {}), rows: newRows}});
                            }} 
                            className="flex-1 border p-2 rounded text-sm focus:border-indigo-500 outline-none resize-none" 
                            placeholder={`Row ${String.fromCharCode(65+i)} Text`} 
                        />
                        <button onClick={() => {
                            const newRows = form.matrix.rows.filter((_,idx)=>idx!==i); 
                            setForm({...form, matrix:{...form.matrix, rows: newRows}});
                        }} className="text-red-400 hover:text-red-600 p-1"><Icon name="X" className="w-4 h-4"/></button>
                    </div>
                ))}
                <button 
                    onClick={() => {
                        const currentRows = form.matrix?.rows || [];
                        setForm({
                            ...form, 
                            matrix: { ...(form.matrix || {}), rows: [...currentRows, ""] }
                        });
                    }} 
                    className="mt-2 text-xs font-bold text-white bg-indigo-600 px-3 py-1.5 rounded hover:bg-indigo-700 flex items-center gap-1 shadow-sm"
                >
                    <Icon name="Plus" className="w-3 h-3" /> Add Row
                </button>
            </div>

            {/* COLS INPUT */}
            <div className="flex-1">
                <h5 className="text-xs font-bold text-indigo-800 uppercase mb-2 border-b border-indigo-100 pb-1">Column II (Cols)</h5>
                {form.matrix?.cols?.map((c, i) => (
                    <div key={i} className="flex gap-2 mb-2 items-center animate-in slide-in-from-right-2">
                        <span className="font-bold text-xs text-slate-400 w-6 flex-shrink-0 text-center">{i+1}</span>
                        <textarea 
                            rows={1}
                            value={c} 
                            onChange={e => {
                                const newCols = [...(form.matrix?.cols || [])];
                                newCols[i] = e.target.value;
                                setForm({...form, matrix:{...(form.matrix || {}), cols: newCols}});
                            }} 
                            className="flex-1 border p-2 rounded text-sm focus:border-indigo-500 outline-none resize-none" 
                            placeholder={`Col ${i+1} Text`} 
                        />
                        <button onClick={() => {
                            const newCols = form.matrix.cols.filter((_,idx)=>idx!==i); 
                            setForm({...form, matrix:{...form.matrix, cols: newCols}});
                        }} className="text-red-400 hover:text-red-600 p-1"><Icon name="X" className="w-4 h-4"/></button>
                    </div>
                ))}
                <button 
                    onClick={() => {
                        const currentCols = form.matrix?.cols || [];
                        setForm({
                            ...form, 
                            matrix: { ...(form.matrix || {}), cols: [...currentCols, ""] }
                        });
                    }} 
                    className="mt-2 text-xs font-bold text-white bg-indigo-600 px-3 py-1.5 rounded hover:bg-indigo-700 flex items-center gap-1 shadow-sm"
                >
                    <Icon name="Plus" className="w-3 h-3" /> Add Column
                </button>
            </div>
        </div>
        
        {/* ANSWER KEY MAPPING */}
        <div className="bg-white p-4 rounded border border-slate-200 shadow-inner">
            <h5 className="text-xs font-bold text-slate-600 uppercase mb-3 flex items-center gap-2"><Icon name="CheckCircle2" className="w-4 h-4 text-green-600" /> Map Correct Answers</h5>
            <div className="overflow-x-auto">
                <table className="w-full text-center border-collapse">
                    <thead>
                        <tr>
                            <th className="p-2 border-b text-xs text-slate-400 w-16">Row</th>
                            {form.matrix?.cols?.map((_, c) => (
                                <th key={c} className="p-2 border-b text-xs font-bold text-indigo-900 bg-indigo-50 min-w-[40px]">{c+1}</th>
                            ))}
                        </tr>
                    </thead>
                    <tbody>
                        {form.matrix?.rows?.map((_, r) => (
                            <tr key={r} className="hover:bg-slate-50 transition-colors border-b last:border-0 border-slate-100">
                                <td className="p-2 font-bold text-sm text-slate-700 bg-slate-50">{String.fromCharCode(65+r)}</td>
                                {form.matrix?.cols?.map((_, c) => (
                                    <td key={c} className="p-2">
                                        <input 
                                            type="checkbox" 
                                            checked={form.matrixAns?.[r]?.includes(c)} 
                                            onChange={() => { 
                                                const cur = form.matrixAns?.[r] || []; 
                                                const newAns = cur.includes(c) ? cur.filter(x => x !== c) : [...cur, c]; 
                                                setForm({ ...form, matrixAns: { ...form.matrixAns, [r]: newAns } }); 
                                            }} 
                                            className="w-5 h-5 accent-indigo-600 cursor-pointer" 
                                        />
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
)}
                    </div>

                    <div className="mb-6"><div className="flex justify-between items-center mb-1"><label className="block text-xs font-semibold text-slate-500">Explanation</label><button onClick={() => run('Explaining...', async () => { const e = await generateExplanation(form, apiKey); setForm(p => ({...p, explanation: e})); })} className="text-[10px] font-bold text-tattvam-600 bg-tattvam-50 hover:bg-tattvam-100 px-2 py-1 rounded-full flex items-center gap-1"><Icon name="Lightbulb" className="w-3 h-3" /> AI Explain</button></div><textarea value={form.explanation || ''} onChange={e => setForm({...form, explanation: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-tattvam-500 outline-none text-sm h-20" /></div>
                    <div className="flex justify-end gap-3 pt-4 border-t border-slate-100"><button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">Cancel</button><button onClick={() => onSave(form)} className="px-4 py-2 bg-tattvam-600 text-white rounded-lg hover:bg-tattvam-500 text-sm font-medium flex items-center gap-2"><Icon name="Save" className="w-4 h-4" /> Save</button></div>
                </div>
            );
        };    

        // --- NEW: EDIT ENTRY MODAL (For Renaming & Reordering by Date) ---
const EntryEditorModal = ({ entry, onSave, onClose }) => {
    const [title, setTitle] = useState(entry.testName || "");
    // Format date for datetime-local input (YYYY-MM-DDTHH:MM)
    const [date, setDate] = useState(entry.date ? new Date(entry.date).toISOString().slice(0, 16) : "");

    const handleSave = () => {
        if (!title.trim()) return alert("Test Name is required");
        if (!date) return alert("Date is required");
        
        // Save with new ISO date string
        const newEntry = { 
            ...entry, 
            testName: title, 
            date: new Date(date).toISOString() 
        };
        onSave(newEntry);
    };

    return (
        <div className="fixed inset-0 bg-black/60 z-[150] flex items-center justify-center p-4 animate-in fade-in">
            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="Edit2" /> Edit Details</h3>
                    <button onClick={onClose}><Icon name="X" /></button>
                </div>
                
                <div className="space-y-4 mb-6">
                    <div>
                        <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Test Name</label>
                        <input 
                            value={title} 
                            onChange={e => setTitle(e.target.value)} 
                            className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none text-sm font-semibold" 
                            placeholder="e.g. Physics Mock 1"
                        />
                    </div>
                    <div>
                        <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Date & Time</label>
                        <input 
                            type="datetime-local" 
                            value={date} 
                            onChange={e => setDate(e.target.value)} 
                            className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none text-sm font-mono" 
                        />
                        <p className="text-[10px] text-slate-400 mt-2 bg-slate-50 p-2 rounded border border-slate-100">
                            <strong>Note:</strong> Changing the date will reorder this test in your Performance Trend graph and History list.
                        </p>
                    </div>
                </div>

                <div className="flex gap-3">
                    <button onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 text-sm">Cancel</button>
                    <button onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 text-sm shadow-lg">Save Changes</button>
                </div>
            </div>
        </div>
    );
};

// --- NEW: REMIX STUDIO PRO (With Cross-Test Library) ---
// --- IMPROVED: REMIX STUDIO PRO (Fixed Icons & All Questions) ---
const RemixStudioModal = ({ notebook, allTests, onClose, onCreate }) => {
    const [tab, setTab] = useState('notebook'); // 'notebook' | 'library'
    const [cart, setCart] = useState([]); 
    const [search, setSearch] = useState("");
    const [filterType, setFilterType] = useState('mistakes'); // 'mistakes' | 'correct' | 'all'

    // 1. GET QUESTIONS FROM CURRENT NOTEBOOK
    const notebookQuestions = React.useMemo(() => {
        const unique = new Map();
        notebook.entries?.forEach(entry => {
            entry.details?.forEach(d => {
                // FILTER LOGIC:
                let match = false;
                if (filterType === 'mistakes') match = (d.status === 'wrong' || d.status === 'left');
                else if (filterType === 'correct') match = (d.status === 'correct');
                else match = true; // 'all' - Show everything

                if (match && d.qData) {
                    if (!unique.has(d.qData.text)) {
                        unique.set(d.qData.text, { ...d.qData, _source: `From: ${entry.testName}` });
                    }
                }
            });
        });
        return Array.from(unique.values());
    }, [notebook, filterType]);

    // 2. SEARCH GLOBAL LIBRARY
    // 2. SEARCH GLOBAL LIBRARY (CRASH PROOF VERSION)
    const libraryQuestions = React.useMemo(() => {
        if (!search || search.length < 2) return []; // Wait for 2 chars
        
        console.log("Searching in tests:", allTests?.length); // Debugging Log
        
        const results = [];
        const term = search.toLowerCase();

        (allTests || []).forEach(test => {
            // Safety: Skip if test has no questions
            if (!test.questions || !Array.isArray(test.questions)) return;

            test.questions.forEach(q => {
                // Safety: Ensure text exists before checking
                const qText = (q.text || "").toLowerCase();
                
                // Search in Question Text
                if (qText.includes(term)) {
                    results.push({ ...q, _source: `From: ${test.title}` });
                }
            });
        });
        return results.slice(0, 50);
    }, [allTests, search]);

    const toggleCart = (q) => {
        if (cart.find(c => c.text === q.text)) setCart(cart.filter(c => c.text !== q.text));
        else setCart([...cart, { ...q, id: Date.now() + Math.random() }]);
    };

    const handleFinish = () => {
        if (cart.length === 0) return alert("Select at least one question!");
        const title = prompt("Name your Remix Test:", `Remix: ${notebook.title} (${cart.length} Qs)`);
        if (!title) return;
        onCreate({
            id: Date.now().toString(),
            title: title,
            created: new Date().toISOString(),
            questions: cart
        });
    };

    return (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in zoom-in-95">
            <div className="bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                
                {/* HEADER */}
                <div className="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0">
                    <div className="flex items-center gap-3">
                        <div className="bg-purple-600 p-2 rounded-lg">
                            <Icon name="RefreshCw" className="w-5 h-5 text-white" />
                        </div>
                        <div>
                            <h2 className="font-bold text-lg">Remix Studio</h2>
                            <p className="text-xs text-slate-400">Build a custom test</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="hover:bg-white/10 p-2 rounded-full">
                        <Icon name="X" className="w-5 h-5 text-white" />
                    </button>
                </div>

                <div className="flex flex-1 overflow-hidden">
                    
                    {/* LEFT PANEL: SOURCE SELECTION */}
                    <div className="w-2/3 border-r border-slate-200 flex flex-col bg-slate-50">
                        {/* TABS */}
                        <div className="flex border-b bg-white">
                            <button onClick={() => setTab('notebook')} className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 border-b-2 ${tab==='notebook' ? 'border-purple-600 text-purple-700 bg-purple-50' : 'border-transparent text-slate-500 hover:bg-slate-50'}`}>
                                <Icon name="Book" className="w-4 h-4" /> From Notebook
                            </button>
                            <button onClick={() => setTab('library')} className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 border-b-2 ${tab==='library' ? 'border-indigo-600 text-indigo-700 bg-indigo-50' : 'border-transparent text-slate-500 hover:bg-slate-50'}`}>
                                <Icon name="Search" className="w-4 h-4" /> Search All Tests
                            </button>
                        </div>

                        {/* FILTERS OR SEARCH BAR */}
                        <div className="p-4 border-b bg-white shadow-sm z-10">
                            {tab === 'notebook' ? (
                                <div className="flex gap-2">
                                    {/* ðŸ”´ NEW FILTERS HERE */}
                                    <button onClick={() => setFilterType('mistakes')} className={`px-4 py-2 rounded-full text-xs font-bold uppercase transition-all border ${filterType==='mistakes' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-slate-500 border-slate-200'}`}>Mistakes</button>
                                    <button onClick={() => setFilterType('correct')} className={`px-4 py-2 rounded-full text-xs font-bold uppercase transition-all border ${filterType==='correct' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-white text-slate-500 border-slate-200'}`}>Correct</button>
                                    <button onClick={() => setFilterType('all')} className={`px-4 py-2 rounded-full text-xs font-bold uppercase transition-all border ${filterType==='all' ? 'bg-slate-800 text-white border-slate-900' : 'bg-white text-slate-500 border-slate-200'}`}>Show All</button>
                                </div>
                            ) : (
                                <div className="relative">
                                    <div className="absolute left-3 top-3 text-slate-400">
                                        <Icon name="Search" className="w-4 h-4" />
                                    </div>
                                    <input autoFocus value={search} onChange={e => setSearch(e.target.value)} placeholder="Search for any question..." className="w-full pl-9 p-2.5 bg-slate-100 rounded-lg text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" />
                                </div>
                            )}
                        </div>

                        {/* QUESTION LIST */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {(tab === 'notebook' ? notebookQuestions : libraryQuestions).map((q, i) => {
                                const isSelected = cart.some(c => c.text === q.text);
                                return (
                                    <div key={i} onClick={() => toggleCart(q)} className={`p-4 rounded-xl border-2 cursor-pointer transition-all hover:scale-[1.01] flex gap-4 ${isSelected ? 'border-purple-500 bg-purple-50 shadow-md' : 'border-slate-200 bg-white hover:border-purple-300'}`}>
                                        <div className="flex-1">
                                            <span className="text-[10px] font-bold bg-slate-200 text-slate-600 px-2 py-0.5 rounded uppercase mb-2 inline-block">{q._source}</span>
                                            <div className="text-sm font-medium text-slate-800 line-clamp-3"><LatexRenderer content={q.text} /></div>
                                        </div>
                                        <div className="shrink-0 pt-1">
                                            {isSelected ? (
                                                <div className="bg-purple-600 text-white rounded-full p-1"><Icon name="Check" className="w-4 h-4" /></div>
                                            ) : (
                                                <div className="w-6 h-6 rounded-full border-2 border-slate-300"></div>
                                            )}
                                        </div>
                                    </div>
                                )
                            })}
                            {tab === 'library' && !search && <div className="text-center py-10 text-slate-400 font-bold">Type to search...</div>}
                            {tab === 'notebook' && notebookQuestions.length === 0 && <div className="text-center py-10 text-slate-400 font-bold">No questions found for this filter.</div>}
                        </div>
                    </div>

                    {/* RIGHT PANEL: CART */}
                    <div className="w-1/3 flex flex-col bg-white border-l border-slate-200 shadow-xl relative z-20">
                        <div className="p-4 bg-purple-50 border-b border-purple-100 shrink-0">
                            <h3 className="font-bold text-purple-900 flex items-center gap-2">
                                <Icon name="List" className="w-5 h-5" /> Your Mix Tape
                            </h3>
                            <p className="text-xs text-purple-600 font-medium">{cart.length} Questions Selected</p>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {cart.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-slate-300">
                                    <Icon name="Plus" className="w-12 h-12 mb-2 opacity-20" />
                                    <p className="font-bold text-sm">Click questions to add</p>
                                </div>
                            ) : (
                                cart.map((q, i) => (
                                    <div key={i} className="flex gap-2 items-start p-3 bg-slate-50 rounded-lg border border-slate-100 group hover:border-red-200 transition-colors">
                                        <div className="flex-1 text-xs text-slate-600 line-clamp-2 font-medium">{q.text}</div>
                                        <button onClick={(e) => { e.stopPropagation(); toggleCart(q); }} className="text-slate-400 hover:text-red-500 transition-colors">
                                            <Icon name="X" className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="p-4 border-t bg-slate-50 shrink-0">
                            <button onClick={handleFinish} disabled={cart.length === 0} className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                                <Icon name="Play" className="w-5 h-5 fill-current" /> Create Test & Play
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    );
};
// --- UPDATED ANALYSIS NOTEBOOK (LAUNCHES DASHBOARD) ---
// --- UPDATED ANALYSIS NOTEBOOK (With Entry Deletion) ---
// --- UPDATED ANALYSIS NOTEBOOK (With Persistence Support) ---
// --- UPDATED ANALYSIS NOTEBOOK (Fixed Chart + Delete AI) ---
// --- UPDATED ANALYSIS NOTEBOOK (With Sorting, Editing, & Graph) ---
// ==========================================
// ANALYSIS NOTEBOOK (With "Spotlight" Graph)
// ==========================================
// ==========================================
// ANALYSIS NOTEBOOK (With Remix Studio Pro)
// ==========================================
const AnalysisNotebook = ({ notebook, onUpdate, onBack, apiKey, onRequestKey, onRemix, tests }) => {
    const [uploading, setUploading] = useState(false);
    const [analyzing, setAnalyzing] = useState(false);
    
    // UI State
    const [viewingEntry, setViewingEntry] = useState(null); 
    const [expandedEntryId, setExpandedEntryId] = useState(null);
    const [editModalEntry, setEditModalEntry] = useState(null); 
    const [sortMode, setSortMode] = useState('dateDesc'); 

    // NEW: Remix Modal State
    const [showRemix, setShowRemix] = useState(false);

    // --- SORTING ---
    const getSortedEntries = () => {
        if (!notebook.entries) return [];
        const arr = [...notebook.entries];
        switch (sortMode) {
            case 'dateDesc': return arr.sort((a, b) => new Date(b.date) - new Date(a.date));
            case 'dateAsc': return arr.sort((a, b) => new Date(a.date) - new Date(b.date));
            case 'scoreDesc': return arr.sort((a, b) => b.score - a.score);
            case 'scoreAsc': return arr.sort((a, b) => a.score - b.score);
            default: return arr;
        }
    };

    // --- HANDLERS ---
    const handleEntryUpdate = (updatedEntry) => {
        const updatedEntries = notebook.entries.map(e => e.id === updatedEntry.id ? updatedEntry : e);
        onUpdate({ ...notebook, entries: updatedEntries });
        if (viewingEntry && viewingEntry.id === updatedEntry.id) setViewingEntry(updatedEntry);
        setEditModalEntry(null);
    };

    const handleDeleteEntry = (e, entryId) => {
        e.stopPropagation(); 
        if (confirm("Delete this attempt? Cannot be undone.")) {
            const updatedEntries = notebook.entries.filter(en => en.id !== entryId);
            onUpdate({ ...notebook, entries: updatedEntries });
        }
    };

    const handleDeleteAnalysis = () => {
        if (confirm("Delete AI Mentor Analysis?")) {
            const u = { ...notebook }; delete u.insights; onUpdate(u);
        }
    };

    const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!apiKey) return onRequestKey();
        setUploading(true);
        try {
            const b64 = await fileToBase64(file);
            const data = await analyzeResultImage(b64, apiKey);
            const newEntry = { id: Date.now().toString(), date: new Date().toISOString(), ...data, type: 'IMAGE_IMPORT' };
            onUpdate({ ...notebook, entries: [newEntry, ...(notebook.entries || [])] });
        } catch (err) { alert("Failed: " + err.message); }
        setUploading(false);
    };

    const runDeepAnalysis = async () => {
        if (!notebook.entries?.length) return alert("No entries.");
        if (!apiKey) return onRequestKey();
        setAnalyzing(true);
        try {
            const insights = await generateAnalysisInsights(notebook.entries, apiKey);
            onUpdate({ ...notebook, insights });
        } catch (e) { alert(e.message); }
        setAnalyzing(false);
    };

    // --- CHART COMPONENT ---
    const SuperChart = ({ entries }) => {
        const [hovered, setHovered] = useState(null);
        if (!entries || entries.length === 0) return <div className="h-40 flex items-center justify-center text-slate-400 border-2 border-dashed rounded-xl bg-slate-50/50">No data available.</div>;

        const data = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date)).map(e => {
            const max = e.maxMarks || 100;
            const pct = Math.min(100, Math.max(0, Math.round((e.score / max) * 100)));
            return { ...e, pct, max };
        });
        const active = hovered || data[data.length - 1];
        const getPoints = () => {
            if (data.length < 2) return "";
            const step = 100 / (data.length - 1 || 1);
            return data.map((d, i) => `${i * step},${100 - d.pct}`).join(" ");
        };

        return (
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-all hover:shadow-md">
                <div className="flex justify-between items-end mb-8 h-16">
                    <div>
                        <div className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 flex items-center gap-2">
                            <Icon name="Target" className="w-4 h-4 text-indigo-500" /> Performance Spotlight
                        </div>
                        <div className="text-xl font-black text-slate-800 leading-none truncate max-w-[200px] md:max-w-md">{active.testName || "Untitled Test"}</div>
                        <div className="text-xs text-slate-500 font-medium mt-1 flex items-center gap-2"><Icon name="Clock" className="w-3 h-3" /> {new Date(active.date).toLocaleDateString()} {active === hovered && <span className="bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded text-[10px] font-bold">Viewing</span>}</div>
                    </div>
                    <div className="text-right">
                        <div className="flex items-baseline justify-end gap-1"><span className="text-4xl font-black text-indigo-600 tracking-tight">{active.pct}%</span><span className="text-sm font-bold text-slate-300">/ 100%</span></div>
                        <div className="text-xs font-bold text-slate-400 mt-1">Score: {active.score} / {active.max}</div>
                    </div>
                </div>
                <div className="relative h-48 w-full" onMouseLeave={() => setHovered(null)}>
                    <svg className="absolute inset-0 w-full h-full overflow-visible pointer-events-none z-0" preserveAspectRatio="none" viewBox={`0 0 100 100`}>
                        <defs><linearGradient id="chartGrad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stopColor="#6366f1" stopOpacity="0.2" /><stop offset="100%" stopColor="#6366f1" stopOpacity="0" /></linearGradient></defs>
                        {data.length > 1 && <><polyline points={`${getPoints()} 100,100 0,100`} fill="url(#chartGrad)" stroke="none"/><polyline points={getPoints()} fill="none" stroke="#6366f1" strokeWidth="0.5" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke"/></>}
                    </svg>
                    <div className="absolute inset-0 flex items-end justify-between z-10 px-2">
                        {data.map((d, i) => {
                            const isFocus = active.id === d.id;
                            let barColor = isFocus ? (d.pct >= 80 ? "bg-emerald-400" : d.pct >= 50 ? "bg-indigo-400" : "bg-amber-400") : "bg-slate-200";
                            if (hovered && !isFocus) barColor = "bg-slate-100";
                            return (
                                <div key={i} onMouseEnter={() => setHovered(d)} className="flex-1 flex flex-col justify-end items-center group h-full relative cursor-pointer px-0.5 md:px-2 transition-all duration-300">
                                    <div style={{ height: `${Math.max(d.pct, 4)}%` }} className={`w-full max-w-[40px] rounded-t-lg transition-all duration-300 relative ${barColor} ${isFocus ? 'shadow-lg scale-105' : 'hover:opacity-90'}`}>
                                        {isFocus && <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-white rounded-full shadow-sm ring-2 ring-indigo-500"></div>}
                                    </div>
                                    <div className={`mt-3 text-[10px] font-bold transition-colors ${isFocus ? 'text-indigo-600 scale-110' : 'text-slate-300'}`}>{i + 1}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        );
    };

    if (viewingEntry) return <ResultDashboard entry={viewingEntry} onBack={() => setViewingEntry(null)} onUpdateEntry={handleEntryUpdate} allTests={tests} apiKey={apiKey} />;

    return (
        <div className="h-full flex flex-col bg-slate-50 relative animate-in fade-in">
            {editModalEntry && <EntryEditorModal entry={editModalEntry} onClose={() => setEditModalEntry(null)} onSave={handleEntryUpdate} />}

            {/* NEW: REMIX STUDIO MODAL */}
            {showRemix && (
                <RemixStudioModal 
                    notebook={notebook} 
                    allTests={tests}   
                    onClose={() => setShowRemix(false)} 
                    onCreate={(newTest) => {
                        setShowRemix(false);
                        onRemix(newTest);
                    }} 
                />
            )}

            {/* HEADER */}
            <div className="bg-white border-b px-6 py-4 flex items-center justify-between shadow-sm shrink-0">
                <div className="flex items-center gap-4">
                    <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-100 text-slate-500"><Icon name="ArrowLeft" /></button>
                    <div><input value={notebook.title} onChange={e => onUpdate({...notebook, title: e.target.value})} className="font-bold text-xl outline-none bg-transparent placeholder-slate-300" placeholder="Notebook Title" /><p className="text-xs text-slate-500 font-medium">{notebook.entries?.length || 0} Entries</p></div>
                </div>
                <div className="flex gap-2">
                    {/* BUTTON OPENS NEW MODAL */}
                    <button onClick={() => setShowRemix(true)} className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-bold shadow-sm transition-all animate-pulse-slow">
                        <Icon name="RefreshCw" className="w-4 h-4" /> Remix Mistakes
                    </button>
                    
                    <label className="flex items-center gap-2 bg-white border border-indigo-100 text-indigo-600 px-4 py-2 rounded-lg cursor-pointer hover:bg-indigo-50 font-bold shadow-sm transition-all">{uploading ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="Camera" />}<span>Scan</span><input type="file" className="hidden" accept="image/*" onChange={handleImageUpload} disabled={uploading} /></label>
                    <button onClick={runDeepAnalysis} disabled={analyzing} className="flex items-center gap-2 bg-tattvam-900 text-white px-4 py-2 rounded-lg hover:bg-tattvam-800 font-bold shadow-sm transition-all">{analyzing ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="BrainCircuit" />} Analysis</button>
                </div>
            </div>

            {/* CONTENT */}
            <div className="flex-1 overflow-y-auto p-6 md:p-8">
                <div className="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
                    {/* LEFT COL: AI & SUPER CHART */}
                    <div className="space-y-6">
                        {notebook.insights && (
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-purple-100 relative group animate-in slide-in-from-top-4">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-2 text-purple-700 font-bold"><Icon name="Sparkles" /> AI Mentor</div>
                                    <button onClick={handleDeleteAnalysis} className="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded transition-all opacity-0 group-hover:opacity-100" title="Delete Report"><Icon name="Trash2" className="w-4 h-4" /></button>
                                </div>
                                <p className="text-sm font-medium text-slate-800 mb-3 italic leading-relaxed">"{notebook.insights.summary}"</p>
                                <div className="bg-purple-50 p-4 rounded-lg text-xs text-purple-800 border-l-4 border-purple-400 leading-relaxed"><strong>Advice:</strong> {notebook.insights.advice}</div>
                            </div>
                        )}
                        <SuperChart entries={notebook.entries} />
                    </div>

                    {/* RIGHT COL: HISTORY LIST */}
                    <div className="md:col-span-2 space-y-4">
                        <div className="flex justify-between items-end mb-2">
                            <h3 className="font-bold text-slate-500 uppercase text-xs tracking-wider">Attempt History</h3>
                            <select value={sortMode} onChange={(e) => setSortMode(e.target.value)} className="text-xs font-bold border border-slate-200 rounded-lg p-1.5 bg-white text-slate-600 outline-none focus:border-indigo-500">
                                <option value="dateDesc">Newest First</option>
                                <option value="dateAsc">Oldest First</option>
                                <option value="scoreDesc">Highest Score</option>
                                <option value="scoreAsc">Lowest Score</option>
                            </select>
                        </div>
                        
                        {getSortedEntries().map(entry => (
                            <div key={entry.id} className="bg-white rounded-xl border border-slate-200 hover:border-indigo-300 transition-all shadow-sm overflow-hidden group">
                                <div onClick={() => setExpandedEntryId(expandedEntryId === entry.id ? null : entry.id)} className="p-5 cursor-pointer flex justify-between items-start">
                                    <div>
                                        <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                            {entry.testName || "Untitled Test"}
                                            {expandedEntryId === entry.id ? <Icon name="ArrowUp" className="w-4 h-4 text-slate-400" /> : <Icon name="ArrowDown" className="w-4 h-4 text-slate-400" />}
                                        </h4>
                                        <p className="text-xs text-slate-400 font-medium mt-1">{new Date(entry.date).toLocaleString()} â€¢ {entry.type === 'IMAGE_IMPORT' ? 'Scanned' : 'Quiz'}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="text-right mr-2"><div className="text-2xl font-black text-indigo-600">{entry.score} <span className="text-sm text-slate-400 font-medium">/ {entry.maxMarks}</span></div></div>
                                        <button onClick={(e) => { e.stopPropagation(); setEditModalEntry(entry); }} className="p-2 text-slate-300 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all opacity-0 group-hover:opacity-100" title="Edit"><Icon name="Edit2" className="w-5 h-5" /></button>
                                        <button onClick={(e) => handleDeleteEntry(e, entry.id)} className="p-2 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100" title="Delete"><Icon name="Trash2" className="w-5 h-5" /></button>
                                    </div>
                                </div>
                                {expandedEntryId === entry.id && (
                                    <div className="bg-slate-50 p-5 border-t border-slate-100 animate-in slide-in-from-top-2">
                                        <div className="flex justify-between items-center mb-4">
                                            <h5 className="font-bold text-sm text-slate-700 uppercase">Analysis Preview</h5>
                                            <button onClick={() => setViewingEntry(entry)} className="bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-sm transition-all text-sm"><Icon name="BarChart" className="w-4 h-4" /> Open Full Analysis</button>
                                        </div>
                                        {entry.details && <div className="flex gap-1 flex-wrap">{entry.details.slice(0, 40).map((d, i) => <div key={i} className={`w-3 h-3 rounded-sm ${d.status === 'correct' ? 'bg-green-500' : d.status === 'wrong' ? 'bg-red-500' : 'bg-slate-300'}`} title={`Q${d.qNum}: ${d.status}`}></div>)}{entry.details.length > 40 && <span className="text-[10px] text-slate-400 font-medium pl-1">+{entry.details.length - 40} more</span>}</div>}
                                    </div>
                                )}
                            </div>
                        ))}
                        {(!notebook.entries || notebook.entries.length === 0) && <div className="text-center py-16 text-slate-400 bg-white rounded-xl border-2 border-dashed border-slate-200"><Icon name="BookOpen" className="w-12 h-12 mx-auto mb-3 text-slate-300" /><p>No entries yet.</p></div>}
                    </div>
                </div>
            </div>
        </div>
    );
};      // --- NEW COMPONENT: OFFICIAL EXAM HUB ---
const OfficialExamHub = ({ onStartTest, onBack, isBoss, setBossMode }) => {
    const [exams, setExams] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [studentName, setStudentName] = useState(localStorage.getItem("tattvam_student_name") || "");
const [secretCode, setSecretCode] = useState("");
const handleBossLogin = () => {
        if(secretCode === "tattvam123") { // <--- PASSWORD SETTING
            setBossMode(true);
            alert("ðŸ”“ BOSS MODE ACTIVATED");
        } else {
            alert("Wrong Code");
        }
    };

    // 1. Fetch the Exam List from GitHub
useEffect(() => {
        const fetchExams = async () => {
            setLoading(true);
            try {
                // 1. MAKE SURE THIS URL IS CORRECT!
                // If this is wrong, the app will normally crash. Now it will just show an error.
                const GITHUB_DB_URL = "https://raw.githubusercontent.com/kartikgupta29072008-wq/tattvam/refs/heads/main/database/exam_list.json";
                
                const res = await fetch(GITHUB_DB_URL + "?t=" + Date.now());
                
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                
                const data = await res.json();
                
                // ðŸ”´ CRASH PREVENTION CHECK ðŸ”´
                // We check if 'data' is actually a list (Array). If not, we stop.
                if (!Array.isArray(data)) {
                    throw new Error("Invalid Data Format: Expected a list of exams.");
                }

                setExams(data.filter(e => e.active)); 
                setError(null);

            } catch (e) {
                console.error("Exam Load Error:", e);
                // Instead of crashing white, we show a friendly message
                setError("Could not load exams. Please check your internet or the GitHub URL.");
                setExams([]); // Keep the list empty so the .map() function doesn't crash the UI
            }
            setLoading(false);
        };
        fetchExams();
    }, []);
    // 2. Handle Clicking "Start Exam"
    const handleStart = async (examMeta) => {
        if (!studentName.trim()) return alert("Please enter your name first!");
        
        // Save name for next time
        localStorage.setItem("tattvam_student_name", studentName);
        
        setLoading(true);
        try {
            // Fetch the actual test questions
            const res = await fetch(examMeta.url);
            if (!res.ok) throw new Error("Failed to download test paper");
            const testData = await res.json();
            
            // Mark this test as "OFFICIAL" so the Player knows to submit results
            const officialTest = {
                ...testData,
                isOfficial: true,       // FLAG: This triggers the upload logic
                officialMeta: examMeta, // Metadata
                studentName: studentName // The student's name
            };
            
            onStartTest(officialTest, examMeta.duration || 180);
        } catch (e) {
            alert("Error loading test: " + e.message);
        }
        setLoading(false);
    };

    return (
        <div className="h-full bg-slate-50 flex flex-col animate-in fade-in">
            {/* Header */}
            <div className="bg-slate-900 text-white p-6 shadow-md shrink-0">
                <div className="flex justify-between items-center mb-4">
                    <div>
                        <h2 className="text-2xl font-bold flex items-center gap-2"><Icon name="Flag" /> Official Testing Center</h2>
                        <p className="text-slate-400 text-sm">Live Examinations & Competitions</p>
                    </div>
                    <div className="flex gap-2">
                        {/* ONLY SHOW LOGIN IF NOT ALREADY BOSS */}
                        {!isBoss && (
                            <div className="flex gap-1">
                                <input 
                                    type="password" 
                                    placeholder="Code" 
                                    className="bg-slate-800 text-xs text-white p-2 rounded w-20 outline-none" 
                                    value={secretCode} 
                                    onChange={e => setSecretCode(e.target.value)} 
                                />
                                <button onClick={handleBossLogin} className="bg-slate-700 hover:bg-slate-600 px-2 rounded">
                                    <Icon name="Unlock" className="w-3 h-3" />
                                </button>
                            </div>
                        )}
                        
                        {/* SHOW BADGE IF BOSS */}
                        {isBoss && <span className="bg-red-600 text-white text-xs font-bold px-2 py-2 rounded animate-pulse">BOSS ACTIVE</span>}

                        <button onClick={onBack} className="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg font-bold text-sm">Exit</button>
                    </div>
                </div>
                
                {/* Name Input */}
                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700 max-w-md">
                    <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Candidate Name</label>
                    <input 
                        value={studentName} 
                        onChange={e => setStudentName(e.target.value)} 
                        placeholder="Enter your full name..." 
                        className="w-full bg-transparent border-none text-white font-bold outline-none placeholder-slate-600 focus:ring-0"
                    />
                </div>
            </div>

            {/* Exam List */}
            <div className="flex-1 overflow-y-auto p-6">
                {loading && (
                    <div className="text-center py-10">
                        <Icon name="Loader2" className="w-8 h-8 animate-spin mx-auto text-indigo-600" />
                        <p className="text-slate-500 mt-2 font-bold">Connecting to Server...</p>
                    </div>
                )}
                
                {error && <div className="text-red-500 text-center font-bold py-10">{error}</div>}

                {!loading && !error && exams.length === 0 && (
                    <div className="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                        <Icon name="Search" className="w-12 h-12 text-slate-300 mx-auto mb-3" />
                        <h3 className="text-lg font-bold text-slate-500">No Active Exams</h3>
                        <p className="text-slate-400 text-sm">Check back later for scheduled tests.</p>
                    </div>
                )}

                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {exams.map(exam => (
                        <div key={exam.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all group relative">
                            <div className="h-2 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                            <div className="p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <span className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-1"><div className="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div> Live</span>
                                    <span className="text-xs font-bold text-slate-400">{exam.date}</span>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">{exam.title}</h3>
                                <div className="flex items-center gap-4 text-sm text-slate-500 font-medium mb-6">
                                    <span className="flex items-center gap-1"><Icon name="Clock" className="w-4 h-4" /> {exam.duration} Mins</span>
                                    {exam.marks && <span className="flex items-center gap-1"><Icon name="Target" className="w-4 h-4" /> {exam.marks} Marks</span>}
                                </div>
                                <button 
                                    onClick={() => handleStart(exam)} 
                                    disabled={!studentName}
                                    className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 group-hover:scale-[1.02] transition-transform shadow-md"
                                >
                                    {studentName ? "Start Exam" : "Enter Name to Start"} <Icon name="ChevronRight" className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};  
        const Dashboard = ({ tests, notebooks, onCreateTest, onCreateNotebook, onDeleteTest, onDeleteNotebook, onSelectTest, onSelectNotebook, onSettings, onImport, appLogo, setAppLogo, onOpenOfficial }) => {
            const [tab, setTab] = useState('tests');
            const [page, setPage] = useState(0); 
            const ITEMS_PER_PAGE = 6;           
            
            const [importing, setImporting] = useState(false);
            const fileInputRef = useRef(null);
            const logoInputRef = useRef(null); 
            const [imgError, setImgError] = useState(false);

            useEffect(() => { setImgError(false); }, [appLogo]);
            useEffect(() => { setPage(0); }, [tab]);

            const currentList = tab === 'tests' ? tests : notebooks;
            const totalPages = Math.ceil(currentList.length / ITEMS_PER_PAGE);
            const displayedItems = currentList.slice(page * ITEMS_PER_PAGE, (page + 1) * ITEMS_PER_PAGE);

            const handleExportBackup = () => {
                const data = { tests, notebooks, appLogo }; 
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "tattvam_FULL_BACKUP_" + new Date().toISOString().slice(0, 10) + ".json");
                document.body.appendChild(node);
                node.click();
                node.remove();
            };

            const handleExportSingleTest = (e, test) => {
                e.stopPropagation();
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(test, null, 2));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                const filename = (test.title || "test").replace(/[^a-z0-9]/gi, '_').toLowerCase();
                node.setAttribute("download", `${filename}_test.json`);
                document.body.appendChild(node);
                node.click();
                node.remove();
            };

            const onFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setImporting(true);

                const reader = new FileReader();
                reader.onload = (event) => {
                    setTimeout(() => {
                        try {
                            const raw = event.target.result;
                            if (!raw) throw new Error("File is empty");
                            
                            let imported;
                            try { imported = JSON.parse(raw); } catch(e) { throw new Error("Invalid JSON syntax"); }
                            
                            // --- FIX APPLIED HERE ---
                            // Old buggy version: (val && typeof val === 'number' ...) -> This killed '0'
                            // New corrected version: Checks type strictly so 0 is allowed
                            const safeStr = (val, fallback) => (val && typeof val === 'string') ? val : fallback;
                            const safeNum = (val, fallback) => (typeof val === 'number' && !isNaN(val)) ? val : fallback;
                            const uuid = () => Math.random().toString(36).substring(2, 9) + Date.now().toString(36);

                            // 1. Sanitizers
                            const sanitizeQuestions = (qs) => {
                                if (!Array.isArray(qs)) return [];
                                return qs.filter(q => q && typeof q === 'object').map(q => ({
                                    id: safeStr(q.id, "q_" + uuid()),
                                    text: safeStr(q.text, "Corrupted Text"),
                                    type: ['SINGLE', 'MULTI', 'NUMERICAL', 'MATRIX'].includes(q.type) ? q.type : 'SINGLE',
                                    options: Array.isArray(q.options) ? q.options.filter(o => o).map(String) : [],
                                    correctIndex: safeNum(q.correctIndex, -1), // Now correctly accepts 0
                                    correctIndices: Array.isArray(q.correctIndices) ? q.correctIndices : [],
                                    correctNum: safeStr(q.correctNum, ""),
                                    marks: (q.marks && typeof q.marks === 'object') ? { pos: safeNum(q.marks.pos, 4), neg: safeNum(q.marks.neg, 1) } : { pos: 4, neg: 1 },
                                    diagram: safeStr(q.diagram, null), 
                                    explanation: safeStr(q.explanation, "")
                                }));
                            };

                            const sanitizeTests = (ts) => {
                                if (!Array.isArray(ts)) return [];
                                return ts.filter(t => t && typeof t === 'object').map(t => ({
                                    id: safeStr(t.id, "test_" + uuid()),
                                    title: safeStr(t.title, "Untitled Test"),
                                    created: safeStr(t.created, new Date().toISOString()),
                                    questions: sanitizeQuestions(t.questions)
                                }));
                            };

                            const sanitizeNotebooks = (nbs) => {
                                if (!Array.isArray(nbs)) return [];
                                return nbs.filter(n => n && typeof n === 'object').map(n => ({
                                    id: safeStr(n.id, "nb_" + uuid()),
                                    title: safeStr(n.title, "Untitled Notebook"),
                                    updated: safeStr(n.updated, new Date().toISOString()),
                                    entries: Array.isArray(n.entries) ? n.entries.filter(e => e).map(e => ({ ...e, id: safeStr(e.id, "entry_" + uuid()) })) : []
                                }));
                            };

                            // 2. Logic
                            let countTests = 0;
                            let countNotebooks = 0;

                            if (imported.tests || imported.notebooks) {
                                const safeTests = sanitizeTests(imported.tests);
                                const safeNotebooks = sanitizeNotebooks(imported.notebooks);
                                onImport(safeTests, safeNotebooks);
                                if(imported.appLogo && setAppLogo) setAppLogo(imported.appLogo); 
                                countTests = safeTests.length;
                                countNotebooks = safeNotebooks.length;
                            } 
                            else if (imported.title && (imported.questions || Array.isArray(imported.questions))) {
                                const newTest = {
                                    ...imported,
                                    id: "imported_single_" + uuid(),
                                    title: safeStr(imported.title, "Imported Test"),
                                    questions: sanitizeQuestions(imported.questions)
                                };
                                onImport([newTest], []);
                                countTests = 1;
                            } 
                            else if (Array.isArray(imported)) {
                                 const newTest = {
                                    id: "imported_list_" + uuid(),
                                    title: "Imported Questions " + new Date().toLocaleTimeString(),
                                    created: new Date().toISOString(),
                                    questions: sanitizeQuestions(imported)
                                 };
                                 onImport([newTest], []);
                                 countTests = 1;
                            }
                            else {
                                throw new Error("Structure unrecognized.");
                            }

                            setImporting(false);
                            alert(`âœ… Import Complete: ${countTests} Tests, ${countNotebooks} Notebooks.`);

                        } catch (err) { 
                            console.error("Critical Import Error:", err);
                            setImporting(false);
                            alert("âŒ Import Failed. Error: " + err.message); 
                        }
                    }, 100);
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setAppLogo(ev.target.result); 
                        setImgError(false);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="max-w-6xl mx-auto p-6 animate-in fade-in h-full flex flex-col font-sans relative">
                    
                    {importing && (
                        <div className="fixed inset-0 bg-white/90 backdrop-blur-sm z-[100] flex flex-col items-center justify-center cursor-wait">
                            <Icon name="Loader2" className="w-12 h-12 text-tattvam-600 animate-spin mb-4" />
                            <h3 className="text-xl font-bold text-slate-800">Processing Big Data...</h3>
                            <p className="text-slate-500 mt-2 text-sm">Do not close this window.</p>
                        </div>
                    )}

                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-slate-200 pb-6 shrink-0 gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
                                <div 
                                    onClick={() => logoInputRef.current.click()} 
                                    className="cursor-pointer relative group transition-transform active:scale-95"
                                    title="Click to Upload Custom Logo (Local Override)"
                                >
                                    {!imgError && appLogo ? (
                                        <img 
                                            src={appLogo} 
                                            onError={() => setImgError(true)} 
                                            className="w-12 h-12 object-contain rounded-lg shadow-sm border border-slate-200 bg-white" 
                                        />
                                    ) : (
                                        <div className="bg-tattvam-100 p-2 rounded-lg group-hover:bg-tattvam-200 transition-colors border border-tattvam-200">
                                            <Icon name="Atom" className="w-8 h-8 text-tattvam-600" />
                                        </div>
                                    )}
                                    <input type="file" ref={logoInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" />
                                </div>
                                <span className="tracking-tight">Tattvam</span>
                            </h1>
                            <p className="text-slate-500 mt-1 text-sm font-medium ml-1">Assessment & Analysis Suite </p>
                        </div>
                        
                        <div className="bg-slate-100 p-1 rounded-lg flex font-bold text-sm">
                            <button onClick={() => setTab('tests')} className={`px-4 py-2 rounded-md transition-all ${tab==='tests' ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}>My Tests</button>
                            <button onClick={() => setTab('analysis')} className={`px-4 py-2 rounded-md transition-all ${tab==='analysis' ? 'bg-white shadow text-slate-900' : 'text-slate-500'}`}>Analysis Notebooks</button>
                        </div>

                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={onFileChange} className="hidden" accept=".json" />
                            
                            <button onClick={() => fileInputRef.current.click()} className="p-2 text-slate-400 hover:text-indigo-600 bg-white border rounded-lg shadow-sm" title="Import JSON"><Icon name="Upload" className="w-5 h-5" /></button>
                            <button onClick={handleExportBackup} className="p-2 text-slate-400 hover:text-indigo-600 bg-white border rounded-lg shadow-sm" title="Export Backup"><Icon name="Download" className="w-5 h-5" /></button>
                            <button onClick={onSettings} className="p-2 text-slate-400 hover:text-tattvam-600 hover:bg-tattvam-50 rounded-full"><Icon name="Settings" className="w-6 h-6" /></button>
                            {/* OFFICIAL EXAMS BUTTON */}
{/* OFFICIAL EXAMS BUTTON */}
<button 
    onClick={onOpenOfficial} 
    className="flex items-center gap-2 bg-gradient-to-r from-slate-800 to-slate-900 text-white px-5 py-2.5 rounded-lg hover:shadow-lg font-medium shadow-sm border border-slate-700 transition-all"
>
    <Icon name="Flag" className="w-5 h-5 text-yellow-400" /> Official Exams
</button>

                            {tab === 'tests' ? (
                                <button onClick={onCreateTest} className="flex items-center gap-2 bg-tattvam-600 text-white px-5 py-2.5 rounded-lg hover:bg-tattvam-500 font-medium shadow-sm"><Icon name="Plus" className="w-5 h-5" /> New Test</button>
                            ) : (
                                <button onClick={onCreateNotebook} className="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-500 font-medium shadow-sm"><Icon name="BookOpen" className="w-5 h-5" /> New Notebook</button>
                            )}
                            
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto pb-10">
                        {/* PAGINATION CONTROLS */}
                        {totalPages > 1 && (
                            <div className="flex justify-between items-center mb-4 px-2">
                                <button 
                                    onClick={() => setPage(p => Math.max(0, p - 1))} 
                                    disabled={page === 0}
                                    className="px-4 py-2 bg-white border rounded-lg text-sm font-bold text-slate-600 disabled:opacity-50 hover:bg-slate-50"
                                >
                                    Previous
                                </button>
                                <span className="text-xs font-bold text-slate-400">Page {page + 1} of {totalPages}</span>
                                <button 
                                    onClick={() => setPage(p => Math.min(totalPages - 1, p + 1))} 
                                    disabled={page >= totalPages - 1}
                                    className="px-4 py-2 bg-white border rounded-lg text-sm font-bold text-slate-600 disabled:opacity-50 hover:bg-slate-50"
                                >
                                    Next
                                </button>
                            </div>
                        )}

                        {tab === 'tests' ? (
                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {displayedItems.map(test => (
                                    <div key={test.id} onClick={() => onSelectTest(test.id)} className="group bg-white rounded-xl p-6 shadow-sm border border-slate-200 hover:shadow-md hover:border-tattvam-300 cursor-pointer transition-all relative overflow-hidden h-48 flex flex-col">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="bg-tattvam-50 p-3 rounded-lg"><Icon name="FileText" className="w-6 h-6 text-tattvam-600" /></div>
                                            <div className="flex gap-1">
                                                <button onClick={(e) => handleExportSingleTest(e, test)} className="text-slate-300 hover:text-indigo-600 p-2 hover:bg-indigo-50 rounded-lg" title="Export"><Icon name="Download" className="w-4 h-4" /></button>
                                                <button onClick={(e) => onDeleteTest(e, test.id)} className="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg" title="Delete"><Icon name="Trash2" className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                        <h3 className="font-bold text-lg text-slate-800 mb-1 truncate">{test.title || "Untitled"}</h3>
                                        <p className="text-sm text-slate-400 mb-6">{new Date(test.created || Date.now()).toLocaleDateString()}</p>
                                        <div className="flex items-center justify-between mt-auto pt-4 border-t border-slate-50"><span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">{test.questions?.length || 0} Qs</span><span className="text-tattvam-600 text-sm font-semibold flex items-center gap-1 group-hover:translate-x-1 transition-transform">Open <Icon name="ArrowLeft" className="w-4 h-4 rotate-180" /></span></div>
                                    </div>
                                ))}
                                {displayedItems.length === 0 && <div className="col-span-full text-center py-20 text-slate-400 border-2 border-dashed rounded-xl">No tests found.</div>}
                            </div>
                        ) : (
                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {displayedItems.map(nb => (
                                    <div key={nb.id} onClick={() => onSelectNotebook(nb.id)} className="group bg-white rounded-xl p-6 shadow-sm border border-slate-200 hover:shadow-md hover:border-indigo-300 cursor-pointer transition-all relative overflow-hidden h-48 flex flex-col">
                                        <div className="flex justify-between items-start mb-4"><div className="bg-indigo-50 p-3 rounded-lg"><Icon name="Grid" className="w-6 h-6 text-indigo-600" /></div><button onClick={(e) => onDeleteNotebook(e, nb.id)} className="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg"><Icon name="Trash2" className="w-4 h-4" /></button></div>
                                        <h3 className="font-bold text-lg text-slate-800 mb-1 truncate">{nb.title || "Untitled"}</h3>
                                        <p className="text-sm text-slate-400 mb-6">Updated: {new Date(nb.updated || Date.now()).toLocaleDateString()}</p>
                                        <div className="flex items-center justify-between mt-auto pt-4 border-t border-slate-50"><span className="text-xs font-bold text-indigo-800 bg-indigo-100 px-2 py-1 rounded">{nb.entries?.length || 0} Entries</span><span className="text-indigo-600 text-sm font-semibold flex items-center gap-1 group-hover:translate-x-1 transition-transform">Analyze <Icon name="ArrowLeft" className="w-4 h-4 rotate-180" /></span></div>
                                    </div>
                                ))}
                                {displayedItems.length === 0 && <div className="col-span-full text-center py-20 text-slate-400 border-2 border-dashed rounded-xl">No notebooks found.</div>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };const MarksDistributor = ({ onClose, onApply, loading }) => {
            const [prompt, setPrompt] = useState('');
            
            const presets = [
                { label: "JEE Main Standard", val: "All questions +4, -1" },
                { label: "JEE Adv (Paper 1)", val: "Single Correct +3/-1, Multi Correct +4/-2, Numerical +3/0" },
                { label: "NEET Pattern", val: "All questions +4, -1" },
                { label: "Hard Weighted", val: "Hard questions +5/-2, Medium +4/-1, Easy +3/0" },
                { label: "No Negatives", val: "Keep positive marks same, but set all negative marks to 0" }
            ];

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4 animate-in zoom-in-95">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col">
                        <div className="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 flex justify-between items-center text-white">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="Sparkles" /> AI Marks Alloter</h3>
                            <button onClick={onClose} className="hover:bg-white/20 p-1 rounded"><Icon name="X" /></button>
                        </div>
                        
                        <div className="p-6 space-y-4 bg-slate-50">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Quick Presets</label>
                                <div className="flex flex-wrap gap-2">
                                    {presets.map((p, i) => (
                                        <button key={i} onClick={() => setPrompt(p.val)} className="text-[10px] font-bold bg-white border border-slate-200 px-2 py-1.5 rounded-lg hover:border-emerald-500 hover:text-emerald-700 transition-colors shadow-sm">
                                            {p.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Custom Instruction</label>
                                <textarea 
                                    value={prompt} 
                                    onChange={e => setPrompt(e.target.value)} 
                                    className="w-full h-32 p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm shadow-inner"
                                    placeholder="e.g. 'Give 10 marks to Matrix Match questions and 2 marks to everything else' or 'Make negative marking 25% of positive marks for all questions'."
                                />
                            </div>

                            <button 
                                onClick={() => onApply(prompt)} 
                                disabled={loading || !prompt} 
                                className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 disabled:opacity-50 flex justify-center items-center gap-2 shadow-lg hover:shadow-xl transition-all"
                            >
                                {loading ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="Wand2" />}
                                Auto-Assign Marks
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
// --- NEW: SMART ANSWER KEY SCANNER MODAL ---
        const SmartKeyScanner = ({ onClose, onApply, apiKey }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [instructions, setInstructions] = useState("");
            const [keyStart, setKeyStart] = useState(1);
            const [targetStart, setTargetStart] = useState(1);
            const [scanning, setScanning] = useState(false);

            const handleFile = (e) => {
                const f = e.target.files[0];
                if (f) {
                    setFile(f);
                    setPreview(URL.createObjectURL(f));
                }
            };

            const handleScan = async () => {
                if (!file || !apiKey) return;
                setScanning(true);
                try {
                    const b64 = await fileToBase64(file);
                    
                    // 1. Enhanced Prompt with User Instructions
                    const prompt = `Act as an Answer Key Reader.
                    Task: Extract question numbers and their correct answers from this image.
                    
                    User Special Instructions: "${instructions || "None. Scan all standard columns."}"
                    
                    Rules:
                    1. Identify the Question Number (e.g., "41", "Q.1", "1") and the Answer (e.g., "A", "B", "4", "ABCD").
                    2. If the answer is numerical, return it as a string (e.g. "5.5").
                    3. Output a flat JSON object mapping Question Number -> Answer.
                    
                    Output JSON Example:
                    { "1": "A", "31": "C", "32": ["A","B"] }`;

                    const result = await apiCall(apiKey, prompt, b64);
                    
                    // 2. Pass result and mapping configuration back to Editor
                    onApply(result, { keyStart: Number(keyStart), targetStart: Number(targetStart) });
                    onClose();
                    
                } catch (e) {
                    alert("Scan Failed: " + e.message);
                }
                setScanning(false);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        {/* Header */}
                        <div className="bg-slate-900 p-4 text-white flex justify-between items-center shrink-0">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="ListChecks" /> Smart Key Scanner</h3>
                            <button onClick={onClose}><Icon name="X" /></button>
                        </div>

                        {/* Scrollable Content */}
                        <div className="p-6 overflow-y-auto space-y-5">
                            
                            {/* 1. File Upload */}
                            <div className="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:bg-slate-50 transition-colors relative">
                                {preview ? (
                                    <div className="relative h-48 w-full">
                                        <img src={preview} className="w-full h-full object-contain rounded-lg" />
                                        <button onClick={() => { setFile(null); setPreview(null); }} className="absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full shadow-md hover:bg-red-700"><Icon name="X" className="w-4 h-4" /></button>
                                    </div>
                                ) : (
                                    <label className="cursor-pointer block py-8">
                                        <Icon name="Upload" className="w-10 h-10 text-slate-400 mx-auto mb-2" />
                                        <span className="text-sm font-bold text-slate-600 block">Click to Upload Answer Key</span>
                                        <span className="text-xs text-slate-400">Supports JPG, PNG, Screenshots</span>
                                        <input type="file" className="hidden" accept="image/*" onChange={handleFile} />
                                    </label>
                                )}
                            </div>

                            {/* 2. Instructions */}
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">AI Instructions (Optional)</label>
                                <textarea 
                                    value={instructions}
                                    onChange={e => setInstructions(e.target.value)}
                                    placeholder="e.g. 'Read only the Physics section', 'Ignore questions crossed out', 'Format is 1-A'"
                                    className="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-20 bg-slate-50"
                                />
                            </div>

                            {/* 3. Mapping Logic */}
                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                <h4 className="text-sm font-bold text-indigo-900 mb-3 flex items-center gap-2"><Icon name="Settings" className="w-4 h-4" /> Offset Mapping</h4>
                                <div className="flex items-center gap-4">
                                    <div className="flex-1">
                                        <label className="text-xs font-bold text-indigo-700 block mb-1">Key Starts At</label>
                                        <input 
                                            type="number" 
                                            value={keyStart} 
                                            onChange={e => setKeyStart(e.target.value)}
                                            className="w-full p-2 border border-indigo-200 rounded text-center font-mono font-bold" 
                                        />
                                    </div>
                                    <Icon name="ArrowLeft" className="w-5 h-5 text-indigo-400 rotate-180" />
                                    <div className="flex-1">
                                        <label className="text-xs font-bold text-indigo-700 block mb-1">Apply to Q#</label>
                                        <input 
                                            type="number" 
                                            value={targetStart} 
                                            onChange={e => setTargetStart(e.target.value)}
                                            className="w-full p-2 border border-indigo-200 rounded text-center font-mono font-bold" 
                                        />
                                    </div>
                                </div>
                                <p className="text-[10px] text-indigo-600 mt-2 leading-tight">
                                    Example: If the key image shows <strong>Q.41</strong>, but you want to apply that answer to your <strong>Q.1</strong>, set "Key Starts At" to 41 and "Apply to Q#" to 1.
                                </p>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t bg-slate-50 flex justify-end">
                            <button 
                                onClick={handleScan} 
                                disabled={!file || scanning}
                                className="bg-tattvam-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-tattvam-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm"
                            >
                                {scanning ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="BrainCircuit" />}
                                {scanning ? "Analyzing..." : "Scan & Apply"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
const Editor = ({ test, onUpdateTest, onBack, onPlay, onPrint, apiKey, onRequestKey, onRemix, isBoss }) => {
            // --- STATE MANAGEMENT ---
            const [proc, setProc] = useState(false);
            const [step, setStep] = useState('');
            const [editId, setEditId] = useState(null);
            const [guide, setGuide] = useState(null);
            const [guideLoad, setGuideLoad] = useState(false);
            const [manvanchit, setManvanchit] = useState(false);
            const [showMarksModal, setShowMarksModal] = useState(false);
            const [marksLoad, setMarksLoad] = useState(false);
            const [showKeyScanner, setShowKeyScanner] = useState(false);
            
            // --- SELECTION / REMIX MODE STATE ---
            const [selectMode, setSelectMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());

            // --- LOGIC ---
            const moveQuestion = (index, direction) => {
                if ((direction === -1 && index === 0) || (direction === 1 && index === test.questions.length - 1)) return;
                const newQs = [...test.questions];
                const temp = newQs[index];
                newQs[index] = newQs[index + direction];
                newQs[index + direction] = temp;
                onUpdateTest({ questions: newQs });
            };

            const handleAIMarks = async (userPrompt) => {
                if(!apiKey) return onRequestKey();
                if(!userPrompt.trim()) return;
                setMarksLoad(true);
                try {
                    const mapping = await generateMarksMapping(test.questions, userPrompt, apiKey);
                    const updatedQuestions = test.questions.map(q => {
                        const newMarks = mapping[q.id.toString()] || mapping[q.id]; 
                        if (newMarks) return { ...q, marks: { pos: newMarks.pos, neg: newMarks.neg } };
                        return q;
                    });
                    onUpdateTest({ questions: updatedQuestions });
                    setShowMarksModal(false);
                    alert("Marks updated successfully!");
                } catch (e) { alert("AI Error: " + e.message); }
                setMarksLoad(false);
            };

            // Selection Logic
            const toggleSelect = (id) => {
                const newSet = new Set(selectedIds);
                if(newSet.has(id)) newSet.delete(id);
                else newSet.add(id);
                setSelectedIds(newSet);
            };

            const createSubTest = () => {
                const selectedQs = test.questions.filter(q => selectedIds.has(q.id));
                if(selectedQs.length === 0) return alert("Select at least one question.");
                
                const newTest = {
                    id: Date.now().toString(),
                    title: `Remix: ${test.title}`,
                    created: new Date().toISOString(),
                    questions: selectedQs
                };
                // Use the Direct Remix handler passed from Parent
                onRemix(newTest);
                setSelectMode(false);
                setSelectedIds(new Set());
            };

            // --- BATCH PROCESSORS ---
            useEffect(() => {
                const handlePaste = async (e) => {
                    if (proc || editId) return;
                    const items = e.clipboardData?.items;
                    if (!items) return;
                    const images = [];
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) images.push(items[i].getAsFile());
                    }
                    if (images.length > 0) {
                        e.preventDefault();
                        if(confirm(`Detected ${images.length} image(s) in clipboard. Add to test?`)) processFiles(images);
                    }
                };
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, [proc, editId, apiKey]);

            const processFiles = async (files) => {
                if (!apiKey) return onRequestKey();
                setProc(true);
                try {
                    const newQuestions = [];
                    for (let i = 0; i < files.length; i++) {
                        setStep(`Analyzing Image ${i + 1} of ${files.length}...`);
                        const b64 = await fileToBase64(files[i]);
                        const data = await transcribeImage(b64, apiKey); 
                        const processed = data.map(q => ({ 
                            ...q, id: Math.random(), correctIndex: q.correctIndex ?? -1, correctIndices: q.correctIndices ?? [], 
                            correctNum: q.correctNum ?? '', matrixAns: q.matrixAns ?? {}, explanation: q.explanation ?? '' 
                        }));
                        newQuestions.push(...processed);
                    }
                    onUpdateTest({ questions: [...test.questions, ...newQuestions] });
                } catch (err) { alert("Error processing images: " + err.message); }
                setProc(false);
                setStep('');
            };

            const handleUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length) processFiles(files);
                e.target.value = null; 
            };

            const handleSmartKeyApply = (extractedData, config) => {
                const { keyStart, targetStart } = config;
                const updatedQuestions = test.questions.map((q, index) => {
                    const expectedKeyNum = (index + 1) - targetStart + keyStart;
                    const keyString = expectedKeyNum.toString();
                    const keyVal = extractedData[keyString]; 
                    if (!keyVal) return q; 
                    let updates = {};
                    const toIdx = (char) => {
                        if (typeof char !== 'string') return -1;
                        const code = char.trim().toUpperCase().charCodeAt(0);
                        return (code >= 65 && code <= 90) ? code - 65 : -1;
                    };
                    if (q.type === 'SINGLE') {
                        const idx = toIdx(Array.isArray(keyVal) ? keyVal[0] : keyVal);
                        if (idx !== -1) updates.correctIndex = idx;
                    } else if (q.type === 'MULTI') {
                        const valArray = Array.isArray(keyVal) ? keyVal : [keyVal];
                        const indices = valArray.map(toIdx).filter(i => i !== -1);
                        if (indices.length > 0) updates.correctIndices = indices;
                    } else if (q.type === 'NUMERICAL') {
                        updates.correctNum = keyVal.toString();
                    }
                    return { ...q, ...updates };
                });
                const count = updatedQuestions.filter((q, i) => q !== test.questions[i]).length;
                onUpdateTest({ questions: updatedQuestions });
                alert(`âœ… Smart Update Complete!\nMatched & Updated ${count} questions.`);
            };

            const makeGuide = async () => {
                if (!apiKey) return onRequestKey();
                setGuideLoad(true);
                try { setGuide(await generateGuide(test.questions, apiKey)); } catch (e) { alert(e.message); }
                setGuideLoad(false);
            };
// ... deleteQ function ends here ...

const handlePublish = async () => {
        // 1. USE HARDCODED TOKEN DIRECTLY
        const token = HARDCODED_GITHUB_TOKEN; 
        
        if (!token) {
            alert("Error: No hardcoded token found in code.");
            return;
        }

        // 2. Identify filename automatically
        let filename = "unknown.json";
        if (test.officialMeta && test.officialMeta.url) {
            filename = test.officialMeta.url.split('/').pop(); 
        } else {
            filename = prompt("Filename not found. Enter filename (e.g. mock1.json):");
        }
        if(!filename) return;

        // 3. Upload immediately
        alert("â˜ï¸ Auto-Publishing to GitHub...");
        
        const success = await uploadToGitHub(test, token, filename);
        
        if (success) {
            alert("âœ… SUCCESS! Test updated automatically.");
            onBack(); 
        }
    };
            return (
                <div className="h-screen flex flex-col bg-slate-50">
                    {guide && <StudyGuideModal content={guide} onClose={() => setGuide(null)} />}
                    {manvanchit && <ManvanchitModal onClose={() => setManvanchit(false)} apiKey={apiKey} onImport={(q) => onUpdateTest({ questions: [...test.questions, ...q] })} />}
                    {showKeyScanner && <SmartKeyScanner apiKey={apiKey} onClose={() => setShowKeyScanner(false)} onApply={handleSmartKeyApply} />}
                    {showMarksModal && <MarksDistributor onClose={() => setShowMarksModal(false)} onApply={handleAIMarks} loading={marksLoad} />}
                    
                    {/* --- HEADER TOOLBAR (RESTORED OLD UI) --- */}
                    <div className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-30 shadow-sm shrink-0">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><Icon name="ArrowLeft" className="w-5 h-5" /></button>
                            <input value={test.title} onChange={e => onUpdateTest({ title: e.target.value })} className="text-xl font-bold text-slate-900 border-none focus:ring-0 p-0 w-64 bg-transparent" placeholder="Test Title..." />
                        </div>
                        
                        <div className="flex gap-2">
                            {/* NEW: Selection / Remix Mode Toggle */}
                            {selectMode ? (
                                <>
                                    <button onClick={createSubTest} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-bold shadow-sm animate-in fade-in">
                                        <Icon name="Plus" className="w-4 h-4" /> Create Test ({selectedIds.size})
                                    </button>
                                    <button onClick={() => {setSelectMode(false); setSelectedIds(new Set());}} className="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-300">
                                        Cancel
                                    </button>
                                </>
                            ) : (
                                <>
                                    {/* Normal Mode: Full Button List Restored */}
                                    <button onClick={() => setSelectMode(true)} className="flex items-center gap-2 bg-purple-50 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-100 font-medium border border-purple-100 transition-colors">
                                        <Icon name="ListChecks" className="w-4 h-4" /> Select/Remix
                                    </button>
                                    
                                    <div className="w-px h-8 bg-slate-200 mx-1"></div>

                                    <button onClick={() => setShowKeyScanner(true)} disabled={!test.questions.length} className="flex items-center gap-2 bg-amber-100 text-amber-800 px-4 py-2 rounded-lg hover:bg-amber-200 font-bold border border-amber-200">
                                        <Icon name="ListChecks" className="w-4 h-4" /> Scan Key
                                    </button>
                                    
                                    <button onClick={() => setManvanchit(true)} className="flex items-center gap-2 bg-tattvam-900 text-white px-4 py-2 rounded-lg hover:bg-tattvam-800 font-medium border border-slate-700 shadow-sm">
                                        <Icon name="BrainCircuit" className="w-4 h-4" /> MANVANCHIT
                                    </button>
                                    
                                    <button onClick={makeGuide} disabled={guideLoad || !test.questions.length} className="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-100 font-medium">
                                        {guideLoad ? <Icon name="Loader2" className="w-4 h-4 animate-spin" /> : <Icon name="Sparkles" className="w-4 h-4" />} Guide
                                    </button>
                                    
                                    <button onClick={() => setShowMarksModal(true)} className="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-4 py-2 rounded-lg hover:bg-emerald-100 font-medium border border-emerald-100">
                                        <Icon name="Target" className="w-4 h-4" /> Marks
                                    </button>
                                    {isBoss && test.isBossDraft && (
                        <button 
                            onClick={handlePublish} 
                            className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 animate-pulse shadow-lg flex items-center gap-2"
                        >
                            <Icon name="Cloud" /> PUBLISH LIVE
                        </button>
                    )}
                                    <button onClick={onPrint} className="flex items-center gap-2 bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200 font-medium">
                                        <Icon name="Printer" className="w-4 h-4" /> Print
                                    </button>
                                    
                                    <button onClick={onPlay} disabled={!test.questions.length} className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 disabled:opacity-50 font-medium shadow-sm">
                                        <Icon name="Play" className="w-4 h-4" /> Quiz
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {/* --- MAIN WORKSPACE --- */}
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full">
                        {proc && (
                            <div className="fixed inset-0 bg-white/80 backdrop-blur-[2px] z-50 flex flex-col items-center justify-center">
                                <Icon name="Loader2" className="w-10 h-10 text-tattvam-600 animate-spin mb-3" />
                                <p className="text-lg font-bold text-slate-700 animate-pulse">{step}</p>
                            </div>
                        )}

                       <div className="mb-8">
                            <div 
                                className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-xl transition-all outline-none focus:ring-2 focus:ring-tattvam-500 focus:border-transparent cursor-default relative overflow-hidden ${proc ? 'bg-indigo-50 border-indigo-300' : 'bg-white border-slate-300 hover:border-indigo-500 hover:bg-slate-50'}`}
                                tabIndex={0}
                                onClick={(e) => e.currentTarget.focus()}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={(e) => {
                                    e.preventDefault();
                                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                                    if(files.length) processFiles(files);
                                }}
                                onPaste={(e) => {
                                    const items = e.clipboardData?.items;
                                    if (!items) return;
                                    const files = [];
                                    for (let i = 0; i < items.length; i++) {
                                        if (items[i].type.indexOf('image') !== -1) {
                                            files.push(items[i].getAsFile());
                                        }
                                    }
                                    if (files.length) {
                                        e.preventDefault();
                                        processFiles(files);
                                    }
                                }}
                            >
                                <Icon name="Upload" className="w-8 h-8 text-slate-300 mb-2 pointer-events-none" />
                                <p className="text-sm text-slate-600 font-medium text-center pointer-events-none mb-3 leading-tight">
                                    <span className="font-bold text-slate-700">Drag & Drop</span> Question Pages<br/>
                                    or <span className="font-bold text-slate-500">Ctrl+V</span> to Paste
                                </p>
                                <label className="pointer-events-auto cursor-pointer bg-white border border-slate-200 text-slate-600 text-xs px-4 py-2 rounded-lg font-bold hover:bg-indigo-600 hover:text-white hover:border-indigo-600 transition-all shadow-sm flex items-center gap-2">
                                    <Icon name="Plus" className="w-3.5 h-3.5" /> Select Images
                                    <input type="file" className="hidden" multiple accept="image/*" onChange={handleUpload} />
                                </label>
                            </div>
                        </div>

                        <div className="space-y-6">
                            {test.questions.map((q, idx) => (
                                <div key={q.id} className={`relative transition-all ${selectMode ? 'pl-10' : ''}`}>
                                    {/* Selection Checkbox */}
                                    {selectMode && (
                                        <div className="absolute left-0 top-6 animate-in slide-in-from-left-4 fade-in">
                                            <input 
                                                type="checkbox" 
                                                checked={selectedIds.has(q.id)} 
                                                onChange={() => toggleSelect(q.id)} 
                                                className="w-6 h-6 accent-indigo-600 cursor-pointer shadow-sm" 
                                            />
                                        </div>
                                    )}

                                    {editId === q.id ? 
                                        <QuestionEditor 
                                            question={q} 
                                            onSave={u => { onUpdateTest({ questions: test.questions.map(qt => qt.id === u.id ? u : qt) }); setEditId(null); }} 
                                            onCancel={() => setEditId(null)} 
                                            apiKey={apiKey} 
                                            onRequestKey={onRequestKey} 
                                        /> 
                                        :
                                        <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden group hover:border-tattvam-200 transition-all ${selectMode && selectedIds.has(q.id) ? 'ring-2 ring-indigo-500 border-indigo-500 bg-indigo-50/10' : ''}`}>
                                            <div className="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Q{idx + 1}</span>
                                                    {q.pyq_tag && <span className="text-[10px] bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full font-bold border border-amber-200">{q.pyq_tag}</span>}
                                                    <span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-bold">{q.type || 'SINGLE'}</span>
                                                    {q.difficulty && <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${q.difficulty === 'Easy' ? 'bg-green-100 text-green-700' : q.difficulty === 'Hard' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>{q.difficulty}</span>}
                                                    <span className="text-[10px] font-mono text-slate-400">+{q.marks?.pos||4} / -{q.marks?.neg||1}</span>
                                                </div>
                                                <div className="flex gap-1 items-center">
                                                    <button onClick={() => moveQuestion(idx, -1)} disabled={idx === 0} className="text-slate-400 hover:text-indigo-600 p-1 rounded disabled:opacity-20"><Icon name="ArrowUp" className="w-4 h-4" /></button>
                                                    <button onClick={() => moveQuestion(idx, 1)} disabled={idx === test.questions.length - 1} className="text-slate-400 hover:text-indigo-600 p-1 rounded disabled:opacity-20"><Icon name="ArrowDown" className="w-4 h-4" /></button>
                                                    <div className="w-px h-4 bg-slate-300 mx-1"></div>
                                                    <button onClick={() => setEditId(q.id)} className="text-slate-400 hover:text-tattvam-600 p-1.5 hover:bg-tattvam-50 rounded"><Icon name="Edit2" className="w-4 h-4" /></button>
                                                    <button onClick={() => onUpdateTest({ questions: test.questions.filter(qt => qt.id !== q.id) })} className="text-slate-400 hover:text-red-500 p-1.5 hover:bg-red-50 rounded"><Icon name="Trash2" className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                            <div className="p-5 flex gap-6">
                                                <div className="flex-1">
                                                    <div className="font-medium text-slate-800 mb-4 text-lg"><LatexRenderer content={q.text} /></div>
                                                    {(q.type === 'SINGLE' || q.type === 'MULTI' || !q.type) && (
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                            {q.options?.map((opt, oIdx) => (
                                                                <div key={oIdx} className={`flex items-start gap-3 text-sm p-2 rounded-lg border ${ (q.type==='SINGLE'?q.correctIndex===oIdx:q.correctIndices?.includes(oIdx)) ? 'bg-green-50 border-green-200 text-green-800' : 'border-transparent text-slate-600'}`}>
                                                                    <span className={`font-mono text-xs mt-0.5 w-5 h-5 flex items-center justify-center rounded-full flex-shrink-0 border ${ (q.type==='SINGLE'?q.correctIndex===oIdx:q.correctIndices?.includes(oIdx)) ? 'border-green-600 bg-green-600 text-white' : 'border-slate-300'}`}>
                                                                        {String.fromCharCode(65 + oIdx)}
                                                                    </span>
                                                                    {opt.startsWith('CHEM:') ? <AutoChemicalRenderer text={opt} /> : <LatexRenderer content={opt} />}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {q.type === 'NUMERICAL' && <div className="bg-blue-50 p-2 rounded text-blue-800 text-sm font-bold">Answer: {q.correctNum}</div>}
                                                {/* --- FIX: MATRIX VISIBILITY IN EDITOR LIST --- */}
{q.type === 'MATRIX' && q.matrix && (
    <div className="mt-4 pt-3 border-t border-dashed border-slate-200">
        <div className="grid grid-cols-2 gap-6">
            {/* Rows Display */}
            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                <h6 className="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mb-2 border-b border-indigo-100 pb-1">
                    Column I (Rows)
                </h6>
                <div className="space-y-2">
                    {q.matrix.rows?.length > 0 ? (
                        q.matrix.rows.map((r, i) => (
                            <div key={i} className="flex gap-2 text-sm items-start">
                                <span className="font-bold text-slate-400 text-xs w-4 pt-0.5">{String.fromCharCode(65+i)}.</span>
                                <div className="text-slate-700 leading-tight font-medium">
                                    <LatexRenderer content={r || "(Empty Row)"} />
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-xs text-red-400 italic">No rows added yet.</div>
                    )}
                </div>
            </div>

            {/* Columns Display */}
            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                <h6 className="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mb-2 border-b border-indigo-100 pb-1">
                    Column II (Cols)
                </h6>
                <div className="space-y-2">
                    {q.matrix.cols?.length > 0 ? (
                        q.matrix.cols.map((c, i) => (
                            <div key={i} className="flex gap-2 text-sm items-start">
                                <span className="font-bold text-slate-400 text-xs w-4 pt-0.5">{i+1}.</span>
                                <div className="text-slate-700 leading-tight font-medium">
                                    <LatexRenderer content={c || "(Empty Col)"} />
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-xs text-red-400 italic">No columns added yet.</div>
                    )}
                </div>
            </div>
        </div>

        {/* Answer Key Preview */}
        <div className="mt-3 flex flex-wrap gap-2 text-xs">
            <span className="font-bold text-slate-400 py-1">Correct Matches:</span>
            {Object.entries(q.matrixAns || {}).length > 0 ? (
                Object.entries(q.matrixAns || {}).map(([r, cols]) => (
                    <span key={r} className="bg-green-100 text-green-800 border border-green-200 px-2 py-1 rounded font-mono font-bold">
                        {String.fromCharCode(65 + parseInt(r))} &rarr; {(cols || []).map(c => c + 1).join(',')}
                    </span>
                ))
            ) : (
                <span className="text-slate-400 italic py-1">No answers mapped.</span>
            )}
        </div>
    </div>
)}
                                                </div>
                                                {q.diagram && <div className="w-32 md:w-48 flex-shrink-0"><img src={q.diagram} className="rounded-lg border border-slate-200 w-full h-auto object-contain" /></div>}
                                            </div>
                                        </div>
                                    }
                                </div>
                            ))}
                            {test.questions.length === 0 && !proc && <div className="text-center py-8 text-slate-400">No questions. Upload images to begin.</div>}
                        </div>
                    </div>
                </div>
            );
        };
     // --- NEW: ADVANCED RESULT DASHBOARD (UNIFIED) ---
// --- UPDATED RESULT DASHBOARD (With Inline Notebook Creation) ---
// --- UPDATED RESULT DASHBOARD (With Answer Key Fixing) ---
// --- COMPLETE & UPDATED RESULT DASHBOARD ---
// --- COMPLETE & UPDATED RESULT DASHBOARD (Fixes Text Sync Issue) ---
const ResultDashboard = ({ entry, onBack, onSave, savedNotebooks, onCreateNotebook, onUpdateEntry, allTests }) => {
    // Local state to handle immediate updates (Fix Key / Sync)
    const [localEntry, setLocalEntry] = useState(entry);
    
    // UI States
    const [tab, setTab] = useState('overview'); 
    const [filter, setFilter] = useState('all'); 
    const [saveModal, setSaveModal] = useState(false);
    
    // Notebook Creation States
    const [isCreating, setIsCreating] = useState(false);
    const [newNbTitle, setNewNbTitle] = useState("");

    // Fix Key Modal States
    const [fixingQ, setFixingQ] = useState(null); 
    const [fixValue, setFixValue] = useState("");

    // Re-sync local state if prop changes
    useEffect(() => { setLocalEntry(entry); }, [entry]);

    // --- METRICS CALCULATION ---
    const totalQ = localEntry.details.length;
    const correctCount = localEntry.details.filter(d => d.status === 'correct').length;
    const wrongCount = localEntry.details.filter(d => d.status === 'wrong').length;
    const partialCount = localEntry.details.filter(d => d.status === 'partial').length;
    const leftCount = localEntry.details.filter(d => ['left','not_visited','Unattempted'].includes(d.status)).length;
    
    const negMarksLost = localEntry.details.reduce((acc, d) => (d.marks < 0 ? acc + Math.abs(d.marks) : acc), 0);
    const totalTime = localEntry.details.reduce((acc, d) => acc + (d.timeSpent || 0), 0);
    const avgTime = Math.round(totalTime / (totalQ || 1));
    const timeWasted = localEntry.details.filter(d => d.status === 'wrong').reduce((acc, d) => acc + (d.timeSpent || 0), 0);
    
    const typeStats = localEntry.details.reduce((acc, d) => {
        const t = d.qData?.type || 'SINGLE';
        if (!acc[t]) acc[t] = { total: 0, correct: 0, score: 0 };
        acc[t].total++;
        if (d.status === 'correct') acc[t].correct++;
        acc[t].score += d.marks;
        return acc;
    }, {});

    // --- LOGIC 1: SYNC WITH MASTER TEST (FIXED) ---
    const masterTest = allTests ? allTests.find(t => t.id === localEntry.testId) : null;
    
    const handleSyncWithMaster = () => {
        if (!masterTest) return;
        if (!confirm(`Update this result using the latest data from "${masterTest.title}"?\n\nThis will update question text, options, and re-calculate scores.`)) return;

        const updatedDetails = localEntry.details.map(d => {
            // Find live question
            const liveQ = masterTest.questions.find(mq => mq.id === d.qData.id);
            if (!liveQ) return d; // If deleted from master, keep existing

            // Recalculate Score
            let newStatus = 'left';
            let newScore = 0;
            const pos = liveQ.marks?.pos || 4;
            const neg = liveQ.marks?.neg || 1;
            const userAns = d.userAns;

            // Helper to check if answered
            const isAnswered = userAns !== undefined && userAns !== "" && (!Array.isArray(userAns) || userAns.length > 0);

            if (isAnswered) {
                if (liveQ.type === 'NUMERICAL') {
                    if (String(userAns).trim() === String(liveQ.correctNum).trim()) { newStatus = 'correct'; newScore = pos; }
                    else { newStatus = 'wrong'; newScore = -neg; }
                } 
                else if (liveQ.type === 'MULTI') {
                    const correctIndices = liveQ.correctIndices || [];
                    const selected = userAns || [];
                    const hasWrong = selected.some(s => !correctIndices.includes(s));
                    if (hasWrong) { newStatus = 'wrong'; newScore = -neg; }
                    else if (selected.length === correctIndices.length) { newStatus = 'correct'; newScore = pos; }
                    else { newStatus = 'partial'; newScore = selected.length; }
                }
                else { // SINGLE
                    if (userAns === liveQ.correctIndex) { newStatus = 'correct'; newScore = pos; }
                    else { newStatus = 'wrong'; newScore = -neg; }
                }
            }

            return {
                ...d,
                text: liveQ.text, // <--- FIXED: Updates the visible question text
                qData: liveQ,     // Updates options, diagrams, answer key
                status: newStatus,
                marks: newScore
            };
        });

        // Recalculate Totals
        const newTotal = updatedDetails.reduce((acc, d) => acc + d.marks, 0);
        const newMax = updatedDetails.reduce((acc, d) => acc + (d.qData.marks?.pos || 0), 0);

        const newEntry = {
            ...localEntry,
            testName: masterTest.title,
            score: newTotal,
            maxMarks: newMax,
            details: updatedDetails
        };

        setLocalEntry(newEntry);
        if (onUpdateEntry) onUpdateEntry(newEntry);
        alert("âœ… Result & Questions Synchronized!");
    };

    // --- LOGIC 2: MANUAL FIX KEY ---
    const handleSaveFix = () => {
        if (!fixingQ) return;
        const updatedDetails = localEntry.details.map(d => {
            if (d.id !== fixingQ.id) return d;
            
            const newQData = { ...d.qData };
            let newStatus = 'left';
            let newScore = 0;
            const pos = newQData.marks?.pos || 4;
            const neg = newQData.marks?.neg || 1;

            if (fixingQ.type === 'NUMERICAL') {
                newQData.correctNum = fixValue;
                if (d.userAns && String(d.userAns).trim() === String(fixValue).trim()) { newStatus = 'correct'; newScore = pos; }
                else if (d.userAns) { newStatus = 'wrong'; newScore = -neg; }
            } 
            else if (fixingQ.type === 'SINGLE') {
                const idx = parseInt(fixValue);
                newQData.correctIndex = idx;
                if (d.userAns === idx) { newStatus = 'correct'; newScore = pos; }
                else if (d.userAns !== undefined) { newStatus = 'wrong'; newScore = -neg; }
            }
            else if (fixingQ.type === 'MULTI') {
                const indices = fixValue.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                newQData.correctIndices = indices;
                const userSel = d.userAns || [];
                if (userSel.length > 0) {
                     const hasWrong = userSel.some(s => !indices.includes(s));
                     if (hasWrong) { newStatus = 'wrong'; newScore = -neg; }
                     else if (userSel.length === indices.length) { newStatus = 'correct'; newScore = pos; }
                     else { newStatus = 'partial'; newScore = userSel.length; }
                }
            }

            return { ...d, qData: newQData, status: newStatus, marks: newScore };
        });

        const newTotal = updatedDetails.reduce((acc, d) => acc + d.marks, 0);
        const newEntry = { ...localEntry, score: newTotal, details: updatedDetails };
        
        setLocalEntry(newEntry);
        if (onUpdateEntry) onUpdateEntry(newEntry);
        setFixingQ(null);
    };

    // --- LOGIC 3: INLINE CREATE & SAVE ---
    const handleCreateAndSave = () => {
        if (!newNbTitle.trim()) return alert("Enter a title");
        if (onCreateNotebook) {
            const newId = onCreateNotebook(newNbTitle); 
            onSave(newId); 
            setSaveModal(false);
            setNewNbTitle("");
            setIsCreating(false);
        }
    };

    const getStatusColor = (status) => {
        switch(status) {
            case 'correct': return 'bg-emerald-500 border-emerald-600 text-white';
            case 'wrong': return 'bg-red-500 border-red-600 text-white';
            case 'partial': return 'bg-amber-500 border-amber-600 text-white';
            default: return 'bg-slate-200 border-slate-300 text-slate-500';
        }
    };
    const formatTime = (s) => (s < 60 ? `${s}s` : `${Math.floor(s/60)}m ${s%60}s`);

    return (
        <div className="h-full flex flex-col bg-slate-50 animate-in fade-in relative">
            
            {/* --- FIX KEY MODAL --- */}
            {fixingQ && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[110] p-4 backdrop-blur-sm animate-in zoom-in-95">
                    <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                        <h3 className="font-bold text-lg text-slate-800 mb-2">Fix Answer Key (Q{fixingQ.qNum})</h3>
                        <p className="text-xs text-slate-500 mb-4">Enter correct answer. Score updates instantly.</p>
                        <input 
                            autoFocus 
                            value={fixValue} 
                            onChange={e => setFixValue(e.target.value)} 
                            className="w-full p-3 border-2 border-indigo-100 rounded-lg font-mono text-lg mb-4 focus:border-indigo-500 outline-none"
                            placeholder={fixingQ.type === 'SINGLE' ? '0 for A, 1 for B...' : 'Value'} 
                        />
                        <div className="flex gap-2">
                            <button onClick={() => setFixingQ(null)} className="flex-1 py-3 text-slate-500 font-bold bg-slate-100 rounded-lg hover:bg-slate-200">Cancel</button>
                            <button onClick={handleSaveFix} className="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md">Update</button>
                        </div>
                    </div>
                </div>
            )}

            {/* --- SAVE MODAL --- */}
            {saveModal && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-in zoom-in-95">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-4 shrink-0">
                            <h3 className="font-bold text-lg text-slate-800">Save Analysis</h3>
                            <button onClick={() => setSaveModal(false)}><Icon name="X" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2 mb-4 pr-1">
                            {savedNotebooks && savedNotebooks.map(nb => (
                                <button key={nb.id} onClick={() => { onSave(nb.id); setSaveModal(false); }} className="w-full text-left p-3 rounded-xl hover:bg-indigo-50 border border-slate-100 font-bold text-slate-700 flex items-center gap-3 group transition-all">
                                    <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><Icon name="BookMarked" className="w-4 h-4" /></div>
                                    <span className="truncate">{nb.title}</span>
                                </button>
                            ))}
                            {(!savedNotebooks || savedNotebooks.length === 0) && !isCreating && <div className="text-center py-6 bg-slate-50 rounded-xl border-2 border-dashed text-xs text-slate-500">No notebooks found.</div>}
                        </div>
                        <div className="pt-4 border-t border-slate-100 shrink-0">
                            {isCreating ? (
                                <div className="animate-in slide-in-from-bottom-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">New Notebook Name</label>
                                    <div className="flex gap-2">
                                        <input value={newNbTitle} onChange={e => setNewNbTitle(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleCreateAndSave()} className="flex-1 border border-indigo-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Physics Mechanics" autoFocus />
                                        <button onClick={handleCreateAndSave} className="bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700">Save</button>
                                    </div>
                                    <button onClick={() => setIsCreating(false)} className="text-xs text-slate-400 hover:text-slate-600 mt-2 underline">Cancel</button>
                                </div>
                            ) : (
                                <button onClick={() => setIsCreating(true)} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2"><Icon name="Plus" className="w-4 h-4" /> Create New Notebook</button>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* --- HEADER --- */}
            <div className="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm shrink-0 z-10">
                <div>
                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="BarChart" className="text-indigo-600" /> Analysis Report</h2>
                    <p className="text-xs text-slate-500 font-medium">{localEntry.testName} â€¢ {new Date(localEntry.date).toLocaleDateString()}</p>
                </div>
                <div className="flex gap-3">
                    {masterTest && (
                        <button onClick={handleSyncWithMaster} className="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-4 py-2 rounded-lg font-bold hover:bg-emerald-100 border border-emerald-200 transition-all animate-in slide-in-from-top-2">
                            <Icon name="RefreshCw" className="w-4 h-4" /> Sync with Original
                        </button>
                    )}
                    {onSave && <button onClick={() => setSaveModal(true)} className="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-bold hover:bg-indigo-100 border border-indigo-200 transition-all"><Icon name="BookMarked" className="w-4 h-4" /> Save</button>}
                    <button onClick={onBack} className="flex items-center gap-2 bg-slate-800 text-white px-5 py-2 rounded-lg font-bold hover:bg-slate-700 shadow-lg hover:shadow-xl transition-all">Exit <Icon name="X" className="w-4 h-4" /></button>
                </div>
            </div>

            {/* --- TABS --- */}
            <div className="bg-white border-b px-6 flex gap-6 text-sm font-bold text-slate-500">
                {['overview', 'solutions', 'time'].map(t => (
                    <button key={t} onClick={() => setTab(t)} className={`py-3 border-b-2 capitalize transition-colors flex items-center gap-2 ${tab === t ? 'border-indigo-600 text-indigo-600' : 'border-transparent hover:text-slate-800'}`}>
                        {t === 'overview' && <Icon name="Grid" className="w-4 h-4" />}
                        {t === 'solutions' && <Icon name="ListChecks" className="w-4 h-4" />}
                        {t === 'time' && <Icon name="Clock" className="w-4 h-4" />}
                        {t}
                    </button>
                ))}
            </div>

            {/* --- CONTENT --- */}
            <div className="flex-1 overflow-y-auto p-6 md:p-8">
                <div className="max-w-6xl mx-auto">
                    
                    {/* === OVERVIEW TAB === */}
                    {tab === 'overview' && (
                        <div className="space-y-6 animate-in slide-in-from-bottom-4">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Score</div>
                                    <div className="text-3xl font-black text-indigo-600">{localEntry.score} <span className="text-sm text-slate-400 font-medium">/ {localEntry.maxMarks}</span></div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Accuracy</div>
                                    <div className={`text-3xl font-black ${correctCount/totalQ > 0.8 ? 'text-green-600' : 'text-amber-600'}`}>{Math.round((correctCount / (totalQ - leftCount || 1)) * 100)}%</div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-red-100 shadow-sm bg-red-50/30">
                                    <div className="text-xs font-bold text-red-400 uppercase tracking-wider mb-1">Negative Lost</div>
                                    <div className="text-3xl font-black text-red-600">-{negMarksLost}</div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Avg Time / Q</div>
                                    <div className="text-3xl font-black text-slate-700">{avgTime}s</div>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-3 gap-6">
                                <div className="md:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                    <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="Target" /> Attempt Distribution</h4>
                                    <div className="h-8 w-full bg-slate-100 rounded-full overflow-hidden flex mb-4">
                                        <div style={{ width: `${(correctCount/totalQ)*100}%` }} className="bg-emerald-500 h-full"></div>
                                        <div style={{ width: `${(wrongCount/totalQ)*100}%` }} className="bg-red-500 h-full"></div>
                                        <div style={{ width: `${(partialCount/totalQ)*100}%` }} className="bg-amber-400 h-full"></div>
                                    </div>
                                    <div className="flex justify-between text-sm font-bold text-slate-600">
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-emerald-500"></div> Correct ({correctCount})</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-red-500"></div> Wrong ({wrongCount})</div>
                                        <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-slate-300"></div> Left ({leftCount})</div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                    <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="BrainCircuit" /> By Type</h4>
                                    <div className="space-y-3">
                                        {Object.entries(typeStats).map(([type, stats]) => (
                                            <div key={type}>
                                                <div className="flex justify-between text-xs font-bold mb-1"><span className="text-slate-600">{type}</span><span className={stats.score >= 0 ? 'text-green-600' : 'text-red-600'}>{stats.score} Marks</span></div>
                                                <div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div style={{ width: `${(stats.correct/stats.total)*100}%` }} className="bg-indigo-500 h-full rounded-full"></div></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* === SOLUTIONS TAB === */}
                    {tab === 'solutions' && (
                        <div className="animate-in slide-in-from-bottom-4">
                            <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                                {['all', 'correct', 'wrong', 'left'].map(f => (
                                    <button key={f} onClick={() => setFilter(f)} className={`px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all whitespace-nowrap ${filter === f ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-500 border border-slate-200 hover:bg-slate-50'}`}>{f}</button>
                                ))}
                            </div>
                            <div className="space-y-6">
                                {localEntry.details.map((d) => {
                                    if (filter !== 'all') { if (filter === 'left' && d.status !== 'left' && d.status !== 'not_visited' && d.status !== 'Unattempted') return null; if (filter !== 'left' && d.status !== filter) return null; }
                                    return (
                                        <div key={d.id} className={`bg-white rounded-xl border-l-4 shadow-sm overflow-hidden ${d.status === 'correct' ? 'border-emerald-500' : d.status === 'wrong' ? 'border-red-500' : 'border-slate-300'}`}>
                                            <div className="p-5 border-b border-slate-50 flex justify-between items-start bg-slate-50/50">
                                                <div className="flex items-center gap-3">
                                                    <span className="font-black text-slate-300 text-xl">#{d.qNum}</span>
                                                    <span className={`text-[10px] font-bold uppercase px-2 py-1 rounded ${getStatusColor(d.status)}`}>{d.status}</span>
                                                    <span className="text-xs font-mono text-slate-400 flex items-center gap-1"><Icon name="Clock" className="w-3 h-3" /> {formatTime(d.timeSpent || 0)}</span>
                                                </div>
                                                <div className="font-bold text-sm text-slate-700">{d.marks > 0 ? '+' : ''}{d.marks} Marks</div>
                                            </div>
                                            <div className="p-6">
                                                <div className="mb-4 text-slate-800 leading-relaxed font-medium"><LatexRenderer content={d.text} /></div>
                                                {d.qData?.diagram && <img src={d.qData.diagram} className="max-h-48 rounded border border-slate-200 mb-4" />}
                                                
                                                {(d.qData?.type === 'SINGLE' || d.qData?.type === 'MULTI') && (
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                                        {d.qData.options?.map((opt, oIdx) => {
                                                            const isUserSel = d.qData.type === 'MULTI' ? d.userAns?.includes(oIdx) : d.userAns === oIdx;
                                                            const isRight = d.qData.type === 'MULTI' ? d.qData.correctIndices?.includes(oIdx) : d.qData.correctIndex === oIdx;
                                                            let style = "border-slate-200 bg-white text-slate-500";
                                                            if (isRight) style = "border-emerald-500 bg-emerald-50 text-emerald-800 font-bold";
                                                            else if (isUserSel && !isRight) style = "border-red-500 bg-red-50 text-red-800 font-bold";
                                                            return <div key={oIdx} className={`p-3 border rounded-lg text-sm flex items-center gap-3 ${style}`}><div className="text-xs">{String.fromCharCode(65+oIdx)}</div><div className="flex-1"><LatexRenderer content={opt} /></div>{isUserSel && <span className="text-[10px] uppercase font-bold px-1 bg-black/10 rounded">You</span>}{isRight && <Icon name="CheckCircle2" className="w-4 h-4 text-emerald-600" />}</div>
                                                        })}
                                                    </div>
                                                )}

                                                {/* Numerical Answer */}
                                                {d.qData?.type === 'NUMERICAL' && (
                                                    <div className="flex gap-4 mb-4 text-sm">
                                                        <div className="bg-slate-100 px-3 py-2 rounded">
                                                            <span className="text-xs font-bold text-slate-500 block">Your Answer</span>
                                                            <span className="font-mono font-bold text-slate-800">{d.userAns !== undefined && d.userAns !== "" ? d.userAns : '-'}</span>
                                                        </div>
                                                        <div className="bg-emerald-50 px-3 py-2 rounded border border-emerald-100">
                                                            <span className="text-xs font-bold text-emerald-600 block">Correct Answer</span>
                                                            <span className="font-mono font-bold text-emerald-800">{d.qData.correctNum !== undefined ? d.qData.correctNum : "N/A"}</span>
                                                        </div>
                                                    </div>
                                                )}
{/* --- MATRIX RESULT DISPLAY (ADD THIS) --- */}
{d.qData?.type === 'MATRIX' && d.qData?.matrix && (
    <div className="mt-4 bg-slate-50 rounded-xl border border-slate-200 p-4">
        {/* 1. The Question Content (Rows & Cols) */}
        <div className="grid md:grid-cols-2 gap-6 mb-4 border-b border-slate-200 pb-4">
            <div>
                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Rows (Column I)</div>
                {d.qData.matrix.rows.map((r, i) => (
                    <div key={i} className="flex gap-2 text-sm mb-1.5 items-start">
                        <span className="font-bold text-slate-500 w-5 pt-0.5">{String.fromCharCode(65+i)}.</span>
                        <div className="text-slate-700 leading-tight"><LatexRenderer content={r} /></div>
                    </div>
                ))}
            </div>
            <div>
                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Columns (Column II)</div>
                {d.qData.matrix.cols.map((c, i) => (
                    <div key={i} className="flex gap-2 text-sm mb-1.5 items-start">
                        <span className="font-bold text-slate-500 w-5 pt-0.5">{i+1}.</span>
                        <div className="text-slate-700 leading-tight"><LatexRenderer content={c} /></div>
                    </div>
                ))}
            </div>
        </div>

        {/* 2. Answer Comparison */}
        <div className="grid grid-cols-2 gap-4">
            <div className="bg-white p-3 rounded border border-slate-100">
                <span className="text-[10px] font-bold uppercase text-slate-500 block mb-2">Your Matches</span>
                {d.userAns && Object.keys(d.userAns).length > 0 ? (
                    Object.entries(d.userAns).map(([rIdx, colIndices]) => {
                        const r = parseInt(rIdx);
                        const userCols = (Array.isArray(colIndices) ? colIndices : []).sort().join(',');
                        
                        // Check against correct answer for this specific row
                        const correctCols = (d.qData.matrixAns?.[r] || []).sort().join(',');
                        const isRowCorrect = userCols === correctCols;

                        return (
                            <div key={r} className={`text-sm font-mono font-bold mb-1 flex items-center gap-2 ${isRowCorrect ? 'text-emerald-600' : 'text-red-500'}`}>
                                <span>{String.fromCharCode(65 + r)} &rarr; {(Array.isArray(colIndices) ? colIndices : []).map(x => x + 1).join(',')}</span>
                                {isRowCorrect ? <Icon name="CheckCircle2" className="w-3 h-3" /> : <Icon name="X" className="w-3 h-3" />}
                            </div>
                        );
                    })
                ) : (
                    <span className="text-xs text-slate-400 italic">You left this unattempted.</span>
                )}
            </div>

            <div className="bg-emerald-50 p-3 rounded border border-emerald-100">
                <span className="text-[10px] font-bold uppercase text-emerald-700 block mb-2">Correct Matches</span>
                {d.qData.matrixAns && Object.entries(d.qData.matrixAns).map(([rIdx, colIndices]) => (
                    <div key={rIdx} className="text-sm font-mono font-bold text-emerald-800 mb-1">
                        {String.fromCharCode(65 + parseInt(rIdx))} &rarr; {colIndices.map(x => x + 1).join(',')}
                    </div>
                ))}
            </div>
        </div>
    </div>
)}
                                                {/* FIX BUTTON */}
                                                <div className="mt-2 mb-4">
                                                    <button onClick={() => {
                                                        let val = "";
                                                        if(d.qData.type==='NUMERICAL') val=d.qData.correctNum;
                                                        else if(d.qData.type==='SINGLE') val=d.qData.correctIndex;
                                                        else if(d.qData.type==='MULTI') val=(d.qData.correctIndices||[]).join(',');
                                                        setFixValue(val);
                                                        setFixingQ({id:d.id, type:d.qData.type, qNum:d.qNum});
                                                    }} className="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 px-2 py-1 rounded flex items-center gap-1 transition-colors">
                                                        <Icon name="Edit2" className="w-3 h-3" /> Fix Answer Key
                                                    </button>
                                                </div>

                                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm text-slate-700 mt-4"><strong className="block text-indigo-600 mb-2 flex items-center gap-2"><Icon name="Lightbulb" className="w-4 h-4" /> Explanation:</strong><LatexRenderer content={d.qData?.explanation || "No explanation provided."} /></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* === TIME TAB === */}
                    {tab === 'time' && (
                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm animate-in slide-in-from-bottom-4">
                             <h4 className="font-bold text-slate-700 mb-6 flex items-center gap-2"><Icon name="Clock" /> Time vs Outcome Heatmap</h4>
                             <div className="grid grid-cols-5 md:grid-cols-10 gap-2">
                                {localEntry.details.map((d, i) => {
                                    let color = "bg-slate-100 border-slate-200 text-slate-400";
                                    const time = d.timeSpent || 0;
                                    if (d.status === 'correct') color = time < 60 ? "bg-emerald-100 border-emerald-300 text-emerald-700" : "bg-yellow-100 border-yellow-300 text-yellow-700";
                                    else if (d.status === 'wrong') color = time > 60 ? "bg-red-200 border-red-400 text-red-800" : "bg-red-50 border-red-200 text-red-400";
                                    return <div key={i} className={`aspect-square rounded-lg border flex flex-col items-center justify-center p-1 text-center ${color}`} title={`Q${d.qNum}: ${d.status} (${time}s)`}><span className="text-[10px] font-bold">Q{d.qNum}</span><span className="text-xs font-mono font-bold">{time}s</span></div>
                                })}
                             </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};
 const Player = ({ test, duration, onBack, notebooks, onSaveToNotebook, onCreateNotebook, isBoss, onBossEdit }) => {
            const storageKey = `tattvam_progress_${test.id}`;

            const { activeQuestions, savedState } = React.useMemo(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem(storageKey));
                    if (saved && saved.order) {
                        const qMap = new Map(test.questions.map(q => [q.id, q]));
                        const ordered = saved.order.map(id => qMap.get(id)).filter(q => q);
                        if (ordered.length === test.questions.length) return { activeQuestions: ordered, savedState: saved };
                    }
                } catch (e) { console.error("Resume failed:", e); }
                return { activeQuestions: test.questions, savedState: null };
            }, [test.id, test.questions]);

            const [questions, setQuestions] = useState(activeQuestions);
            const [idx, setIdx] = useState(savedState?.idx || 0);
            const [ans, setAns] = useState(savedState?.ans || {});
            const [timeLeft, setTimeLeft] = useState(savedState?.timeLeft ?? duration * 60);
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [showPalette, setShowPalette] = useState(true);

            // --- RESULT DATA STATE (TO PASS TO DASHBOARD) ---
            const [finalResultEntry, setFinalResultEntry] = useState(null);

            const [questionTimes, setQuestionTimes] = useState(savedState?.questionTimes || new Array(questions.length).fill(0));
            const [marked, setMarked] = useState(new Set(savedState?.marked || []));
            const [paletteFilter, setPaletteFilter] = useState('all'); 
            const [heatmapMode, setHeatmapMode] = useState(false); 
            const [hoverPreview, setHoverPreview] = useState(null); 
            const [heatConfig, setHeatConfig] = useState({ fast: 30, slow: 90 });
            const [showHeatSettings, setShowHeatSettings] = useState(false);

            useEffect(() => {
                if (!isSubmitted) {
                    const payload = {
                        order: questions.map(q => q.id),
                        idx, ans, timeLeft, questionTimes,
                        marked: Array.from(marked)
                    };
                    localStorage.setItem(storageKey, JSON.stringify(payload));
                }
            }, [idx, ans, timeLeft, questionTimes, marked, isSubmitted, questions]);

            useEffect(() => {
                if (isSubmitted) return;
                if (timeLeft === 0) {
                    finishQuiz(true);
                    return;
                }
                const timer = setInterval(() => {
                    setTimeLeft(prev => prev - 1);
                    setQuestionTimes(prev => {
                        const n = [...prev];
                        n[idx] = (n[idx] || 0) + 1;
                        return n;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [isSubmitted, timeLeft, idx]);

            const formatTime = (s) => `${Math.floor(s/3600)}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            const formatDuration = (s) => (s < 60 ? `${s}s` : `${Math.floor(s/60)}m ${s%60}s`);

            const handleAns = (val) => {
                if(isSubmitted) return;
                const q = questions[idx];
                if(q.type === 'MULTI') {
                    const cur = ans[q.id] || [];
                    const newAns = cur.includes(val) ? cur.filter(x=>x!==val) : [...cur, val];
                    setAns({...ans, [q.id]: newAns});
                } else {
                    setAns({...ans, [q.id]: val});
                }
            };

            const toggleMark = () => {
                const newMarked = new Set(marked);
                if(newMarked.has(idx)) newMarked.delete(idx);
                else newMarked.add(idx);
                setMarked(newMarked);
            };

            const calculatePoints = (q, userAns) => {
                if (userAns === undefined || userAns === '' || (Array.isArray(userAns) && userAns.length === 0)) {
                    return { score: 0, status: 'Unattempted', rawStatus: 'left' };
                }
                const pos = q.marks?.pos || 4;
                const neg = q.marks?.neg || 1;
// Inside Player component -> calculatePoints function

// ... (existing code for unattempted) ...

// REPLACE THE MATRIX BLOCK WITH THIS:
if (q.type === 'MATRIX') {
    const correctMap = q.matrixAns || {};
    const userMap = userAns || {}; 
    const totalRows = q.matrix?.rows?.length || 0;
    if (totalRows === 0) return { score: 0, status: 'Error', rawStatus: 'left' };

    let correctRowCount = 0;
    let wrongRowCount = 0;

    // Check each row individually
    for (let r = 0; r < totalRows; r++) {
        const userRowAns = (userMap[r] || []).sort().join(',');
        const correctRowAns = (correctMap[r] || []).sort().join(',');
        
        // Only count if the user actually attempted this row
        if(userRowAns.length > 0) {
            if (userRowAns === correctRowAns) {
                correctRowCount++;
            } else {
                wrongRowCount++;
            }
        }
    }

    // 1. Partial Marking Logic (Per Row Score)
    const perRowScore = q.marks?.perRow || 0; // Set in Editor (e.g., 2)
    const bonusScore = q.marks?.pos || 4;      // Set in Editor (e.g., 6 or 0)
    const negScore = q.marks?.neg || 0;        // Usually 0 or 1

    // If All Rows Correct -> Give (Rows * PerRow) + Bonus
    if (correctRowCount === totalRows && wrongRowCount === 0) {
        const total = (correctRowCount * perRowScore) + bonusScore;
        return { score: total, status: `Perfect (+${total})`, rawStatus: 'correct' };
    }
    
    // If Partial Correct
    if (correctRowCount > 0) {
        // Calculation: (Correct * PerRow) - (Wrong * Neg)
        // Note: JEE usually doesn't subtract for wrong rows in Matrix, but we allow flexibility here.
        let total = (correctRowCount * perRowScore) - (wrongRowCount * negScore);
        // Ensure score doesn't drop below 0 for a partially correct answer (optional, depending on rule)
        // total = Math.max(0, total); 
        
        return { score: total, status: `Partial (+${total})`, rawStatus: 'partial' };
    }

    // If attempted but all wrong
    if (wrongRowCount > 0) {
        return { score: -negScore, status: `Incorrect (-${negScore})`, rawStatus: 'wrong' };
    }

    return { score: 0, status: 'Unattempted', rawStatus: 'left' };
}
                if (q.type === 'MULTI') {
                    const correct = q.correctIndices || [];
                    const selected = userAns || [];
                    const hasWrong = selected.some(s => !correct.includes(s));
                    if (hasWrong) return { score: -neg, status: `Incorrect (-${neg})`, rawStatus: 'wrong' };
                    if (selected.length === correct.length) return { score: pos, status: `Correct (+${pos})`, rawStatus: 'correct' };
                    const partial = 1 * selected.length;
                    return { score: partial, status: `Partial (+${partial})`, rawStatus: 'partial' };
                }

                let isCorrect = false;
                if (q.type === 'NUMERICAL') isCorrect = String(userAns).trim() === String(q.correctNum).trim();
                else if (q.type === 'SINGLE') isCorrect = userAns === q.correctIndex;
                
                if (isCorrect) return { score: pos, status: `Correct (+${pos})`, rawStatus: 'correct' };
                return { score: -neg, status: `Incorrect (-${neg})`, rawStatus: 'wrong' };
            };

          const finishQuiz = (auto = false) => {
                if(auto || confirm("Submit Test?")) {
                    setIsSubmitted(true);
                    localStorage.removeItem(storageKey);
                    
                    // --- Construct Result Object ---
                    const totalScore = questions.reduce((acc, q) => acc + calculatePoints(q, ans[q.id]).score, 0);
                    const totalMaxMarks = questions.reduce((acc, q) => acc + (q.marks?.pos||0), 0);
                    
                    const questionAnalytics = questions.map((q, i) => {
                        const { score, rawStatus } = calculatePoints(q, ans[q.id]);
                        return {
                            id: q.id,
                            qNum: i + 1,
                            text: q.text,
                            status: rawStatus,
                            timeSpent: questionTimes[i] || 0,
                            marks: score,
                            userAns: ans[q.id],
                            isMarked: marked.has(i),
                            qData: q 
                        };
                    });

                    const finalResult = {
                        id: Date.now().toString(),
                        testId: test.id,
                        date: new Date().toISOString(),
                        testName: test.title,
                        score: totalScore,
                        maxMarks: totalMaxMarks,
                        details: questionAnalytics,
                        type: 'QUIZ_ATTEMPT'
                    };

                    // --- NEW: OFFICIAL SUBMISSION TRIGGER ---
                    if (test.isOfficial) {
                        // 1. Show a "Submitting..." indicator (optional, or just alert)
                        // 2. Send Data
                        submitResultToGoogle({
                            studentName: test.studentName,
                            testTitle: test.title,
                            score: totalScore,
                            maxMarks: totalMaxMarks,
                            details: finalResult // Sending the whole analysis object
                        });
                        
                        alert(`âœ… Exam Submitted Successfully!\nName: ${test.studentName}\nScore: ${totalScore}/${totalMaxMarks}`);
                    }

                    setFinalResultEntry(finalResult);
                    if(auto) alert("Time Up! Submitted.");
                }
            };

            const getStatus = (i) => {
                const qId = questions[i].id;
                const hasAns = ans[qId] !== undefined && ans[qId] !== '' && (!Array.isArray(ans[qId]) || ans[qId].length > 0);
                if (marked.has(i)) return 'marked';
                if (hasAns) return 'answered';
                if (i === idx) return 'current';
                return 'not_visited';
            };

            const getHeatColor = (seconds) => {
                if(seconds < heatConfig.fast) return "bg-green-100 border-green-300 text-green-700"; 
                if(seconds < heatConfig.slow) return "bg-yellow-100 border-yellow-300 text-yellow-700"; 
                return "bg-red-100 border-red-300 text-red-700 font-bold animate-pulse"; 
            };

            const q = questions[idx];

            // --- RENDER UNIFIED RESULT DASHBOARD IF SUBMITTED ---
            if (isSubmitted && finalResultEntry) {
                return (
                    <ResultDashboard 
                        entry={finalResultEntry} 
                        onBack={onBack} 
                        onSave={(nbId) => {
                            onSaveToNotebook(nbId, finalResultEntry);
                            alert("Analysis Saved!");
                        }} 
                        savedNotebooks={notebooks}
onCreateNotebook={onCreateNotebook}
                    />
                );
            }

            // --- QUIZ TAKING SCREEN ---
            return (
                <div className="h-screen flex flex-col bg-slate-50">
                    <div className="bg-white border-b px-4 py-2 flex justify-between items-center shadow-sm shrink-0 h-16">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg font-bold text-xs" title="Save Progress & Exit">
                                <Icon name="ArrowLeft" className="w-4 h-4" /> Save & Exit
                            </button>
                            <h2 className="font-bold text-lg text-slate-800 truncate max-w-xs">{test.title}</h2>
{isBoss && test.isOfficial && (
                        <button 
                            onClick={() => onBossEdit(test)} 
                            className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 animate-pulse"
                        >
                            <Icon name="Edit" /> BOSS: Fix This Test
                        </button>
                    )}
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => { if(confirm("Restarting will erase current progress. Sure?")) { localStorage.removeItem(storageKey); setAns({}); setTimeLeft(duration*60); setQuestionTimes(new Array(questions.length).fill(0)); setMarked(new Set()); setIdx(0); } }} className="text-xs font-bold text-red-400 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded">Restart</button>
                            <div className="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg text-slate-700 font-mono font-bold">
                                <Icon name="Clock" className="w-4 h-4" /> {timeLeft > 36000 ? "âˆž" : formatTime(timeLeft)}
                            </div>
                            <button onClick={() => finishQuiz(false)} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 shadow-sm text-sm">Submit Test</button>
                        </div>
                        <button onClick={() => setShowPalette(!showPalette)} className="md:hidden"><Icon name="Grid" /></button>
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                         {hoverPreview && (
                            <div className="fixed z-[999] bg-slate-900 text-white text-xs p-3 rounded-lg shadow-xl max-w-xs pointer-events-none" style={{ left: hoverPreview.x + 20, top: hoverPreview.y }}>
                                <div className="font-bold mb-1 text-slate-400">Question Preview</div>
                                <div className="line-clamp-3"><LatexRenderer content={hoverPreview.text} /></div>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto p-6 md:p-10">
                            <div className="max-w-4xl mx-auto">
                                <div className="flex justify-between items-start mb-6">
                                    <div className="flex items-center gap-3">
                                        <span className="text-xl font-bold text-slate-400">Q{idx+1}</span>
                                        <span className={`text-xs font-bold font-mono px-2 py-1 rounded flex items-center gap-1 ${questionTimes[idx] > heatConfig.slow ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-slate-100 text-slate-500'}`}>
                                            <Icon name="Clock" className="w-3 h-3" />
                                            {formatDuration(questionTimes[idx] || 0)}
                                        </span>
                                        <span className="text-xs font-bold bg-slate-200 text-slate-600 px-2 py-1 rounded uppercase tracking-wider">{q.type}</span>
                                        <span className="text-xs font-bold text-slate-400">+{q.marks?.pos} / -{q.marks?.neg}</span>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={toggleMark} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg font-bold text-sm transition-all ${marked.has(idx) ? 'bg-amber-100 text-amber-700 border border-amber-300' : 'bg-white border border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                            <Icon name="Flag" className={`w-4 h-4 ${marked.has(idx) ? 'fill-current' : ''}`} />
                                            {marked.has(idx) ? 'Marked' : 'Mark for Review'}
                                        </button>
                                        <button onClick={() => handleAns('')} className="px-3 py-1.5 text-sm text-red-500 hover:bg-red-50 rounded-lg font-medium border border-transparent hover:border-red-100">Clear</button>
                                    </div>
                                </div>
                                <div className="text-lg text-slate-800 leading-relaxed mb-8">
                                    <LatexRenderer content={q.text} />
                                    {q.diagram && <img src={q.diagram} className="mt-4 max-h-64 object-contain rounded-lg border border-slate-200" />}
                                </div>
                                <div className="space-y-3">
                                    {(q.type === 'SINGLE' || q.type === 'MULTI' || !q.type) && q.options?.map((opt, oIdx) => {
                                        const isSel = q.type === 'MULTI' ? ans[q.id]?.includes(oIdx) : ans[q.id] === oIdx;
                                        return (
                                            <div key={oIdx} onClick={() => handleAns(oIdx)} className={`p-4 rounded-xl border-2 cursor-pointer transition-all flex items-center gap-4 group ${isSel ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50'}`}>
                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs font-bold transition-colors ${isSel ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-300 text-slate-400 group-hover:border-indigo-400'}`}>{String.fromCharCode(65+oIdx)}</div>
                                                <div className="text-base text-slate-700">{opt.startsWith('CHEM:') ? <AutoChemicalRenderer text={opt} /> : <LatexRenderer content={opt} />}</div>
                                            </div>
                                        );
                                    })}
                                    {q.type === 'NUMERICAL' && (
                                        <div><label className="block text-sm font-bold text-slate-500 mb-2">Your Answer</label><input type="text" value={ans[q.id] || ''} onChange={e => handleAns(e.target.value)} className="w-full md:w-1/2 p-4 text-xl border-2 border-slate-300 rounded-xl focus:border-indigo-500 outline-none font-mono" placeholder="Enter numerical value..." /></div>
                                    )}
{/* --- MATRIX MATCH (IMPROVED UI) --- */}
{q.type === 'MATRIX' && q.matrix && (
    <div className="overflow-x-auto mt-6 pb-2">
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm inline-block min-w-full">
            
            {/* DYNAMIC GRID CONTAINER */}
            <div 
                className="grid gap-px bg-slate-200 rounded-lg overflow-hidden border border-slate-200"
                style={{ 
                    // This is the key fix: It calculates exact columns needed
                    gridTemplateColumns: `minmax(250px, 2fr) repeat(${q.matrix.cols?.length || 1}, minmax(60px, 1fr))` 
                }}
            >
                {/* HEADER ROW */}
                <div className="bg-slate-50 p-3 flex items-center justify-center font-bold text-xs text-slate-400 uppercase tracking-wider">
                    Rows \ Cols
                </div>
                {q.matrix.cols?.map((col, cIdx) => (
                    <div key={cIdx} className="bg-indigo-50 p-2 flex flex-col items-center justify-center text-center">
                        <span className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 font-bold text-xs flex items-center justify-center mb-1 border border-indigo-200">
                            {cIdx + 1}
                        </span>
                        <div className="text-[10px] leading-tight text-slate-600 font-medium line-clamp-2">
                            <LatexRenderer content={col} />
                        </div>
                    </div>
                ))}

                {/* DATA ROWS */}
                {q.matrix.rows?.map((row, rIdx) => (
                    <React.Fragment key={rIdx}>
                        {/* Row Question Text */}
                        <div className="bg-white p-3 flex items-start gap-3">
                            <span className="w-6 h-6 shrink-0 rounded bg-slate-100 text-slate-600 font-bold text-xs flex items-center justify-center border border-slate-200">
                                {String.fromCharCode(65 + rIdx)}
                            </span>
                            <div className="text-sm text-slate-800 font-medium leading-relaxed">
                                <LatexRenderer content={row} />
                            </div>
                        </div>

                        {/* Checkboxes */}
                        {q.matrix.cols?.map((_, cIdx) => {
                            const currentAns = ans[q.id] || {};
                            const rowSelection = currentAns[rIdx] || [];
                            const isChecked = rowSelection.includes(cIdx);

                            return (
                                <div key={cIdx} className="bg-white flex items-center justify-center hover:bg-slate-50 transition-colors">
                                    <button 
                                        onClick={() => {
                                            if (isSubmitted) return;
                                            const newRowSelection = isChecked 
                                                ? rowSelection.filter(x => x !== cIdx) 
                                                : [...rowSelection, cIdx];
                                            setAns({ ...ans, [q.id]: { ...currentAns, [rIdx]: newRowSelection } });
                                        }}
                                        className={`w-8 h-8 rounded-md transition-all duration-200 flex items-center justify-center ${
                                            isChecked 
                                            ? 'bg-indigo-600 text-white shadow-md scale-110' 
                                            : 'bg-slate-100 text-slate-300 hover:bg-slate-200'
                                        }`}
                                    >
                                        {isChecked ? <Icon name="CheckCircle2" className="w-5 h-5" /> : <div className="w-2 h-2 rounded-full bg-slate-300" />}
                                    </button>
                                </div>
                            );
                        })}
                    </React.Fragment>
                ))}
            </div>
        </div>
        <p className="text-center text-xs text-slate-400 mt-2 font-medium">Scroll horizontally if needed â€¢ Click boxes to match</p>
    </div>
)}
                                </div>
                                <div className="flex justify-between mt-10 pt-6 border-t border-slate-100">
                                    <button onClick={() => idx > 0 && setIdx(idx-1)} disabled={idx===0} className="px-6 py-2 rounded-lg font-bold text-slate-500 hover:bg-slate-100 disabled:opacity-50 flex items-center gap-2"><Icon name="ChevronLeft" /> Previous</button>
                                    <button onClick={() => idx < questions.length-1 && setIdx(idx+1)} disabled={idx===questions.length-1} className="bg-slate-900 text-white px-8 py-2 rounded-lg font-bold hover:bg-slate-800 flex items-center gap-2">Next <Icon name="ChevronRight" /></button>
                                </div>
                            </div>
                        </div>

                        {/* --- PALETTE --- */}
                        <div className={`${showPalette ? 'w-80' : 'w-0'} bg-white border-l transition-all duration-300 flex flex-col shrink-0 overflow-hidden`}>
                            <div className="p-4 border-b bg-slate-50 relative">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-sm uppercase text-slate-700 flex items-center gap-2"><Icon name="Grid" /> Palette</h3>
                                    <div className="flex gap-1">
                                        <button 
                                            onClick={() => setShowHeatSettings(!showHeatSettings)} 
                                            className="p-1.5 rounded-lg bg-slate-100 text-slate-500 hover:bg-slate-200"
                                            title="Heatmap Settings"
                                        >
                                            <Icon name="Settings" className="w-4 h-4" />
                                        </button>
                                        <button 
                                            onClick={() => setHeatmapMode(!heatmapMode)} 
                                            className={`p-1.5 rounded-lg transition-colors ${heatmapMode ? 'bg-orange-100 text-orange-600' : 'bg-slate-200 text-slate-400'}`}
                                            title="Toggle Time-Stress Heatmap"
                                        >
                                            <Icon name="BarChart" className="w-4 h-4" />
                                        </button>
                                    </div>
                                </div>

                                {showHeatSettings && (
                                    <div className="absolute top-12 right-2 bg-white border shadow-xl rounded-lg p-3 z-50 w-48 animate-in zoom-in-95">
                                        <h4 className="text-[10px] font-bold uppercase text-slate-500 mb-2">Time Thresholds (Sec)</h4>
                                        <div className="space-y-2">
                                            <div><label className="text-xs text-green-600 font-bold block">Fast (Green)</label><input type="number" value={heatConfig.fast} onChange={e=>setHeatConfig({...heatConfig, fast: Number(e.target.value)})} className="w-full p-1 border rounded text-xs" /></div>
                                            <div><label className="text-xs text-red-600 font-bold block">Slow (Red)</label><input type="number" value={heatConfig.slow} onChange={e=>setHeatConfig({...heatConfig, slow: Number(e.target.value)})} className="w-full p-1 border rounded text-xs" /></div>
                                        </div>
                                        <button onClick={() => setShowHeatSettings(false)} className="w-full mt-2 bg-indigo-50 text-indigo-700 text-xs font-bold py-1 rounded">Close</button>
                                    </div>
                                )}

                                <div className="flex bg-slate-200 p-1 rounded-lg">
                                    {['all', 'left', 'done', 'marked'].map(f => (
                                        <button 
                                            key={f} 
                                            onClick={() => setPaletteFilter(f)}
                                            className={`flex-1 py-1 text-[10px] font-bold uppercase rounded-md transition-all ${paletteFilter === f ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            {f}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-4">
                                <div className="grid grid-cols-5 gap-2">
                                    {questions.map((qItem, i) => {
                                        const st = getStatus(i);
                                        if (paletteFilter === 'left' && (st === 'answered' || st === 'marked')) return null;
                                        if (paletteFilter === 'done' && st !== 'answered') return null;
                                        if (paletteFilter === 'marked' && st !== 'marked') return null;

                                        let baseStyle = "bg-slate-100 text-slate-500 border-slate-200";
                                        if (heatmapMode) {
                                            baseStyle = getHeatColor(questionTimes[i]);
                                        } else {
                                            if (st === 'marked') baseStyle = "bg-amber-100 text-amber-700 border-amber-300";
                                            else if (st === 'answered') baseStyle = "bg-green-100 text-green-700 border-green-300";
                                            else if (st === 'current') baseStyle = "ring-2 ring-indigo-500 ring-offset-2 border-indigo-300 bg-white text-indigo-700";
                                        }

                                        return (
                                            <button 
                                                key={i} 
                                                onClick={() => setIdx(i)} 
                                                onMouseEnter={(e) => setHoverPreview({ x: e.clientX, y: e.clientY, text: qItem.text.substring(0, 100) + "..." })}
                                                onMouseLeave={() => setHoverPreview(null)}
                                                className={`h-10 w-full rounded-lg border font-bold text-sm flex items-center justify-center transition-all relative ${baseStyle} ${idx===i && !heatmapMode ? 'ring-2 ring-indigo-500 ring-offset-2' : ''}`}
                                            >
                                                {i+1}
                                                {marked.has(i) && !heatmapMode && <div className="absolute top-0 right-0 w-2 h-2 bg-amber-500 rounded-full -mr-1 -mt-1 ring-2 ring-white"></div>}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="p-3 bg-slate-50 border-t text-[10px] text-slate-500 flex justify-between font-mono">
                                <span>Done: {Object.keys(ans).filter(k => ans[k] !== '').length}</span>
                                <span>Left: {questions.length - Object.keys(ans).filter(k => ans[k] !== '').length}</span>
                                <span>Marked: {marked.size}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
const PrintCustomizer = ({ cfg, setCfg, onClose, onAI, loading, totalCalculatedMarks }) => {
            const [tab, setTab] = useState('design'); // design | content | layout
            const [aiPrompt, setAiPrompt] = useState(''); // NEW: State for AI Prompt

            // Safety check to prevent white screen if props are missing
            if (!cfg) return null;

            const handleLogo = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setCfg({...cfg, logo: ev.target.result});
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-50 animate-in slide-in-from-right border-l flex flex-col h-full font-sans">
                    {/* Header */}
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 shrink-0 bg-white">
                        <div className="flex items-center gap-2 text-indigo-900">
                            <Icon name="Settings" className="w-5 h-5" />
                            <h3 className="font-bold text-lg">Design Studio</h3>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-red-500 transition-colors"><Icon name="X" /></button>
                    </div>

                    {/* Tabs */}
                    <div className="flex border-b border-slate-100">
                        {['design', 'content', 'layout'].map(t => (
                            <button key={t} onClick={() => setTab(t)} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wider ${tab===t ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-400 hover:bg-slate-50'}`}>
                                {t}
                            </button>
                        ))}
                    </div>

                    {/* Scrollable Content */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50">
                        
                        {/* --- TAB: DESIGN --- */}
                        {tab === 'design' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Theme Style</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {['Classic', 'Modern', 'Minimal', 'Brutal'].map(th => (
                                            <button key={th} onClick={() => setCfg({...cfg, theme: th})} className={`px-3 py-2 text-sm border rounded-lg transition-all ${cfg.theme === th ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300'}`}>
                                                {th}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Institute Logo</label>
                                    <div className="flex items-center gap-3">
                                        {cfg.logo ? (
                                            <div className="relative w-16 h-16 border rounded bg-white p-1">
                                                <img src={cfg.logo} className="w-full h-full object-contain" />
                                                <button onClick={() => setCfg({...cfg, logo: null})} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><Icon name="X" className="w-3 h-3" /></button>
                                            </div>
                                        ) : (
                                            <label className="w-16 h-16 border-2 border-dashed border-slate-300 rounded hover:border-indigo-500 flex items-center justify-center cursor-pointer bg-white">
                                                <Icon name="Image" className="text-slate-300" />
                                                <input type="file" className="hidden" accept="image/*" onChange={handleLogo} />
                                            </label>
                                        )}
                                        <div className="text-xs text-slate-400 flex-1">Upload a square or rectangular logo for the header.</div>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Typography</label>
                                    <div className="flex border rounded-lg overflow-hidden bg-white">
                                        {['serif', 'sans', 'mono'].map(f => (
                                            <button key={f} onClick={() => setCfg({...cfg, font: f})} className={`flex-1 py-2 text-xs font-bold uppercase ${cfg.font === f ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>
                                                {f}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- TAB: CONTENT --- */}
                        {tab === 'content' && (
                            <div className="space-y-5 animate-in fade-in">
                                <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                                    <label className="text-xs font-bold text-indigo-700 uppercase flex items-center gap-1 mb-2"><Icon name="Wand2" className="w-3 h-3" /> AI Designer</label>
                                    {/* FIXED: Uses State instead of document.getElementById */}
                                    <textarea 
                                        value={aiPrompt}
                                        onChange={(e) => setAiPrompt(e.target.value)}
                                        className="w-full text-xs border border-indigo-200 p-2.5 rounded-lg mb-3 h-16 focus:ring-2 focus:ring-indigo-500 outline-none bg-white" 
                                        placeholder="e.g. Strict IIT-JEE Physics Paper layout..."
                                    ></textarea>
                                    <button onClick={() => onAI(aiPrompt)} disabled={loading || !aiPrompt} className="w-full bg-indigo-600 text-white text-xs py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-indigo-700 disabled:opacity-50 shadow-sm transition-all">{loading ? <Icon name="Loader2" className="w-3 h-3 animate-spin" /> : <Icon name="Sparkles" className="w-3 h-3" />} Generate</button>
                                </div>

                                <div><label className="text-xs font-bold text-slate-500 uppercase">Header Title</label><input value={cfg.header} onChange={e => setCfg({...cfg, header: e.target.value})} className="w-full border p-2 rounded mt-1 text-sm" /></div>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase">Duration</label><input value={cfg.duration} onChange={e => setCfg({...cfg, duration: e.target.value})} className="w-full border p-2 rounded mt-1 text-sm" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase">Max Marks</label><input value={cfg.maxMarks} onChange={e => setCfg({...cfg, maxMarks: e.target.value})} className="w-full border p-2 rounded mt-1 text-sm" placeholder={String(totalCalculatedMarks || 0)} /></div>
                                </div>

                                <div className="space-y-2 bg-white p-3 rounded border">
                                    <div className="flex items-center justify-between">
                                        <label className="text-sm font-bold text-slate-700">Add Solution QR</label>
                                        <input type="checkbox" checked={cfg.showQR} onChange={e => setCfg({...cfg, showQR: e.target.checked})} className="w-5 h-5 accent-indigo-600" />
                                    </div>
                                    {cfg.showQR && (
                                        <input value={cfg.qrLink} onChange={e => setCfg({...cfg, qrLink: e.target.value})} className="w-full border p-2 rounded text-xs" placeholder="Paste Solution Link (Drive/Video URL)..." />
                                    )}
                                </div>

                                <div className="flex items-center justify-between bg-white p-3 rounded border">
                                    <label className="text-sm font-bold text-slate-700">Include Answer Key</label>
                                    <input type="checkbox" checked={cfg.showKey !== false} onChange={e => setCfg({...cfg, showKey: e.target.checked})} className="w-5 h-5 accent-indigo-600" />
                                </div>

                                <div><label className="text-xs font-bold text-slate-500 uppercase">Instructions</label><textarea value={cfg.instructions} onChange={e => setCfg({...cfg, instructions: e.target.value})} className="w-full border p-2 rounded mt-1 h-24 text-xs font-mono" /></div>
                            </div>
                        )}

                        {/* --- TAB: LAYOUT --- */}
                        {tab === 'layout' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div>
                                    <div className="flex justify-between mb-1"><label className="text-xs font-bold text-slate-500 uppercase">Font Size</label><span className="text-xs font-mono">{cfg.fontSize}px</span></div>
                                    <input type="range" min="10" max="20" value={cfg.fontSize} onChange={e => setCfg({...cfg, fontSize: Number(e.target.value)})} className="w-full accent-indigo-600" />
                                </div>
                                <div>
                                    <div className="flex justify-between mb-1"><label className="text-xs font-bold text-slate-500 uppercase">Spacing (Gap)</label><span className="text-xs font-mono">{cfg.gap}px</span></div>
                                    <input type="range" min="4" max="16" value={cfg.gap} onChange={e => setCfg({...cfg, gap: Number(e.target.value)})} className="w-full accent-indigo-600" />
                                </div>
                                
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center bg-white p-3 rounded border"><label className="text-sm text-slate-700">2-Column Mode</label><input type="checkbox" checked={cfg.twoCol} onChange={e => setCfg({...cfg, twoCol: e.target.checked})} className="w-5 h-5 accent-indigo-600" /></div>
                                    <div className="flex justify-between items-center bg-white p-3 rounded border"><label className="text-sm text-slate-700">Show Marks</label><input type="checkbox" checked={cfg.showMarks} onChange={e => setCfg({...cfg, showMarks: e.target.checked})} className="w-5 h-5 accent-indigo-600" /></div>
                                </div>
                                
                                <div><label className="text-xs font-bold text-slate-500 uppercase">Watermark</label><input value={cfg.watermark} onChange={e => setCfg({...cfg, watermark: e.target.value})} className="w-full border p-2 rounded mt-1 text-sm" placeholder="Confidential" /></div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="p-4 border-t border-slate-100 bg-white shrink-0">
                        <button onClick={onClose} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-slate-800 shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="CheckCircle2" className="w-5 h-5" /> Done</button>
                    </div>
                </div>
            );
        };
const PrintView = ({ test, onBack, apiKey, onRequestKey }) => {
            const calculatedTotal = test.questions.reduce((a,q)=>a+(q.marks?.pos||0),0);
            
            const [cfg, setCfg] = useState({ 
                theme: 'Classic', 
                header: test.title, 
                logo: null,
                watermark: '', 
                twoCol: false, 
                showMarks: true,
                showKey: true, // Default to true
                duration: "3 Hours",
                maxMarks: "",
                candidateLabel: "Candidate Name",
                instructions: "1. All questions are compulsory.\n2. The question paper consists of " + test.questions.length + " questions.\n3. Use of calculators is not permitted.",
                font: 'serif',
                fontSize: 16,
                gap: 8,
                showQR: false,
                qrLink: ''
            });
            const [showCfg, setShowCfg] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);

            const handleAITemplate = async (prompt) => {
                if(!apiKey) return onRequestKey();
                setAiLoading(true);
                try {
                    const newCfg = await generateTemplateConfig(prompt, test.title, apiKey);
                    setCfg(prev => ({ ...prev, ...newCfg }));
                } catch(e) { alert("AI Error: " + e.message); }
                setAiLoading(false);
            };

            const getThemeStyles = () => {
                const base = "max-w-4xl mx-auto min-h-[11in] relative overflow-hidden print-w-full print-max-w-none ";
                switch(cfg.theme) {
                    case 'Modern': return { container: base + "font-sans bg-white text-slate-900", header: "bg-slate-900 text-white p-8 mb-8", title: "text-4xl font-black tracking-tight", meta: "text-slate-400" };
                    case 'Minimal': return { container: base + "font-sans bg-white text-slate-800", header: "border-b pb-4 mb-8", title: "text-2xl font-light uppercase tracking-widest", meta: "text-slate-500 text-xs uppercase" };
                    case 'Brutal': return { container: base + "font-mono bg-white text-black border-4 border-black p-4", header: "border-b-4 border-black pb-6 mb-8 bg-yellow-300 p-4 -mx-4 -mt-4", title: "text-4xl font-black uppercase", meta: "font-bold" };
                    default: return { container: base + "font-serif bg-white text-black p-10", header: "border-b-2 border-black pb-6 mb-8 text-center", title: "text-3xl font-bold uppercase", meta: "" };
                }
            };
            const theme = getThemeStyles();

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col">
                    {showCfg && <PrintCustomizer cfg={cfg} setCfg={setCfg} onClose={() => setShowCfg(false)} onAI={handleAITemplate} loading={aiLoading} totalCalculatedMarks={calculatedTotal} />}
                    
                    <div className="bg-slate-900 text-white px-6 py-4 flex justify-between items-center print-hidden shadow-md sticky top-0 z-50">
                        <div className="flex items-center gap-4"><button onClick={onBack} className="hover:bg-slate-700 p-2 rounded-lg flex items-center gap-2"><Icon name="ArrowLeft" className="w-4 h-4" /> Back</button><span className="font-semibold">{test.title}</span></div>
                        <div className="flex gap-2"><button onClick={() => setShowCfg(true)} className="bg-indigo-600 px-3 py-2 rounded text-sm font-bold flex items-center gap-2"><Icon name="Settings" className="w-4 h-4" /> Design Studio</button><button onClick={() => window.print()} className="bg-white text-slate-900 px-6 py-2 rounded-lg font-bold hover:bg-indigo-50 flex items-center gap-2 shadow-lg"><Icon name="Printer" className="w-4 h-4" /> Print</button></div>
                    </div>
                    
                    <div className="flex-1 overflow-auto p-8 print-p-0 print-overflow-visible">
                        <div className={theme.container} style={{ fontSize: `${cfg.fontSize}px` }}>
                            {cfg.watermark && <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.08] z-0"><span className="text-9xl font-black -rotate-45 whitespace-nowrap">{cfg.watermark}</span></div>}
                            
                            {/* HEADER */}
                            <div className={`relative z-10 ${theme.header}`}>
                                <div className="flex justify-between items-start gap-6">
                                    {cfg.logo && <img src={cfg.logo} className="h-20 w-auto object-contain mix-blend-multiply" />}
                                    <div className="flex-1">
                                        <h1 className={theme.title}>{cfg.header}</h1>
                                        <div className={`flex flex-wrap gap-4 mt-2 ${theme.meta}`}>
                                            <span><strong>Time:</strong> {cfg.duration}</span>
                                            <span><strong>Marks:</strong> {cfg.maxMarks || calculatedTotal}</span>
                                        </div>
                                    </div>
                                    {cfg.showQR && (
                                        <div className="text-center">
                                            <img src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(cfg.qrLink || "No Link")}`} className="w-20 h-20 border-2 border-white" />
                                            <div className="text-[10px] font-bold mt-1 uppercase">Solutions</div>
                                        </div>
                                    )}
                                </div>
                                <div className="mt-6 text-sm whitespace-pre-line opacity-90">{cfg.instructions}</div>
                                {cfg.theme === 'Classic' && (
                                    <div className="mt-4 flex gap-4 text-sm font-serif pt-4 border-t border-black/20">
                                        <span className="font-bold whitespace-nowrap">{cfg.candidateLabel}:</span>
                                        <div className="border-b border-black flex-1 border-dashed"></div>
                                    </div>
                                )}
                            </div>

                            {/* QUESTIONS */}
                            <div className={`relative z-10 ${cfg.twoCol ? 'print-col-2' : ''}`} style={{ columnGap: '2rem' }}>
                                {test.questions.map((q, i) => (
                                    <div key={q.id} className="break-inside-avoid mb-0" style={{ marginBottom: `${cfg.gap*2}px` }}>
                                        <div className="flex gap-3">
                                            <span className="font-bold opacity-70 flex-shrink-0" style={{ minWidth: '1.5em' }}>{i + 1}.</span>
                                            <div className="flex-1">
                                                <div className="leading-relaxed text-justify w-full"><LatexRenderer content={q.text} /></div>
                                                {q.diagram && <img src={q.diagram} className="max-w-[180px] h-auto object-contain my-3 border border-gray-200 rounded" />}
                                                
                                                {(q.type === 'SINGLE' || q.type === 'MULTI' || !q.type) && (
                                                    <div className="grid grid-cols-2 gap-x-6 gap-y-1 ml-1 mt-2">
                                                        {q.options?.map((opt, oIdx) => (
                                                            <div key={oIdx} className="flex items-start gap-2">
                                                                <span className="font-bold text-[0.9em] opacity-80 mt-0.5">({String.fromCharCode(97 + oIdx)})</span>
                                                                <div className=""><LatexRenderer content={opt} /></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                
{q.type === 'MATRIX' && q.matrix && (
    <div className="mt-3 bg-slate-50 p-3 rounded border border-slate-200 text-sm">
        <div className="grid grid-cols-2 gap-4">
            <div>
                <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Rows</span>
                {q.matrix.rows.map((r, i) => (
                    <div key={i} className="flex gap-2 items-start mb-1">
                        <span className="font-bold text-slate-500 text-xs">{String.fromCharCode(65+i)}.</span>
                        <div className="leading-tight"><LatexRenderer content={r} /></div>
                    </div>
                ))}
            </div>
            <div>
                <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Columns</span>
                {q.matrix.cols.map((c, i) => (
                    <div key={i} className="flex gap-2 items-start mb-1">
                        <span className="font-bold text-slate-500 text-xs">{i+1}.</span>
                        <div className="leading-tight"><LatexRenderer content={c} /></div>
                    </div>
                ))}
            </div>
        </div>
    </div>
)}                                                <div className="flex justify-between items-center mt-1">
                                                    {q.type === 'NUMERICAL' ? <div className="border-b border-black w-24 h-4 opacity-30"></div> : <div></div>}
                                                    {cfg.showMarks && <span className="text-[0.7em] font-bold border border-current px-1 opacity-50 rounded">+{q.marks?.pos||4}, -{q.marks?.neg||1}</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* --- ANSWER KEY SECTION --- */}
                            {cfg.showKey !== false && (
                                <div className="mt-8 pt-8 border-t-2 border-black/50" style={{ pageBreakBefore: 'always' }}>
                                    <h2 className="text-xl font-bold text-center mb-6 uppercase tracking-wider">Answer Key</h2>
                                    <div className="grid grid-cols-4 md:grid-cols-5 gap-4 text-sm font-mono">
                                        {test.questions.map((q, i) => {
                                            let ans = "-";
                                            if (q.type === 'SINGLE' && q.correctIndex !== undefined && q.correctIndex !== -1) ans = String.fromCharCode(65 + q.correctIndex);
                                            else if (q.type === 'MULTI' && q.correctIndices?.length) ans = q.correctIndices.map(x => String.fromCharCode(65 + x)).join(',');
                                            else if (q.type === 'NUMERICAL') ans = q.correctNum;
                                            else if (q.type === 'MATRIX' && q.matrixAns) {
                                                // Format: A-1,2; B-3
                                                ans = Object.entries(q.matrixAns).map(([r, cs]) => `${String.fromCharCode(65 + parseInt(r))}-${cs.map(c=>c+1).join(',')}`).join('; ');
                                            }
                                            
                                            if (ans === "-" || ans === "") return null;

                                            return (
                                                <div key={i} className="flex gap-2 items-baseline border-b border-slate-200 pb-1">
                                                    <span className="font-bold text-slate-500 w-8 text-right">{i+1}.</span>
                                                    <span className="font-bold text-slate-900 break-all">{ans}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            <div className="mt-12 pt-4 border-t opacity-30 text-center text-xs print-hidden">Designed with Tattvam</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW: UNIFIED RESULT DASHBOARD ---
       
// --- MAIN APP COMPONENT (QUIZFORGE) ---
const QuizForge = () => {
    const [view, setView] = useState('dashboard'); // dashboard | editor | notebook | player | print
    const [isBoss, setBossMode] = useState(false); // <--- 1. NEW STATE
// âš ï¸ SECURITY RISK: This token is visible to anyone who views the page source.

    // <--- 2. NEW FUNCTION
    const handleBossEdit = (officialTest) => {
        // Create a temporary "Draft" version of the test
        const draft = { 
            ...officialTest, 
            isOfficial: false, 
            isBossDraft: true // This flag tells Editor to show "Publish" button
        };
        
        // Add it to the list so the Editor can load it
        setTests(prev => [draft, ...prev]);
        setActiveId(draft.id);
        setView('editor');
    };	
    // --- SAFE STORAGE LOADERS ---
    const safeLoad = (key, fallback) => {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : fallback;
        } catch (e) { console.error(`Failed to load ${key}`, e); return fallback; }
    };

    // --- STATE MANAGEMENT ---
    const [tests, setTests] = useState(() => safeLoad('quizforge_tests', []));
    const [notebooks, setNotebooks] = useState(() => safeLoad('quizforge_notebooks', []));
    const [playingTest, setPlayingTest] = useState(null);

    // API Keys & Settings
    const [keyContext, setKeyContext] = useState(() => {
        const stored = localStorage.getItem('tattvam_key_context');
        if (stored) return JSON.parse(stored);
        return { keys: [], currentIndex: 0 };
    });
    
    const [userNotes, setUserNotes] = useState(() => localStorage.getItem('tattvam_user_notes') || '');
    const [appLogo, setAppLogo] = useState(() => localStorage.getItem('tattvam_app_logo') || "./logo.png");

    // Navigation State
    const [activeId, setActiveId] = useState(null);
    const [activeNotebookId, setActiveNotebookId] = useState(null);
    
    // Modals
    const [modal, setModal] = useState(false); // Settings Modal
    const [quizDuration, setQuizDuration] = useState(180);
    const [showQuizSetup, setShowQuizSetup] = useState(false);
    const [storageWarning, setStorageWarning] = useState(false);

    // --- PERSISTENCE EFFECTS ---
    useEffect(() => { 
        try { 
            localStorage.setItem('quizforge_tests', JSON.stringify(tests)); 
            setStorageWarning(false); 
        } catch (e) { setStorageWarning(true); } 
    }, [tests]);

    useEffect(() => { try { localStorage.setItem('quizforge_notebooks', JSON.stringify(notebooks)); } catch(e) {} }, [notebooks]);
    useEffect(() => { try { localStorage.setItem('tattvam_key_context', JSON.stringify(keyContext)); } catch(e) {} }, [keyContext]);
    useEffect(() => { localStorage.setItem('tattvam_user_notes', userNotes); }, [userNotes]);
    useEffect(() => { if(appLogo !== "./logo.png") localStorage.setItem('tattvam_app_logo', appLogo); }, [appLogo]);

    // --- DERIVED STATE ---
    const activeTest = tests.find(t => t.id === activeId);
    const activeNotebook = notebooks.find(n => n.id === activeNotebookId);

    // --- HANDLERS ---

    // 1. Notebook Logic (Update, Save Entry, Create New)
    const handleUpdateNotebook = (u) => setNotebooks(notebooks.map(n => n.id === activeNotebookId ? u : n));
    
    const handleSaveToNotebook = (nbId, entry) => {
        setNotebooks(prev => prev.map(nb => nb.id === nbId ? { ...nb, entries: [entry, ...(nb.entries||[])] } : nb));
    };

    // **NEW: Create Notebook Handler (passed to Player/Dashboard)**
    const handleCreateNotebook = (title) => {
        const newNb = {
            id: Date.now().toString(),
            title: title || "Untitled Notebook",
            updated: new Date().toISOString(),
            entries: []
        };
        setNotebooks(prev => [newNb, ...prev]);
        return newNb.id; // Return ID so the caller can use it immediately
    };

    // 2. Quiz Logic
    const handleStartQuiz = (mins, shuffle) => {
        if (!activeTest) return alert("Error: No test selected.");
        setQuizDuration(mins === '' ? 99999 : Number(mins));
        
        let testToPlay;
        try { testToPlay = JSON.parse(JSON.stringify(activeTest)); } 
        catch(e) { return alert("Failed to prepare test: " + e.message); }

        if (shuffle && testToPlay.questions?.length > 0) {
            for (let i = testToPlay.questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [testToPlay.questions[i], testToPlay.questions[j]] = [testToPlay.questions[j], testToPlay.questions[i]];
            }
        }
        setPlayingTest(testToPlay);
        setShowQuizSetup(false);
        setView('player');
    };

    // 3. Test Management
    const handleDirectRemix = (newTest) => {
        setTests(prev => [newTest, ...prev]);
        setActiveId(newTest.id);
        setView('editor');
        setTimeout(() => alert(`âš¡ Remix "${newTest.title}" Created & Opened!`), 100);
    };

    const importData = (newTests, newNotebooks = []) => {
        setTests(prev => [...newTests, ...prev]);
        setNotebooks(prev => [...newNotebooks, ...prev]);
    };

    // --- RENDER ---
    return (
        <div className="font-sans h-screen flex flex-col relative">
            {/* Warnings & Modals */}
            {storageWarning && <div className="bg-red-600 text-white px-4 py-2 text-sm font-bold flex justify-between items-center shadow-md shrink-0 z-50"><div className="flex items-center gap-2"><Icon name="AlertTriangle" className="w-5 h-5" /><span>STORAGE FULL! Export Backup & Delete old tests.</span></div></div>}
            
            {modal && <SettingsVault context={keyContext} setContext={setKeyContext} notes={userNotes} setNotes={setUserNotes} onClose={() => setModal(false)} />}
            
            {showQuizSetup && <QuizSetupModal onClose={() => setShowQuizSetup(false)} onStart={handleStartQuiz} />}
            
            {/* VIEW ROUTING */}

            {/* 1. DASHBOARD */}
            {view === 'dashboard' && (
                <Dashboard 
                    tests={tests} 
                    notebooks={notebooks} 
                    onCreateTest={() => { 
                        const n = { id: Date.now().toString(), title: 'Untitled Test', created: new Date().toISOString(), questions: [] }; 
                        setTests([n, ...tests]); 
                        setActiveId(n.id); 
                        setView('editor'); 
                    }} 
                    onCreateNotebook={() => { 
                        const id = handleCreateNotebook("New Analysis Notebook");
                        setActiveNotebookId(id); 
                        setView('notebook'); 
                    }} 
                    onDeleteTest={(e, id) => { e.stopPropagation(); if(confirm("Delete this test?")) setTests(tests.filter(t => t.id !== id)); }} 
                    onDeleteNotebook={(e, id) => { e.stopPropagation(); if(confirm("Delete this notebook?")) setNotebooks(notebooks.filter(n => n.id !== id)); }} 
                    onSelectTest={(id) => { setActiveId(id); setView('editor'); }} 
                    onSelectNotebook={(id) => { setActiveNotebookId(id); setView('notebook'); }} 
                    onSettings={() => setModal(true)} 
                    onImport={importData} 
                    appLogo={appLogo} 
                    setAppLogo={setAppLogo} 
                    onOpenOfficial={() => setView('official')}
                />
            )}

            {/* 2. EDITOR */}
            {view === 'editor' && activeTest && (
                <Editor 
                    test={activeTest} 
                    onUpdateTest={(u) => setTests(tests.map(t => t.id === activeId ? { ...t, ...u } : t))} 
                    onBack={() => {
                    // ðŸ‘» GHOST BUSTER: If we are leaving a Boss Draft, delete it!
                    if (activeTest && activeTest.isBossDraft) {
                        setTests(prev => prev.filter(t => t.id !== activeTest.id));
                    }
                    setView('dashboard');
                }}
                    onPlay={() => setShowQuizSetup(true)} 
                    onPrint={() => setView('print')} 
                    apiKey={keyContext} 
                    onRequestKey={() => setModal(true)} 
                    onRemix={handleDirectRemix} 
isBoss={isBoss}
                />
            )}

            {/* 3. NOTEBOOK ANALYSIS */}
            {view === 'notebook' && activeNotebook && (
                <AnalysisNotebook 
                    notebook={activeNotebook} 
                    onUpdate={handleUpdateNotebook} 
                    onBack={() => setView('dashboard')} 
                    apiKey={keyContext} 
                    onRequestKey={() => setModal(true)} 
                    onRemix={handleDirectRemix} 
tests={tests}
                />
            )}

            {/* 4. PLAYER (QUIZ TAKER) */}
            {view === 'player' && playingTest && (
                <Player 
                    test={playingTest} 
                    duration={quizDuration} 
                    onBack={() => setView(playingTest?.isOfficial ? 'official' : 'editor')}
                    notebooks={notebooks} 
                    onSaveToNotebook={handleSaveToNotebook}
                    onCreateNotebook={handleCreateNotebook} // <--- PASSING THE NEW HANDLER HERE
isBoss={isBoss}              // <--- PASS PROP
        onBossEdit={handleBossEdit}  // <--- PASS FUNCTION
                />
            )}
{/* 6. OFFICIAL EXAM HUB VIEW */}
{view === 'official' && (
    <OfficialExamHub 
        onBack={() => setView('dashboard')}
isBoss={isBoss}             // <--- PASS PROP
        setBossMode={setBossMode}   // <--- PASS PROP
        onStartTest={(testData, duration) => {
            setPlayingTest(testData);
            setQuizDuration(duration);
            setView('player');
        }}
    />
)}
            {/* 5. PRINT VIEW */}
            {view === 'print' && activeTest && (
                <PrintView 
                    test={activeTest} 
                    onBack={() => setView('editor')} 
                    apiKey={keyContext} 
                    onRequestKey={() => setModal(true)} 
                />
            )}
        </div>
    );
}; const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuizForge />);
    </script>
</body>
</html>



